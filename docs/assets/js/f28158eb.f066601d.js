"use strict";(self.webpackChunkkadena_docs=self.webpackChunkkadena_docs||[]).push([[2120],{34906:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>l,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"smart-contracts/databases","title":"Database model","description":"Kadena blockchain nodes store information in two different data stores, with a key-value store that keeps track of information about nodes, chains, and blocks and a SQL-based database that stores information about Pact smart contracts and transactions.","source":"@site/docs/smart-contracts/databases.md","sourceDirName":"smart-contracts","slug":"/smart-contracts/databases","permalink":"/docs/smart-contracts/databases","draft":false,"unlisted":false,"editUrl":"https://github.com/kda-community/kadena-docs-new/blob/master/docs/smart-contracts/databases.md","tags":[{"inline":true,"label":"pact","permalink":"/docs/tags/pact"},{"inline":true,"label":"beginner","permalink":"/docs/tags/beginner"},{"inline":true,"label":"schemas and tables","permalink":"/docs/tags/schemas-and-tables"},{"inline":true,"label":"schemas","permalink":"/docs/tags/schemas"},{"inline":true,"label":"tables","permalink":"/docs/tags/tables"},{"inline":true,"label":"pact tutorials","permalink":"/docs/tags/pact-tutorials"}],"version":"current","frontMatter":{"title":"Database model","description":"Kadena blockchain nodes store information in two different data stores, with a key-value store that keeps track of information about nodes, chains, and blocks and a SQL-based database that stores information about Pact smart contracts and transactions.","id":"databases","order":7,"tags":["pact","beginner","schemas and tables","schemas","tables","pact tutorials"]},"sidebar":"default","previous":{"title":"Guards","permalink":"/docs/smart-contracts/guards"},"next":{"title":"Transaction format and flow","permalink":"/docs/smart-contracts/transactions"}}');var s=n(74848),i=n(28453);const l={title:"Database model",description:"Kadena blockchain nodes store information in two different data stores, with a key-value store that keeps track of information about nodes, chains, and blocks and a SQL-based database that stores information about Pact smart contracts and transactions.",id:"databases",order:7,tags:["pact","beginner","schemas and tables","schemas","tables","pact tutorials"]},r="Database model",c={},o=[{value:"Working with Pact tables",id:"working-with-pact-tables",level:2},{value:"Data access model",id:"data-access-model",level:3},{value:"Null values aren&#39;t allowed",id:"null-values-arent-allowed",level:3},{value:"Versioned history",id:"versioned-history",level:3},{value:"Table creation",id:"table-creation",level:2},{value:"Table schemas",id:"table-schemas",level:2},{value:"Table definition",id:"table-definition",level:2},{value:"Create module tables",id:"create-module-tables",level:2},{value:"Insert",id:"insert",level:2},{value:"Read",id:"read",level:2},{value:"Update",id:"update",level:2},{value:"Select",id:"select",level:2},{value:"Select queries and performance",id:"select-queries-and-performance",level:3},{value:"Transactional and local execution",id:"transactional-and-local-execution",level:3},{value:"Keys",id:"keys",level:2},{value:"Row-level keysets",id:"row-level-keysets",level:2},{value:"Changing a table schema",id:"changing-a-table-schema",level:2},{value:"Identifying active and inactive rows",id:"identifying-active-and-inactive-rows",level:2}];function d(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"database-model",children:"Database model"})}),"\n",(0,s.jsx)(t.p,{children:"Kadena blockchain nodes store information in two different data stores.\nOn each Chainweb node, there's a RocksDB key-value store that keeps track of information about the peer network, chains, and blocks.\nEach node also hosts a set of SQLite database files that store information about Pact smart contracts and transaction results with one file for each chain in the network."}),"\n",(0,s.jsx)(t.p,{children:"The following diagram presents a simplified view of this separation of concerns."}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Data store overview",src:n(55480).A+"",width:"2672",height:"1560"})}),"\n",(0,s.jsx)(t.p,{children:"As a smart contract developer, you're primarily interested in writing to and reading from the Pact state, but it's helpful to know how data is organized and optimized for different execution modes and to perform different tasks.\nThe RocksDb database\u2014sometimes referred to as the chain database\u2014is optimized for efficient network communication and resiliency.\nPact database operations are optimized for transaction performance."}),"\n",(0,s.jsx)(t.h2,{id:"working-with-pact-tables",children:"Working with Pact tables"}),"\n",(0,s.jsx)(t.p,{children:"Tables are a core component of Pact smart contracts because they enable you to store, manipulate, and read data using familiar patterns.\nInteracting with Pact databases is much like interacting with any other type of database, but with constraints that reflect the unique requirements of blockchain execution.\nFor example, working with Pact databases is similar to working with other SQL-based databases, with similar database operations.\nThere are built-in functions to insert, read, and update values stored in tables."}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Function type"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Description"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.a,{href:"/pact-5/database/insert",children:"Insert"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Insert new rows into a table."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.a,{href:"/pact-5/database/read",children:"Read"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Read values from a table."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.a,{href:"/pact-5/database/update",children:"Update"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Update values for a column that contains data in a table."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:(0,s.jsx)(t.a,{href:"/pact-5/database/write",children:"Write"})}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Write values for a column in a table, regardless of whether the column contains data or not."})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Delete"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Not available in Pact."})]})]})]}),"\n",(0,s.jsxs)(t.p,{children:["If you've worked with other databases or programming languages, you should be familiar with similar functions that enable you to create, read, update, and delete (CRUD) information.\nHowever, in Pact, you use the ",(0,s.jsx)(t.code,{children:"insert"})," function in place of the create functionality to add rows to a table and there isn't a function to delete rows from a table."]}),"\n",(0,s.jsxs)(t.p,{children:["Although Pact doesn't provide a delete function, you can use an ",(0,s.jsx)(t.code,{children:"active"})," column in tables to mark table rows as active or inactive.\nFor more information about using an active column to indicate active and inactive rows, see ",(0,s.jsx)(t.a,{href:"#identifying-active-and-inactive-rows",children:"Identifying active and inactive rows"}),"."]}),"\n",(0,s.jsx)(t.h3,{id:"data-access-model",children:"Data access model"}),"\n",(0,s.jsxs)(t.p,{children:["Most smart contracts use one or more tables to store all of the information required for the application or service that the smart contract provides.\nYou access the information stored in Pact tables by using the table's ",(0,s.jsx)(t.em,{children:"key-row"})," structure.\nThis access model is similar to using a primary key to access table data in other relational databases."]}),"\n",(0,s.jsxs)(t.p,{children:["With the Pact ",(0,s.jsx)(t.em,{children:"key-row"})," model, you access a row of column values by using a single key.\nAs a result of this access model, Pact doesn't support ",(0,s.jsx)(t.em,{children:"joining"})," tables in a way that an online analytical processing database would support if populated from data exported from the Pact database.\nHowever, Pact can record transactions using relational techniques.\nFor example, if you have a ",(0,s.jsx)(t.code,{children:"Customer"})," table with keys used in a ",(0,s.jsx)(t.code,{children:"Sales"})," table, a Pact smart contract could include code to look up the ",(0,s.jsx)(t.code,{children:"Customer"})," record before writing to the ",(0,s.jsx)(t.code,{children:"Sales"})," table."]}),"\n",(0,s.jsx)(t.h3,{id:"null-values-arent-allowed",children:"Null values aren't allowed"}),"\n",(0,s.jsxs)(t.p,{children:["The Pact database model doesn't support NULL values as a safety feature to ensure ",(0,s.jsx)(t.em,{children:"totality"})," for transactions and to avoid unsafe control-flow for handling null values.\nThe main function for working with database results is the ",(0,s.jsx)(t.a,{href:"/pact-5/database/with-read",children:"with-read"})," function.\nThis function will return an error if any column value it attempts to read isn't found.\nTo prevent transactions from failing with these errors, you should ensure that there are values in the columns you attempt to read in a transaction."]}),"\n",(0,s.jsx)(t.h3,{id:"versioned-history",children:"Versioned history"}),"\n",(0,s.jsxs)(t.p,{children:["The key-row model is augmented by every change to column values being versioned by a transaction identifier.\nFor example, if you have a table with columns for ",(0,s.jsx)(t.code,{children:"name"}),", ",(0,s.jsx)(t.code,{children:"age"}),", and ",(0,s.jsx)(t.code,{children:"role"}),", you might update the ",(0,s.jsx)(t.code,{children:"name"})," column in a transaction with the identifier 100, and later update the ",(0,s.jsx)(t.code,{children:"age"})," and ",(0,s.jsx)(t.code,{children:"role"})," columns in a transaction identified as 102.\nIf you retrieve historical data for the table, only the change to the ",(0,s.jsx)(t.code,{children:"name"})," column is returned for transaction identifier 100 and only the change to ",(0,s.jsx)(t.code,{children:"age"})," and ",(0,s.jsx)(t.code,{children:"role"})," columns are returned for transaction 102."]}),"\n",(0,s.jsx)(t.h2,{id:"table-creation",children:"Table creation"}),"\n",(0,s.jsxs)(t.p,{children:["Tables are defined by ",(0,s.jsx)(t.strong,{children:"schemas"})," in module declarations.\nThe schema defines the table columns, field values, and field types.\nThe module declaration also specifies the table name to associate with each schema you define.\nThere's no restriction on the number of tables you can create."]}),"\n",(0,s.jsxs)(t.p,{children:["The tables specified in the module declaration are ",(0,s.jsx)(t.a,{href:"/pact-5/database/create-table",children:"created"})," after the module declaration, and the table name is prepended with the module name, so that the module becomes the table owner."]}),"\n",(0,s.jsx)(t.p,{children:"It\u2019s important to note this distinction between when tables are defined and when tables are created.\nYou define table schemas, the table associated with each schema, and the functions that insert, read, and modify database records inside of module code. You create the tables outside of module code.\nThe module acts as a guard to protect access to database functions and database records.\nThis separation also allows module code to be updated without necessarily recreating the table in Pact state."}),"\n",(0,s.jsx)(t.h2,{id:"table-schemas",children:"Table schemas"}),"\n",(0,s.jsxs)(t.p,{children:["Before you create a table in Pact, you must define its schema.\nThe schema describes the structure of the table by specifying the columns and data types for the values to be stored in the table.\nSchemas are defined within the Pact module declarations by using the ",(0,s.jsx)(t.a,{href:"/reference/syntax#defschema",children:"defschema"})," keyword and consist of a\nseries of ",(0,s.jsx)(t.strong,{children:"field names"})," and ",(0,s.jsx)(t.strong,{children:"field types"}),"."]}),"\n",(0,s.jsx)(t.p,{children:"Each field name specifies a column in the table, and each field type specifies the type of data held in that field."}),"\n",(0,s.jsxs)(t.p,{children:["In the following example, the ",(0,s.jsx)(t.strong,{children:"accounts"})," table has three columns with the field names  ",(0,s.jsx)(t.strong,{children:"balance"}),", ",(0,s.jsx)(t.strong,{children:"amount"}),", and ",(0,s.jsx)(t.strong,{children:"currency"}),":"]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Field name"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"Field type"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"balance"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"decimal"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"amount"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"decimal"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"currency"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"string"})]})]})]}),"\n",(0,s.jsxs)(t.p,{children:["In this example, the ",(0,s.jsx)(t.strong,{children:"balance"})," and ",(0,s.jsx)(t.strong,{children:"amount"})," columns require ",(0,s.jsx)(t.code,{children:"decimal"})," as the data type and the currency column requires data to be a ",(0,s.jsx)(t.code,{children:"string"})," value.\nYou can create the schema for this table in Pact like this:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:'(defschema accounts\n  "Schema for accounts table."\n  balance:decimal\n  amount:decimal\n  currency:string\n)\n'})}),"\n",(0,s.jsx)(t.p,{children:"All table schemas you create look similar to this example, but with different field names and data types.\nField names must start with a valid alphabetic character, but can contain alphabetic, numeric, and special characters.\nIn general, you should use field names that are short but recognizable.\nFor each field, the field type must be one the data types that Pact supports."}),"\n",(0,s.jsx)(t.p,{children:"Types that are declared in code are enforced at runtime when expressions are evaluated.\nFor tables, any write to a table is type-checked against the table schema to ensure the data matches the expected type.\nExecution fails if type checking fails."}),"\n",(0,s.jsxs)(t.p,{children:["For information about the data types that Pact supports, see ",(0,s.jsx)(t.a,{href:"/smart-contracts/lang-features#data-types",children:"Data types"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"table-definition",children:"Table definition"}),"\n",(0,s.jsxs)(t.p,{children:["In Pact, tables are defined inside of the module declaration by using the ",(0,s.jsx)(t.code,{children:"deftable"})," keyword.\nThe table definition accomplishes two goals:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"It associates a table name with a specific table schema of columns and data types."}),"\n",(0,s.jsx)(t.li,{children:"It defines the table inside of the module namespace."}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["There's no limit to the number of tables you can define in a module.\nBecause the table is defined inside of a module, direct access to the table using database functions is only authorized for the module owner, that is, its administrative keyset or governance capability.\nHowever, module functions have unrestricted access to the table by default.\nWith this default behavior, the module acts as the main entry point for all user interaction.\nYou can restrict access to tables inside of the module by using ",(0,s.jsx)(t.a,{href:"#row-level-keysets",children:"row-level keysets"})," and enforcing the keyset guard for specific functions."]}),"\n",(0,s.jsxs)(t.p,{children:["The following example illustrates using the deftable keyword to define an ",(0,s.jsx)(t.strong,{children:"accounts-table"})," table that uses the ",(0,s.jsx)(t.strong,{children:"accounts"})," schema:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:"(deftable accounts-table:{accounts})\n"})}),"\n",(0,s.jsxs)(t.p,{children:["Notice that the table and schema are represented as a pair, separated by a colon (",(0,s.jsx)(t.code,{children:":"}),").\nThe curly braces (",(0,s.jsx)(t.code,{children:"{ }"}),") around the schema name are there because the schema is an object."]}),"\n",(0,s.jsx)(t.p,{children:"The schema name and table name must be different from one another.\nIn general, you should use table and schema names that are similar to each other or follow a consistent convention to avoid confusion:\nFor example:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:"(deftable cat-table:{cats})\n(deftable asset-tracker:{assets})\n"})}),"\n",(0,s.jsx)(t.h2,{id:"create-module-tables",children:"Create module tables"}),"\n",(0,s.jsx)(t.p,{children:"After you have defined all of the tables for your module inside of the module declaration, you can create those tables outside of the module.\nCreating the table outside of the module ensures that other parts of the module logic can be redefined or updated without recreating the table."}),"\n",(0,s.jsxs)(t.p,{children:["You can created tables after the module declaration by using the ",(0,s.jsx)(t.a,{href:"/pact-5/database/create-table",children:"create-table"})," function followed by the table name as it's defined in the module declaration.\nFor example:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:"(create-table accounts-table)\n(create-table cat-table)\n(create-table asset-tracker)\n"})}),"\n",(0,s.jsx)(t.h2,{id:"insert",children:"Insert"}),"\n",(0,s.jsxs)(t.p,{children:["You can use the ",(0,s.jsx)(t.a,{href:"/pact-5/database/insert",children:"insert"})," function to add new data to a table.\nYou can use ",(0,s.jsx)(t.code,{children:"insert"})," function to add any type of new artifact with a key value.\nFor example, you can use a key value to add a row of data about accounts, customers, loans, or assets."]}),"\n",(0,s.jsxs)(t.p,{children:["The following example illustrates adding a row to the ",(0,s.jsx)(t.code,{children:"accounts-table"})," using the ",(0,s.jsx)(t.code,{children:"insert"}),' function with the key value\n"account-1".']}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:'(insert accounts-table \u201caccount-1\u201d { "balance": 12.3, "amount": 0.0, "currency":"USD"})\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Note that the key must be a string value.\nThis example adds the following row to the ",(0,s.jsx)(t.code,{children:"accounts-table"}),":"]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"key"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"balance"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"amount"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"currency"})]})}),(0,s.jsx)(t.tbody,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"account-1"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"12.3"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"0.0"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"USD"})]})})]}),"\n",(0,s.jsxs)(t.p,{children:["You can also use the ",(0,s.jsx)(t.code,{children:"insert"})," function inside of another function to add new data to rows in a table from the input values for the function.\nFor example:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:'(defun create-account (id balance amount currency)\n  (insert accounts-table id\n       { "balance": balance,\n         "amount" : amount,\n         "currency": currency })\n)\n'})}),"\n",(0,s.jsxs)(t.p,{children:["In this example, the row inserted into the ",(0,s.jsx)(t.code,{children:"accounts-table"})," takes the values entered for the ",(0,s.jsx)(t.code,{children:"create-account"})," function."]}),"\n",(0,s.jsx)(t.h2,{id:"read",children:"Read"}),"\n",(0,s.jsxs)(t.p,{children:["You can use the ",(0,s.jsx)(t.a,{href:"/pact-5/database/read",children:"read"})," function to read a row of data from a specified table for a specified key value."]}),"\n",(0,s.jsxs)(t.p,{children:["In the following example, the ",(0,s.jsx)(t.code,{children:"accounts-table"})," has two rows of data storing the account balance and currency for ",(0,s.jsx)(t.strong,{children:"account-1"})," and ",(0,s.jsx)(t.strong,{children:"account-2"}),":"]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"key"}),(0,s.jsx)(t.th,{children:"balance"}),(0,s.jsx)(t.th,{children:"currency"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"account-1"}),(0,s.jsx)(t.td,{children:"4.00"}),(0,s.jsx)(t.td,{children:"USD"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"account-2"}),(0,s.jsx)(t.td,{children:"3.00"}),(0,s.jsx)(t.td,{children:"USD"})]})]})]}),"\n",(0,s.jsxs)(t.p,{children:["You can use the ",(0,s.jsx)(t.code,{children:"read"})," function to retrieve the information for the key value.\nFor example, you can get the ",(0,s.jsx)(t.code,{children:"balance"})," and ",(0,s.jsx)(t.code,{children:"currency"})," information for ",(0,s.jsx)(t.code,{children:"account-1"})," like this:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:"(read accounts-table account-1 ['balance 'ccy])\n"})}),"\n",(0,s.jsxs)(t.p,{children:["You can also use the ",(0,s.jsx)(t.code,{children:"read"})," function inside of another function like this."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:"(defun read-accounts (1)\n  (read accounts id [\u2018balance \u2018ccy])\n)\n"})}),"\n",(0,s.jsxs)(t.p,{children:["In each example, the ",(0,s.jsx)(t.code,{children:"read"})," functions returns the following values:"]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"balance"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"currency"})]})}),(0,s.jsx)(t.tbody,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"4.00"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"USD"})]})})]}),"\n",(0,s.jsx)(t.h2,{id:"update",children:"Update"}),"\n",(0,s.jsxs)(t.p,{children:["You can use the ",(0,s.jsx)(t.a,{href:"/pact-5/database/update",children:"update"})," function to update one or more values in an existing row of a table.\nUpdates enable you to change the status of a column or amend the initial dataset to record a new value."]}),"\n",(0,s.jsxs)(t.p,{children:["With the ",(0,s.jsx)(t.code,{children:"update"})," function, you specify the key for the row you want to update, the field you want to update, and the new value for the field in that that row.\nIn most cases, you use ",(0,s.jsx)(t.code,{children:"update"})," functions in other functions to allow users to input new values."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:'(update table-name id {"field": new-value})\n'})}),"\n",(0,s.jsxs)(t.p,{children:["The following example illustrates updating the ",(0,s.jsx)(t.code,{children:"status"})," field for an asset in the ",(0,s.jsx)(t.code,{children:"assets-table"}),".\nBefore updating the  ",(0,s.jsx)(t.code,{children:"assetPrice"}),", the  ",(0,s.jsx)(t.code,{children:"assets-table"})," has the following fields and values."]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"assetID"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"assetName"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"assetPrice"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"status"})]})}),(0,s.jsx)(t.tbody,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"asset-1"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"My Asset"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"5.0"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"todo"})]})})]}),"\n",(0,s.jsxs)(t.p,{children:["For this example, the ",(0,s.jsx)(t.code,{children:"asset-update"})," function updates the ",(0,s.jsx)(t.code,{children:"status"})," column, then reads the value of the updated column."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:'(defun asset-update (assetId:string new-status:string)\n  (update assets-table assetId {\n    "status": new-status\n  })\n  (read asset-table assetId)\n)\n'})}),"\n",(0,s.jsx)(t.h2,{id:"select",children:"Select"}),"\n",(0,s.jsxs)(t.p,{children:["You can use the ",(0,s.jsx)(t.a,{href:"/pact-5/database/select",children:"select"})," function to select values from one or more rows in a table.\nThe ",(0,s.jsx)(t.code,{children:"select"})," function is similar to the ",(0,s.jsx)(t.code,{children:"read"})," function except that the ",(0,s.jsx)(t.code,{children:"read"})," function retrieves information for a single key-row value.\nThe ",(0,s.jsx)(t.code,{children:"select"})," function enables you to retrieve multiple rows from a table based on the criteria you provide.\nBecause you can specify other criteria and not just a single key-row value, the ",(0,s.jsx)(t.code,{children:"select"})," function provides you with more flexibility in what information you choose to return."]}),"\n",(0,s.jsxs)(t.p,{children:["The syntax for the Pact ",(0,s.jsx)(t.code,{children:"select"})," function is similar to the syntax for standard SQL ",(0,s.jsx)(t.code,{children:"SELECT"})," statements.\nIn its simplest form, the ",(0,s.jsx)(t.code,{children:"select"})," statement retrieves all values from a specified table.\nIn the following example, the ",(0,s.jsx)(t.code,{children:"select"})," statement is used in a ",(0,s.jsx)(t.code,{children:"select-assets"})," function to return all values from the ",(0,s.jsx)(t.code,{children:"assets-table"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:"  (defun select-assets ()\n    (select assets-table (constantly true))\n  )\n"})}),"\n",(0,s.jsxs)(t.p,{children:["This query returns all of the values currently stored in the ",(0,s.jsx)(t.code,{children:"assets-table"})," fields.\nFor example:"]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"assetId"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"assetName"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"assetPrice"}),(0,s.jsx)(t.th,{style:{textAlign:"left"},children:"status"})]})}),(0,s.jsxs)(t.tbody,{children:[(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"asset-1"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"My Asset"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"5.0"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"todo"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"asset-2"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Asset 2"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"6.0"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"in progress"})]}),(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"asset-3"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"Asset 3"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"7.0"}),(0,s.jsx)(t.td,{style:{textAlign:"left"},children:"done"})]})]})]}),"\n",(0,s.jsxs)(t.p,{children:["Like standard SQL ",(0,s.jsx)(t.code,{children:"SELECT"})," statements, you can use a ",(0,s.jsx)(t.code,{children:"where"})," clause to refine your results.\nFor example, you can return only the ",(0,s.jsx)(t.code,{children:"assetName"})," and ",(0,s.jsx)(t.code,{children:"assetPrice"})," for a specific asset name like this:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:"  (select assets-table ['assetName,'assetPrice] (where 'assetName (= \"Asset 2\")))\n"})}),"\n",(0,s.jsxs)(t.p,{children:["This query returns the following values from the sample ",(0,s.jsx)(t.code,{children:"assets-table"}),":"]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"assetName"}),(0,s.jsx)(t.th,{children:"assetPrice"})]})}),(0,s.jsx)(t.tbody,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"Asset 2"}),(0,s.jsx)(t.td,{children:"6.0"})]})})]}),"\n",(0,s.jsxs)(t.p,{children:["You can also specify operators\u2014such as greater than (",(0,s.jsx)(t.code,{children:">"}),") or less than (",(0,s.jsx)(t.code,{children:"<"}),")\u2014from within the ",(0,s.jsx)(t.code,{children:"where"})," clause.\nFor example:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:"  (select assets-table (where 'assetPrice (> 6.0)))\n"})}),"\n",(0,s.jsxs)(t.p,{children:["This query returns the following values from the sample ",(0,s.jsx)(t.code,{children:"assets-table"}),":"]}),"\n",(0,s.jsxs)(t.table,{children:[(0,s.jsx)(t.thead,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.th,{children:"key"}),(0,s.jsx)(t.th,{children:"assetName"}),(0,s.jsx)(t.th,{children:"assetPrice"}),(0,s.jsx)(t.th,{children:"status"})]})}),(0,s.jsx)(t.tbody,{children:(0,s.jsxs)(t.tr,{children:[(0,s.jsx)(t.td,{children:"asset-3"}),(0,s.jsx)(t.td,{children:"Asset 3"}),(0,s.jsx)(t.td,{children:"7.0"}),(0,s.jsx)(t.td,{children:"done"})]})})]}),"\n",(0,s.jsx)(t.h3,{id:"select-queries-and-performance",children:"Select queries and performance"}),"\n",(0,s.jsxs)(t.p,{children:["You should note that when you write queries using the Pact ",(0,s.jsx)(t.code,{children:"select"})," function, the ",(0,s.jsx)(t.code,{children:"select"})," and ",(0,s.jsx)(t.code,{children:"where"})," operations provide a streaming interface that applies filters to the specified table, then operates on the row set as a list data structure using ",(0,s.jsx)(t.a,{href:"/pact-5/general/sort",children:"sort"})," and other functions.\nBecause of the computational overhead, you should avoid using ",(0,s.jsx)(t.code,{children:"select"})," statements to work with on-chain data."]}),"\n",(0,s.jsxs)(t.p,{children:["Although it can be convenient to use select statements to retrieve data, you can often return the same results more efficiently using other functions.\nFor example, the following query selects ",(0,s.jsx)(t.code,{children:"Programmers"})," with salaries >= 90000 and sorts by ",(0,s.jsx)(t.code,{children:"age"})," in descending order:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:"(reverse (sort ['age]\n  (select 'employees ['first-name,'last-name,'age]\n    (and? (where 'title (= \"Programmer\"))\n          (where 'salary (<= 90000))))))\n"})}),"\n",(0,s.jsxs)(t.p,{children:["You can write the same query using the ",(0,s.jsx)(t.code,{children:"filter"})," function and sorting the resulting list like this:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:"(reverse (sort ['age]\n  (filter (and? (where 'title (= \"Programmer\"))\n                (where 'salary (< 90000)))\n          employees))\n)\n"})}),"\n",(0,s.jsxs)(t.p,{children:["For performance reasons, Pact database interactions are optimized for single-row reads and writes.\nQueries that use the ",(0,s.jsx)(t.code,{children:"select"})," statement to scan multiple rows in a table can be slow and prohibitively expensive computationally.\nTherefore, the best practice is to use ",(0,s.jsx)(t.code,{children:"select"})," statements in local, non-transactional operations and to avoid using ",(0,s.jsx)(t.code,{children:"select"})," on large tables in functions that perform transactional operations."]}),"\n",(0,s.jsx)(t.h3,{id:"transactional-and-local-execution",children:"Transactional and local execution"}),"\n",(0,s.jsxs)(t.p,{children:["Pact doesn't distinguish between transactional and local execution.\nHowever, transactions typically involve business events that must be executed and recorded in a timely fashion.\nQueries rarely represent a business event, and can often involve data payloads that could impact performance.\nThe best practice is to query data locally on a node by using the ",(0,s.jsx)(t.code,{children:"/local"})," endpoint.\nYou can also query historical data using the ",(0,s.jsx)(t.code,{children:"/local"})," endpoint and a ",(0,s.jsx)(t.em,{children:"transaction identifier"})," as a point of reference."]}),"\n",(0,s.jsxs)(t.p,{children:["For transactions, you should use the ",(0,s.jsx)(t.code,{children:"/send"})," endpoint."]}),"\n",(0,s.jsxs)(t.p,{children:["For more information about transaction execution, see ",(0,s.jsx)(t.a,{href:"/smart-contracts/transactions",children:"Transaction lifecycle"}),".\nFor more information about Pact endpoints, see ",(0,s.jsx)(t.a,{href:"/api/pact-api",children:"Pact API"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"keys",children:"Keys"}),"\n",(0,s.jsxs)(t.p,{children:["You can use the ",(0,s.jsx)(t.a,{href:"/pact-5/database/keys",children:"keys"})," function from within a module to return all of the ",(0,s.jsx)(t.strong,{children:"key"})," values in a table.\nFor example, you can return the ",(0,s.jsx)(t.code,{children:"key"})," values for the sample ",(0,s.jsx)(t.code,{children:"assets-table"})," with the following code:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:"(module asset-manager ADMIN\n  (defcap ADMIN () true)\n\n  (defschema assets\n     assetId:string\n     assetName:string\n     assetPrice:decimal\n     status:string\n  )\n\n  (deftable assets-table:{assets})\n  ...\n\n  (keys assets-table)\n)\n"})}),"\n",(0,s.jsxs)(t.p,{children:["You can also use the ",(0,s.jsx)(t.code,{children:"keys"})," function within another function.\nFor example:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:"  (defun get-keys (table-name)\n    (keys table-name)\n  )\n"})}),"\n",(0,s.jsx)(t.h2,{id:"row-level-keysets",children:"Row-level keysets"}),"\n",(0,s.jsx)(t.p,{children:"Keysets can be stored as a column value in a row, allowing for row-level authorization. The following code indicates how this might be achieved:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:'(defun create-account (id)\n  (insert accounts-table id { "balance": 0.0, "keyset": (read-keyset "owner-keyset") }))\n\n(defun read-balance (id)\n  (with-read accounts-table id { "balance":= bal, "keyset":= ks }\n    (enforce-keyset ks)\n    (format "Your balance is {}" [bal])))\n'})}),"\n",(0,s.jsxs)(t.p,{children:["In this example, the ",(0,s.jsx)(t.code,{children:"create-account"})," function reads the ",(0,s.jsx)(t.code,{children:"owner-keyset"})," definition from the message payload using ",(0,s.jsx)(t.code,{children:"read-keyset"}),", then stores it in the ",(0,s.jsx)(t.code,{children:"keyset"})," column in the ",(0,s.jsx)(t.code,{children:"accounts-table"})," table.\nThe ",(0,s.jsx)(t.code,{children:"read-balance"})," function only allows the ",(0,s.jsx)(t.code,{children:"owner-keyset"})," to read the balance by first enforcing the keyset using ",(0,s.jsx)(t.code,{children:"enforce-keyset"})," function."]}),"\n",(0,s.jsx)(t.h2,{id:"changing-a-table-schema",children:"Changing a table schema"}),"\n",(0,s.jsxs)(t.p,{children:["As noted in ",(0,s.jsx)(t.a,{href:"#create-module-tables",children:"Create module tables"}),", you can update contract functions without updating or recreating database tables.\nHowever, you can't modify the table schema when you update a contract.\nIn general, Pact doesn't support database migration or schema and table upgrades.\nTo update a database, you must declare new tables and define any data migration functions as part of a module load step for the new module that contains the modified table schema."]}),"\n",(0,s.jsx)(t.p,{children:"To update a table schema:"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Create a new module and declare the new table schema."}),"\n",(0,s.jsx)(t.li,{children:"Add functions to read rows from the old table and write them to the new table."}),"\n",(0,s.jsx)(t.li,{children:"Deploy the updated module with the new table schema on the network."}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"The original table and database state remain unchanged on the blockchain, but won't receive any new information after you deploy the new module."}),"\n",(0,s.jsx)(t.h2,{id:"identifying-active-and-inactive-rows",children:"Identifying active and inactive rows"}),"\n",(0,s.jsx)(t.p,{children:"Pact doesn't provide a delete function because of the potential issues with performance, data integrity, and data migration that row-level delete operations can introduce.\nIn addition, being able to delete rows or tables violates one of the most important properties of a blockchain environment: that it provides an immutable record of state."}),"\n",(0,s.jsxs)(t.p,{children:["Because deleting information from tables could also cause problems for replaying transactions or synchronizing nodes and leave the chain in an unhealthy state, Pact doesn't support deleting rows or tables.\nHowever, you can use an ",(0,s.jsx)(t.code,{children:"active"})," column in tables to identify active table rows on insert, then later flag rows with obsolete information as inactive.\nInactive rows remain in the database, but you can write logic to prevent them from being updated or retrieved."]}),"\n",(0,s.jsxs)(t.p,{children:["For example, you might define the ",(0,s.jsx)(t.code,{children:"user"})," schema and ",(0,s.jsx)(t.code,{children:"users-table"})," like this:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:"   (defschema user\n       nickname:string\n       keyset:guard\n       active:bool\n   )\n\n   (deftable users-table:{user})\n"})}),"\n",(0,s.jsxs)(t.p,{children:["To add new users to the table, you might define a ",(0,s.jsx)(t.code,{children:"create-user"})," function similar to the following:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:'   (defun create-user (id:string nickname:string keyset:guard active:bool)\n      (enforce-keyset "free.operate-admin")\n      (insert users-table id {\n          "keyset": keyset,\n          "nickname": nickname,\n          "active": true\n        }\n      )\n    )\n'})}),"\n",(0,s.jsxs)(t.p,{children:["You can then define a separate function to identify rows\u2014using the ",(0,s.jsx)(t.code,{children:"id"})," key-row\u2014that are no longer active similar to the following:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:'\n    (defun tombstone:string (id:string)\n       "Mark the specified row as inactive"\n       (update users-table id { "active" : false })\n    )\n'})}),"\n",(0,s.jsxs)(t.p,{children:["You can then check whether the ",(0,s.jsx)(t.code,{children:"active"})," column is ",(0,s.jsx)(t.code,{children:"true"})," or ",(0,s.jsx)(t.code,{children:"false"})," for a specific row before allowing the row to be updated with code similar to the following:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:'   (defun change-nickname (id:string new-name:string)\n      (with-read users-table id {"active" := active}\n        (if (= active true)\n          (update users-table id { "nickname": new-name })\n          (format "Update NOT ALLOWED for user {}" [id])))\n    )\n'})}),"\n",(0,s.jsxs)(t.p,{children:["For example, you can set the ",(0,s.jsx)(t.code,{children:"active"})," column to ",(0,s.jsx)(t.code,{children:"false"})," for the row identified by ",(0,s.jsx)(t.code,{children:"tai"})," with a call similar to this:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:'(tombstone "tai")\n"Write succeeded"\n'})}),"\n",(0,s.jsxs)(t.p,{children:["If you then attempt to update the ",(0,s.jsx)(t.code,{children:"nickname"})," column for the ",(0,s.jsx)(t.code,{children:"tai"})," row, you'll see the message that the change isn't allowed:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-pact",children:'(change-nickname "tai" "INACTIVE USER Tai\'s Nickname")\n"Update NOT ALLOWED for user tai"\n'})})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},55480:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/docs-database-model-82b28db3035befa34f202504fdd33f99.png"},28453:(e,t,n)=>{n.d(t,{R:()=>l,x:()=>r});var a=n(96540);const s={},i=a.createContext(s);function l(e){const t=a.useContext(i);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),a.createElement(i.Provider,{value:t},e.children)}}}]);
"use strict";(self.webpackChunkkadena_docs=self.webpackChunkkadena_docs||[]).push([[3063],{93745:(e,a,i)=>{i.r(a),i.d(a,{assets:()=>o,contentTitle:()=>r,default:()=>h,frontMatter:()=>c,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"smart-contracts/capabilities","title":"Capabilities","description":"Capabilities are the primary means by which you can grant granular permissions to perform tasks for which you wan to control access.","source":"@site/docs/smart-contracts/capabilities.md","sourceDirName":"smart-contracts","slug":"/smart-contracts/capabilities","permalink":"/docs/smart-contracts/capabilities","draft":false,"unlisted":false,"editUrl":"https://github.com/kda-community/kadena-docs-new/blob/master/docs/smart-contracts/capabilities.md","tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"title":"Capabilities","description":"Capabilities are the primary means by which you can grant granular permissions to perform tasks for which you wan to control access.","id":"capabilities","sidebar_position":8},"sidebar":"default","previous":{"title":"Modules and interfaces","permalink":"/docs/smart-contracts/modules"},"next":{"title":"Guards","permalink":"/docs/smart-contracts/guards"}}');var t=i(74848),s=i(28453);const c={title:"Capabilities",description:"Capabilities are the primary means by which you can grant granular permissions to perform tasks for which you wan to control access.",id:"capabilities",sidebar_position:8},r="Capabilities",o={},l=[{value:"Permissions, resources, and events",id:"permissions-resources-and-events",level:2},{value:"Expressing basic capabilities",id:"expressing-basic-capabilities",level:2},{value:"Evaluating and granting permissions",id:"evaluating-and-granting-permissions",level:3},{value:"Requiring a capability",id:"requiring-a-capability",level:3},{value:"Composing capabilities",id:"composing-capabilities",level:3},{value:"Calling basic capabilities",id:"calling-basic-capabilities",level:2},{value:"Top-level scope",id:"top-level-scope",level:3},{value:"Module scope",id:"module-scope",level:3},{value:"Acquire a capability inside of a module",id:"acquire-a-capability-inside-of-a-module",level:3},{value:"Acquire a capability outside of a module",id:"acquire-a-capability-outside-of-a-module",level:3},{value:"Managed capabilities",id:"managed-capabilities",level:2},{value:"Using management functions",id:"using-management-functions",level:3},{value:"Single-use managed capabilities",id:"single-use-managed-capabilities",level:3},{value:"Scoped signatures and verifiers",id:"scoped-signatures-and-verifiers",level:2},{value:"Events",id:"events",level:2}];function d(e){const a={a:"a",br:"br",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(a.header,{children:(0,t.jsx)(a.h1,{id:"capabilities",children:"Capabilities"})}),"\n",(0,t.jsxs)(a.p,{children:["At a high level, Pact ",(0,t.jsx)(a.strong,{children:"capabilities"})," are a straightforward ",(0,t.jsx)(a.strong,{children:"access control model"})," for smart contracts.\nWith capabilities, you can define specific conditions to authorize specific actions for specific users.\nCapabilities provide an explicit and transparent way to protect privileged operations, enforce rules before allowing transactions to execute, and ensure smart contract users authorize actions that are performed on their behalf."]}),"\n",(0,t.jsx)(a.p,{children:"Because capabilities are a core feature in the Pact smart contract programming language and powerful in how they enable you to manage permissions and resources, it's important to understand what they are, how they work, and how to define them correctly to achieve intended results."}),"\n",(0,t.jsx)(a.h2,{id:"permissions-resources-and-events",children:"Permissions, resources, and events"}),"\n",(0,t.jsx)(a.p,{children:"Before getting into the details of how capabilities are defined, you should consider that there are three distinct\u2014but related\u2014use cases for capabilities.\nYou can define capabilities to do the following:"}),"\n",(0,t.jsxs)(a.ul,{children:["\n",(0,t.jsx)(a.li,{children:"Authorize access to a specific privileged operation."}),"\n",(0,t.jsx)(a.li,{children:"Manage updates for a specific protected resource."}),"\n",(0,t.jsx)(a.li,{children:"Report events from operations executed in a transaction."}),"\n"]}),"\n",(0,t.jsx)(a.p,{children:"In the most common use case, you define capabilities to manage permissions by enforcing one or more conditions.\nIn combination with guards, these permission-driven capabilities act as gatekeepers to grant access to smart contract functions if the user or contract that controls the guard allows the operation to continue.\nIn general, capabilities protect privileged operations\u2014such as coin.transfer operations\u2014that users must authorize by signing the transaction with their keys or verify in some other way.\nHowever, as a contract author, you can define capabilities verify other conditions\u2014such as the account balance or how long it's been since the last transfer operation\u2014before granting the permission requested.\nIf the permission isn't granted, the code where the capability is called won't be executed."}),"\n",(0,t.jsxs)(a.p,{children:["You can think of the capabilities that are used to manage permissions as ",(0,t.jsx)(a.strong,{children:"basic capabilities"}),".\nFor more information about defining, acquiring, and scoping basic capabilities, see ",(0,t.jsx)(a.a,{href:"#expressing-basic-capabilities",children:"Expressing basic capabilities"})]}),"\n",(0,t.jsxs)(a.p,{children:["In addition to permissions, you can use capabilities to manage values for specified resources.\nCapabilities that manage resources are called ",(0,t.jsx)(a.strong,{children:"managed capabilities"}),".\nManaged capabilities have slightly different properties enable users or other contracts to set and update the value for a specified parameter.\nAs a contract author, you can define managed capabilities to allow ",(0,t.jsx)(a.strong,{children:"contract users"})," to manage a resource value, for example, to set a limit on the amount that can be transferred in a given transaction or to define the maximum supply of a resource.\nFor more information about defining and using managed capabilities, see ",(0,t.jsx)(a.a,{href:"#managed-capabilities",children:"Managed capabilities"}),"."]}),"\n",(0,t.jsxs)(a.p,{children:["Capabilities can also emit events in transaction results.\nFor more information about using capabilities to emit events, see ",(0,t.jsx)(a.a,{href:"#events",children:"Events"}),"."]}),"\n",(0,t.jsx)(a.h2,{id:"expressing-basic-capabilities",children:"Expressing basic capabilities"}),"\n",(0,t.jsxs)(a.p,{children:["Basic capabilities enable you to manage permissions by specifying the conditions that allow access to a particular resource or contract function.\nTherefore, in most cases, you define capabilities inside of the same module declaration as the functions that should use them.\nWithin the module declaration, you define capabilities by specifying the ",(0,t.jsx)(a.code,{children:"defcap"})," reserved keyword and providing the following information:"]}),"\n",(0,t.jsxs)(a.ul,{children:["\n",(0,t.jsxs)(a.li,{children:["A capability ",(0,t.jsx)(a.em,{children:"name"})," that describes the permission to be acquired or the operation to be protected."]}),"\n",(0,t.jsxs)(a.li,{children:["Optional ",(0,t.jsx)(a.em,{children:"parameters"})," that specify input arguments, properties, or conditions for the capability."]}),"\n",(0,t.jsxs)(a.li,{children:["A ",(0,t.jsx)(a.em,{children:"capability body"})," with the predicate function that determines whether the capability is granted or rejected.",(0,t.jsx)(a.br,{}),"\n","This predicate function is evaluated during capability acquisition."]}),"\n"]}),"\n",(0,t.jsxs)(a.p,{children:["The following example defines a basic ",(0,t.jsx)(a.code,{children:"ALLOW_ENTRY"})," capability in a ",(0,t.jsx)(a.code,{children:"registration"})," module:"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:'(module registration GOVERNANCE\n  (defcap GOVERNANCE () true)\n  \n  (defcap ALLOW_ENTRY (user-id:string)\n    "Govern entry operation."\n    (with-read users-table user-id\n      { "guard" := guard, "active" := active }\n      (enforce-guard guard)\n      (enforce active "Only active users allowed entry"))\n  )\n)\n'})}),"\n",(0,t.jsxs)(a.p,{children:["In this example, the ",(0,t.jsx)(a.code,{children:"defcap"})," declaration for the ",(0,t.jsx)(a.code,{children:"ALLOW_ENTRY"})," capability consists of the following:"]}),"\n",(0,t.jsxs)(a.ul,{children:["\n",(0,t.jsxs)(a.li,{children:["\n",(0,t.jsxs)(a.p,{children:[(0,t.jsx)(a.code,{children:"ALLOW_ENTRY"})," is the ",(0,t.jsx)(a.em,{children:"name"})," of the capability."]}),"\n"]}),"\n",(0,t.jsxs)(a.li,{children:["\n",(0,t.jsxs)(a.p,{children:[(0,t.jsx)(a.code,{children:"user-id"})," is a ",(0,t.jsx)(a.em,{children:"parameter"})," that is passed to the capability body to be evaluated."]}),"\n"]}),"\n",(0,t.jsxs)(a.li,{children:["\n",(0,t.jsxs)(a.p,{children:[(0,t.jsx)(a.code,{children:"with-read"})," is the ",(0,t.jsx)(a.em,{children:"capability body"})," that implements the predicate function.\nThe capability body is evaluated when the ",(0,t.jsx)(a.code,{children:"with-capability"})," function is called with a specific ",(0,t.jsx)(a.code,{children:"user-id"})," parameter.\nFor example, if the ",(0,t.jsx)(a.code,{children:"user-id"})," is ",(0,t.jsx)(a.code,{children:"bob"}),", the capability body is evaluated when ",(0,t.jsx)(a.code,{children:'(with-capability (ALLOW_ENTRY "bob") ...)'})," is called."]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(a.p,{children:["In its simplest form, the capability body evaluates one or more conditions to determine whether the permission is granted.\nIf the conditions are met\u2014without exiting or throwing an error\u2014the capability is granted and operations continue.\nIn general, you should test all of the conditions you want to define in the ",(0,t.jsx)(a.code,{children:"defcap"})," declaration using ",(0,t.jsx)(a.code,{children:"enforce"})," statements, so that the permission won't be granted if any condition fails."]}),"\n",(0,t.jsx)(a.h3,{id:"evaluating-and-granting-permissions",children:"Evaluating and granting permissions"}),"\n",(0,t.jsxs)(a.p,{children:["The ",(0,t.jsx)(a.code,{children:"defcap"})," declaration defines the conditions to evaluate to determine whether a permission should be granted (true) or rejected (false).\nYou use the ",(0,t.jsx)(a.code,{children:"with-capability"})," built-in function whenever you want to check these conditions before allowing a user to perform a privileged operation."]}),"\n",(0,t.jsxs)(a.p,{children:["For example, the following ",(0,t.jsx)(a.code,{children:"entry"})," function calls the ",(0,t.jsx)(a.code,{children:"with-capability"})," function to evaluate the ",(0,t.jsx)(a.code,{children:"ALLOW_ENTRY"})," capability before executing two protected operations:"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:'(defun entry (user-id:string)\n  (with-capability (ALLOW_ENTRY user-id)\n    (add-entry user-id)            ;; call a protected operation within the with-capability block\n    (update-entry-status user-id)  ;; update a database within the with-capability block\n  )\n  (record-audit "ENTRY" user-id)   ;; call an unprotected operation outside of the with-capability block\n)\n'})}),"\n",(0,t.jsxs)(a.p,{children:["As illustrated in this example, the capability applies to the protected operations inside of the  ",(0,t.jsx)(a.code,{children:"with-capability"})," code block.\nIf the capability is granted, it remains in scope for all operations contained within the scope of the ",(0,t.jsx)(a.code,{children:"with-capability"})," function.\nIn this example, the ",(0,t.jsx)(a.code,{children:"ALLOW_ENTRY"})," capability remains in scope for the ",(0,t.jsx)(a.code,{children:"add-entry"})," and ",(0,t.jsx)(a.code,{children:"update-entry-status"})," functions.\nAfter the code block containing the call to the ",(0,t.jsx)(a.code,{children:"with-capability"})," function exits, the capability is no longer in scope.\nIn this example, the ",(0,t.jsx)(a.code,{children:"ALLOW_ENTRY"})," capability is removed from scope before executing the ",(0,t.jsx)(a.code,{children:"record-audit"})," function that's outside of the ",(0,t.jsx)(a.code,{children:"with-capability"})," block.\nRestricting the capability to the code contained within the ",(0,t.jsx)(a.code,{children:"with-capability"})," block prevents duplicate testing of the predicate.\nCapabilities that have already been acquired and that are currently in scope are not re-evaluated."]}),"\n",(0,t.jsx)(a.h3,{id:"requiring-a-capability",children:"Requiring a capability"}),"\n",(0,t.jsxs)(a.p,{children:["The ",(0,t.jsx)(a.code,{children:"with-capability"})," function enables smart contract users to attempt to acquire a specified capability that allows them to perform an operation within a limited scope.\nThe ",(0,t.jsx)(a.code,{children:"require-capability"})," function requires smart contract users to have already been granted the specified capability before they can execute an operation.\nThe ",(0,t.jsx)(a.code,{children:"require-capability"})," function doesn't evaluate the conditions to grant a capability.\nIf the required capability wasn't acquired in the context of another function, the function calling the ",(0,t.jsx)(a.code,{children:"require-capability"})," function fails."]}),"\n",(0,t.jsxs)(a.p,{children:["For example, you can require the ",(0,t.jsx)(a.code,{children:"ALLOW_ENTRY"})," capability to have been acquired and currently in scope before executing the ",(0,t.jsx)(a.code,{children:"add-entry"})," function like this:"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:'(defun entry (user-id)\n  (with-capability (ALLOW_ENTRY user-id)\n    (add-entry user-id)            \n    (update-entry-status user-id)\n  )\n  (record-audit "ENTRY" user-id)\n)\n\n(defun add-entry (user-id)\n  (require-capability (ALLOW_ENTRY user-id)) ;; require a previously acquired capability\n  ...\n)\n'})}),"\n",(0,t.jsxs)(a.p,{children:["By requiring a capability, you can define private or restricted functions than cannot be called directly.\nIn this example, the ",(0,t.jsx)(a.code,{children:"add-entry"})," function can only be called by code inside the module that grants the ",(0,t.jsx)(a.code,{children:"ALLOW_ENTRY"})," capability and can only be called for this ",(0,t.jsx)(a.code,{children:"user-id"})," in particular, restricting the function to that user."]}),"\n",(0,t.jsxs)(a.p,{children:["However, it's important to note that the ",(0,t.jsx)(a.code,{children:"require-capability"})," function doesn't scope to a body of code.\nThe position at which you insert it affects the semantics of the function call and the operations that happen first, before the capability requirement is applied.\nIf you insert the ",(0,t.jsx)(a.code,{children:"require-capability"})," call at an inappropriate position, you might see unexpected behavior or error messages.\nIn general, you should insert the ",(0,t.jsx)(a.code,{children:"require-capability"})," call at the beginning of a function call."]}),"\n",(0,t.jsx)(a.h3,{id:"composing-capabilities",children:"Composing capabilities"}),"\n",(0,t.jsxs)(a.p,{children:["A ",(0,t.jsx)(a.code,{children:"defcap"})," declaration can also include other capabilities, for modular factoring of guard code or to compose an outer capability from smaller, inner capabilities.\nFor example, the following ",(0,t.jsx)(a.code,{children:"ALLOW_ENTRY"})," capability declaration includes an inner capability\u2014the DB_LOG capability\u2014that's defined its own separate ",(0,t.jsx)(a.code,{children:"defcap"})," declaration:"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:'(defcap ALLOW_ENTRY (user-id:string)\n  "Govern entry operation."\n  (with-read users-table user-id\n    { "guard" := guard, "active" := active }\n    (enforce-guard guard)\n    (enforce active "Only active users allowed entry")\n    (compose-capability DB_LOG) ;; allow db logging while ALLOW_ENTRY is in scope\n    )\n)\n(defcap DB_LOG () true)\n'})}),"\n",(0,t.jsxs)(a.p,{children:["Composed capabilities must be defined using ",(0,t.jsx)(a.code,{children:"defcap"})," declarations in the same module as the parent capability and are only in scope when their parent capability is granted."]}),"\n",(0,t.jsxs)(a.p,{children:["In many cases, you can use the ",(0,t.jsx)(a.code,{children:"compose-capability"})," function to improve code logic with clear separation of concerns.\nThe following example illustrates separating the ",(0,t.jsx)(a.code,{children:"transfer"}),", ",(0,t.jsx)(a.code,{children:"debit"}),", and ",(0,t.jsx)(a.code,{children:"credit"})," functions\u2014and corresponding capabilities\u2014so that ",(0,t.jsx)(a.code,{children:"debit"})," is always called with a corresponding ",(0,t.jsx)(a.code,{children:"credit"})," operation with the ",(0,t.jsx)(a.code,{children:"TRANSFER"}),' capability being a "no-guard" capability that simply encloses the ',(0,t.jsx)(a.code,{children:"debit"})," and ",(0,t.jsx)(a.code,{children:"credit"})," calls:"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:"(defcap TRANSFER:bool (from:string to:string amount:decimal)\n  (compose-capability (DEBIT from))\n  (compose-capability (CREDIT to)))\n\n(defcap DEBIT (from:string)\n  (enforce-guard (at 'guard (read table from))))\n\n(defcap CREDIT (to:string)\n  (check-account-exists to))\n\n(defun transfer (from:string to:string amount:decimal)\n  (with-capability (TRANSFER from to amount)\n    (debit from amount)\n    (credit to amount)))\n\n(defun debit (user amount)\n  (require-capability (DEBIT user))\n    (update accounts user ...))\n\n(defun credit (user amount)\n  (require-capability (CREDIT user)\n    (update accounts user ...)))\n"})}),"\n",(0,t.jsx)(a.p,{children:"In this example:"}),"\n",(0,t.jsxs)(a.ul,{children:["\n",(0,t.jsxs)(a.li,{children:["The ",(0,t.jsx)(a.code,{children:"TRANSFER"})," capability protects the ",(0,t.jsx)(a.code,{children:"debit"})," and ",(0,t.jsx)(a.code,{children:"credit"})," calls from being used independently."]}),"\n",(0,t.jsxs)(a.li,{children:["The ",(0,t.jsx)(a.code,{children:"DEBIT"})," capability governs the ability to debit, enforcing the guard."]}),"\n",(0,t.jsxs)(a.li,{children:["The ",(0,t.jsx)(a.code,{children:"CREDIT"})," simply creates a restricted capability for the ",(0,t.jsx)(a.code,{children:"credit"})," function."]}),"\n"]}),"\n",(0,t.jsx)(a.h2,{id:"calling-basic-capabilities",children:"Calling basic capabilities"}),"\n",(0,t.jsx)(a.p,{children:"To give you better insight into how to call capabilities, it's important to consider the concept of scope in Pact modules.\nPotentially, there are several layers of scope that can you might need to navigate, including:"}),"\n",(0,t.jsxs)(a.ul,{children:["\n",(0,t.jsx)(a.li,{children:"Top-level scope"}),"\n",(0,t.jsx)(a.li,{children:"Module scope"}),"\n",(0,t.jsx)(a.li,{children:"Outer capability scope for composing capabilities"}),"\n",(0,t.jsx)(a.li,{children:"Inner capability scope for composed capabilities"}),"\n",(0,t.jsx)(a.li,{children:"Signature-based scope"}),"\n"]}),"\n",(0,t.jsxs)(a.p,{children:["You've seen an example of outer and inner capability scope in ",(0,t.jsx)(a.a,{href:"#composing-capabilities",children:"Composing capabilities"}),".\nHowever, it's equally important to know the difference between top-level scope and module scope for capabilities."]}),"\n",(0,t.jsx)(a.h3,{id:"top-level-scope",children:"Top-level scope"}),"\n",(0,t.jsx)(a.p,{children:"In Pact, the functions and expressions that you execute outside of a module declaration are often referred to as top-level expressions.\nFunctions and expressions that are defined within a module declaration are within the scope of that module.\nFor example, top-level expressions can include direct calls to built-in functions like the following:"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:"(+ 1 2)\n(map (- 1) [10 20 30])\n"})}),"\n",(0,t.jsx)(a.p,{children:"In addition, there are several top-level expressions that set context for a module that must be defined outside of the module declaration.\nFor example, you use top-level expressions to define and enter a namespace, define keysets, create tables, and read messages from transaction data."}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:';; Before module declaration\n\n(define-namespace dev-namespace (read-keyset "user-account" ) (read-keyset "dev-ks-account" ))\n(define-keyset "dev-namespace.dev-ks-account" (read-keyset "dev-ks-account" ))\n\n;; Module declaration\n(\n    ...\n)\n\n;; After module declaration\n\n(if (read-msg \'upgrade)\n  ["upgrade"]\n  [\n    (create-table order-table)\n  ]\n)\n'})}),"\n",(0,t.jsx)(a.h3,{id:"module-scope",children:"Module scope"}),"\n",(0,t.jsxs)(a.p,{children:["The functions and expressions that are defined in a module declaration are included in the scope of that module.\nFor example, if you define the ",(0,t.jsx)(a.code,{children:"awards"})," function in the ",(0,t.jsx)(a.code,{children:"league"})," module declaration, the function is within the scope of the ",(0,t.jsx)(a.code,{children:"league"})," module."]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:"(module league GOVERNANCE \n  (defcap GOVERNANCE () true)\n   (defun awards (tier:integer)\n     (+ tier 2) \n   )\n)\n"})}),"\n",(0,t.jsx)(a.h3,{id:"acquire-a-capability-inside-of-a-module",children:"Acquire a capability inside of a module"}),"\n",(0,t.jsxs)(a.p,{children:["In most cases, capabilities are defined within the scope of a module and you can acquire the access token from within the body of any function defined in the module if you meet the conditions specified in the body of the ",(0,t.jsx)(a.code,{children:"defcap"})," declaration."]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:"(module league GOVERNANCE\n  (defcap GOVERNANCE ()\n    (enforce-keyset league_admin))\n  (defcap LEAGUE_OPS ()\n    ;; one or more conditions that must pass\n  )\n\n  (defun awards (tier:integer)\n     (with-capability (LEAGUE_OPS) (+ tier 2)) ; operation succeeds if the conditions for LEAGUE_OPS are met     \n  )\n)\n"})}),"\n",(0,t.jsxs)(a.p,{children:["For example, you can acquire the ",(0,t.jsx)(a.code,{children:"league.LEAGUE_OPS"})," capability by using the ",(0,t.jsx)(a.code,{children:"with-capability"})," call in any function declaration or ",(0,t.jsx)(a.code,{children:"defpact"})," step in the ",(0,t.jsx)(a.code,{children:"league"})," module where the ",(0,t.jsx)(a.code,{children:"LEAGUE_OPS"})," capability is declared."]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:"(module league GOVERNANCE\n  (defcap GOVERNANCE ()\n    (enforce-keyset league_admin))\n  (defcap LEAGUE_OPS ()\n    ;; one or more conditions that must pass\n  )\n\n  (defun awards (tier:integer)\n     (with-capability (LEAGUE_OPS) (+ tier 2)) ; operation succeeds if the conditions for LEAGUE_OPS are met     \n  )\n  \n  (defpact transfer-portal ()\n    (step (with-capability (LEAGUE_OPS) ... )) ; operation succeeds if the conditions for LEAGUE_OPS are met\n    (step ...)\n  )\n)\n"})}),"\n",(0,t.jsxs)(a.p,{children:["These examples demonstrate the most common way you acquire the privileges associated with a capability is by calling the ",(0,t.jsx)(a.code,{children:"with-capability"})," built-in function within a ",(0,t.jsx)(a.code,{children:"defun"})," or ",(0,t.jsx)(a.code,{children:"defpact"})," declaration inside of a module declaration.\nIf the conditions specified in the body of the capability declaration are met, permissions are granted and the operation proceeds.\nThe conditions you specify in the body of the capability declaration can vary, but typically enforce some type of guard or key signature."]}),"\n",(0,t.jsx)(a.p,{children:"You should also note that you can't acquire a capability inside of a capability declaration.\nFor example, if you try to acquire a capability in the body of a capability declaration, you'll see an error similar to the following:"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:'"Loading league.pact..."\nleague.pact:13:7: with-capability form not allowed within defcap\n 13 |       ((with-capability (LEAGUE_OPS) (* tier 2)))\n    |        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n'})}),"\n",(0,t.jsx)(a.h3,{id:"acquire-a-capability-outside-of-a-module",children:"Acquire a capability outside of a module"}),"\n",(0,t.jsx)(a.p,{children:"You can acquire a capability in the top-level\u2014that is, outside of the scope of a module\u2014or within the scope of another module if, and only if, you have the administrative privileges to control the module and satisfy the conditions to acquire the capability."}),"\n",(0,t.jsxs)(a.p,{children:["The following example illustrates a module declaration for the ",(0,t.jsx)(a.code,{children:"west-conf"})," module that defines a GOVERNANCE capability and an UMPIRE capability with conditions set to true to always succeed:"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:"(module west-conf GOVERNANCE\n  (defcap GOVERNANCE () true)\n  (defcap UMPIRE () true)\n  ...\n)\n"})}),"\n",(0,t.jsxs)(a.p,{children:["If you deploy this module or load it into the Pact REPL, the GOVERNANCE capability grants you the administrative privileges for the transactions immediately following the deployment of the module.\nFor example, after you load the ",(0,t.jsx)(a.code,{children:"west-conf"})," module in the Pact REPL, you can acquire the ",(0,t.jsx)(a.code,{children:"UMPIRE"})," capability to perform an operation:"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:"(with-capability (west-conf.UMPIRE) (* 3 8))\n24\n"})}),"\n",(0,t.jsxs)(a.p,{children:["Because deploying a module grants you administrative privileges for the module, you can perform other privileged operations\u2014like upgrading modules and creating tables\u2014in the same deployment transaction.\nIn this example, there are no conditions that must be met to acquire the ",(0,t.jsx)(a.code,{children:"UMPIRE"})," capability.\nIf there were conditions to enforce in the body of the ",(0,t.jsx)(a.code,{children:"defcap"})," declaration for the ",(0,t.jsx)(a.code,{children:"UMPIRE"})," capability, those conditions would need to be satisfied to perform the requested operation."]}),"\n",(0,t.jsx)(a.p,{children:"The previous example demonstrates the principle of using module administrator privileges to bring a capability into scope.\nHowever, this example doesn't represent a typical use-case.\nIn most cases, you want to carefully control and restrict access to capabilities to prevent unintended privilege elevation.\nIf access to the module administrator privileges is managed in any way\u2014for example, owned by a specific keyset or guard or if a module is not upgradable\u2014you must be able to acquire the module administrator rights to bring a capability into scope."}),"\n",(0,t.jsxs)(a.p,{children:["To acquire module administrator rights for testing purposes in the Pact REPL, you can use the ",(0,t.jsx)(a.a,{href:"/pact-5/repl/env-module-admin",children:(0,t.jsx)(a.code,{children:"env-module-admin"})})," and ",(0,t.jsx)(a.a,{href:"/pact-5/general/acquire-module-admin",children:(0,t.jsx)(a.code,{children:"acquire-module-admin"})})," built-in functions."]}),"\n",(0,t.jsxs)(a.p,{children:["The following example demonstrates using the ",(0,t.jsx)(a.code,{children:"acquire-module-admin"})," function to access module administrator rights for ",(0,t.jsx)(a.code,{children:"module-test"})," to upgrade a module:"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:'pact> (module west-conf GOVERNANCE (defcap GOVERNANCE () (enforce false "non-upgradable")))\nLoaded module west-conf, hash v4XXlmt7RI-HVZvPb69lQhFbh8k-luKCtWtm4OVJVU8\npact> (begin-tx "Begin a new transaction after deployment")\n"Begin Tx 0 Begin a new transaction after deployment"\npact> (use west-conf)\nLoaded imports from west-conf\npact> (with-capability (GOVERNANCE) (* 3 8))\n(interactive):1:51: non-upgradable\n 1 |  (with-capability (GOVERNANCE) (* 3 8))\n   |                                                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  at(west-conf.GOVERNANCE.{v4XXlmt7RI-HVZvPb69lQhFbh8k-luKCtWtm4OVJVU8}):(interactive):0:1-0:39\npact> (acquire-module-admin west-conf)\n"Module admin for module west-conf acquired"\npact> (with-capability (GOVERNANCE) (* 3 8))\n24\n'})}),"\n",(0,t.jsxs)(a.p,{children:["To limit module administrator privileges for a capability to a specific transaction block, you can use the ",(0,t.jsx)(a.code,{children:"env-module-admin"})," built-in function."]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:'pact> (begin-tx "Get module admin privileges for a transaction")\n"Begin Tx 1 Get module admin privileges for a transaction"\npact> (use west-conf)\nLoaded imports from west-conf\npact> (with-capability (GOVERNANCE) (* 6 9))\n(interactive):1:51: non-upgradable\n 1 | (with-capability (GOVERNANCE) (* 6 9))\n   |                                                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\npact> (env-module-admin west-conf)\n"Acquired module admin for: west-conf"\npact> (with-capability (GOVERNANCE) (* 6 9))\n54\n'})}),"\n",(0,t.jsx)(a.h2,{id:"managed-capabilities",children:"Managed capabilities"}),"\n",(0,t.jsx)(a.p,{children:"Most capabilities control permissions to access protected operations.\nHowever, Pact also supports managed capabilities.\nManaged capabilities provide an additional layer of security that requires all parties involved in a transaction to specify the actions they are authorizing with their signature or a guard.\nBy requiring a signature or guard to authorize an action, managed capabilities enable smart contract users to safely interact with otherwise untrusted code."}),"\n",(0,t.jsxs)(a.p,{children:["As a smart contract author, you specify that a capability is a managed capability by adding the ",(0,t.jsx)(a.code,{children:"@managed"})," metadata tag in the ",(0,t.jsx)(a.code,{children:"defcap"})," declaration body.\nYou can define managed capabilities to manage resources in two different ways:"]}),"\n",(0,t.jsxs)(a.ul,{children:["\n",(0,t.jsxs)(a.li,{children:["To update a specific resource dynamically through a ",(0,t.jsx)(a.strong,{children:"management function"}),"."]}),"\n",(0,t.jsxs)(a.li,{children:["To automatically update a resource ",(0,t.jsx)(a.strong,{children:"once"})," without using a management function."]}),"\n"]}),"\n",(0,t.jsx)(a.p,{children:"Managed capabilities that use a management function can be called multiple times.\nManaged capabilities that don't specify a management function can only be called once."}),"\n",(0,t.jsx)(a.h3,{id:"using-management-functions",children:"Using management functions"}),"\n",(0,t.jsxs)(a.p,{children:["One of the most common use cases for managed capabilities with management functions is for transfer operations.\nThe following example illustrates this use case with the ",(0,t.jsx)(a.code,{children:"TRANSFER"})," managed capability and the ",(0,t.jsx)(a.code,{children:"TRANSFER_mgr"})," management function:"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:'  (defcap TRANSFER:bool (sender:string receiver:string amount:decimal)\n    @managed amount TRANSFER-mgr\n    (enforce (!= sender receiver) "same sender and receiver")\n    (enforce (> amount 0.0) "Positive amount")\n    (compose-capability (DEBIT sender))\n    (compose-capability (CREDIT receiver))\n  )\n\n  (defun TRANSFER-mgr:decimal (managed:decimal requested:decimal)\n    (let ((newbal (- managed requested))) ;; update managed quantity for next time\n      (enforce (>= newbal 0.0)            ;; check that the new balance doesn\'t exceed the managed quantity\n        (format "TRANSFER exceeded for balance {}" [managed]))\n      newbal)\n  )\n'})}),"\n",(0,t.jsxs)(a.p,{children:["In this example, the ",(0,t.jsx)(a.code,{children:"TRANSFER"})," capability allows the ",(0,t.jsx)(a.code,{children:"sender"})," to approve any number of transfer operations to the ",(0,t.jsx)(a.code,{children:"receiver"})," up to the ",(0,t.jsx)(a.em,{children:"managed resource"})," specified by the ",(0,t.jsx)(a.code,{children:"@managed"})," keyword.\nIn this case, the resource is the ",(0,t.jsx)(a.code,{children:"amount"})," value and the ",(0,t.jsx)(a.code,{children:"TRANSFER_mgr"})," function checks and updates that resource value each time the ",(0,t.jsx)(a.code,{children:"TRANSFER"})," capability is called for in the ",(0,t.jsx)(a.code,{children:"transfer"})," function:"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:'(defun transfer:string (sender:string receiver:string amount:decimal)\n    (enforce (!= sender receiver) "sender cannot be the receiver of a transfer")\n    (enforce (> amount 0.0) "transfer amount must be positive")\n\n    (with-capability (TRANSFER sender receiver amount)\n      (debit sender amount)\n      (with-read coin-table receiver\n        { "guard" := g }\n\n        (credit receiver g amount))\n    )\n)\n'})}),"\n",(0,t.jsxs)(a.p,{children:["If transfer operations exceed the ",(0,t.jsx)(a.code,{children:"amount"})," value, the ",(0,t.jsx)(a.code,{children:"TRANSFER"})," capability can no longer be brought into scope."]}),"\n",(0,t.jsxs)(a.p,{children:["Smart contract users set the values for the ",(0,t.jsx)(a.code,{children:"transfer"})," operation and ",(0,t.jsx)(a.code,{children:"TRANSFER"})," capability and approve the operation by signing for the capability when they send the transaction to the blockchain.\nTypically, you allow smart contract users to set the transfer values and approve the operation through the frontend of a smart wallet or a similar application.\nFor example, as a smart contract author, you enable smart contract users to construct and submit transactions that set the ",(0,t.jsx)(a.code,{children:"sender"}),", ",(0,t.jsx)(a.code,{children:"receiver"}),", and ",(0,t.jsx)(a.code,{children:"amount"})," parameters and sign for the ",(0,t.jsx)(a.code,{children:"TRANSFER"})," capability when they call the ",(0,t.jsx)(a.code,{children:"transfer"})," operation.\nIn the Pact REPL, you can emulate setting the keys in the environment data and signing the capability.\nFor example:"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:'(env-data {"alice":["alice"], "bob":["bob"]})\n(env-sigs [{"key":"alice", "caps":[(pistolas-coin.TRANSFER "alice" "bob" 50.0)]}])\n(pistolas-coin.transfer "alice" "bob" 40.0)\n'})}),"\n",(0,t.jsx)(a.p,{children:"You should note that managed capabilities always require smart contract users to explicitly approve the operation to be performed.\nIf a transaction includes a managed capability, all capabilities involved in the transaction require a signature.\nUnrestricted keys aren't allowed if a transaction includes a managed capability."}),"\n",(0,t.jsxs)(a.p,{children:["In most cases, managed resources represent decimal or integer values, but you can use managed capabilities and management functions to manage any type of resource.\nFor example, you could specify a list or an object as the resource you want to manage, then write a management function that removes names from the list or updates object properties based on some condition.\nHowever, the ",(0,t.jsx)(a.code,{children:"@managed"})," keyword only allows you to specify a single resource to be managed\u2014that is, updated\u2014by the management function."]}),"\n",(0,t.jsx)(a.h3,{id:"single-use-managed-capabilities",children:"Single-use managed capabilities"}),"\n",(0,t.jsx)(a.p,{children:"Managed capabilities that specify a management function update the managed resource dynamically each time the requested capability is acquired.\nIf a managed capability doesn't specify a management function, the requested capability can only be called once in a transaction.\nFurther attempts will fail after the initial grant goes out of scope."}),"\n",(0,t.jsx)(a.p,{children:"In the following example, the VOTE capability is automatically managed to ensure that a validated member can only vote once:"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:"(defcap VOTE (member:string)\n  @managed\n  (validate-member member))\n"})}),"\n",(0,t.jsx)(a.h2,{id:"scoped-signatures-and-verifiers",children:"Scoped signatures and verifiers"}),"\n",(0,t.jsxs)(a.p,{children:["In Pact transaction messages, transaction signers can ",(0,t.jsx)(a.strong,{children:"scope"})," their signature to one or more specific capabilities.\nBy scoping signatures to specific capabilities, smart contract users can restrict guard operations based on that signature.\nThese explicitly-authorized actions are separate from the Pact code that's executed in the transaction.\nRegardless of the code that runs during the transaction, scoped capabilities ensure that only authorized actions can be performed on the user's behalf."]}),"\n",(0,t.jsxs)(a.p,{children:["Unlike managed capabilities that require a signature or a guard and a managed resource, most capabilities allow users to sign transactions using an unrestricted signing key.\nScoped capabilities provide a transparent way for transaction signers to safely call untrusted code.\nFor example, the ",(0,t.jsx)(a.code,{children:"sender"})," of a transaction can explicitly sign for the ",(0,t.jsx)(a.code,{children:"GAS"})," capability to authorize gas payments in the ",(0,t.jsx)(a.code,{children:"coin"})," contract.\nBy scoping the signature to this capability, the account signature can't be used to access any other code that might be called by the transaction."]}),"\n",(0,t.jsx)(a.p,{children:'If a user authorizes a specific capability, the capability is attached to the signature list for the transaction.\nFor example, the following transaction excerpt attaches two capabilities\u2014coin.TRANSFER and coin.GAS\u2014to the public key "fe4b6da332193cce4d3bd1ebdc716a0e4c3954f265c5fddd6574518827f608b7" signature:'}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-json",children:'{\n    "signers": [\n        {\n            "pubKey": "fe4b6da332193cce4d3bd1ebdc716a0e4c3954f265c5fddd6574518827f608b7",\n            "clist": [\n            {\n                "name": "coin.TRANSFER",\n                "args": ["k:fe4b6da3...27f608b7" "k:4fe7981d...0bc284d0\\",2]},\n            {\n                "name": "coin.GAS",\n                "args":[]}\n            ]\n        }\n    ]\n}\n'})}),"\n",(0,t.jsxs)(a.p,{children:["The following example illustrates an ",(0,t.jsx)(a.code,{children:"accounts"})," module with a ",(0,t.jsx)(a.code,{children:"PAY"})," capability that isn't managed:"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:'(begin-tx)\n(module accounts GOVERNANCE\n  (defcap GOVERNANCE ()\n    (enforce false "NON-UPGRADABLE")\n  )\n\n  (defschema account\n    balance:decimal\n    account-guard:guard\n  )\n  (deftable accounts-table:{account})\n\n  (defcap PAY (sender:string receiver:string amount:decimal)\n    (enforce-guard (at \'account-guard (read accounts-table sender))))\n\n  (defun pay (sender:string receiver:string amount:decimal)\n    (with-capability (PAY sender receiver amount)\n      (transfer sender receiver amount)))\n  \n  (defun transfer (sender:string receiver:string amount:decimal)\n    (with-read accounts-table sender\n      { "balance" := b}\n      (with-read accounts-table receiver\n        {"balance" := to-balance}\n          (update accounts-table receiver {"balance":(+ to-balance amount)})\n          (update accounts-table sender {"balance":(- b amount)})\n      )\n    )\n  )\n)\n(create-table accounts-table)\n(env-data {"alice":["alice"], "bob":["bob"]})\n(write accounts-table "alice" {"balance":100.0, "account-guard":(read-keyset "alice")})\n(write accounts-table "bob" {"balance":100.0, "account-guard":(read-keyset "bob")})\n(commit-tx)\n'})}),"\n",(0,t.jsxs)(a.p,{children:["In the Pact REPL, you can attach the signature for the ",(0,t.jsx)(a.code,{children:"alice"})," key to the ",(0,t.jsx)(a.code,{children:"accounts.PAY"})," capability by using the ",(0,t.jsx)(a.code,{children:"env-sigs"})," built-in function as follows:"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:'(env-sigs [{"key": "alice", "caps": [(accounts.PAY "alice" "bob" 10.0)]}])\n(accounts.pay "alice" "bob" 10.0) ;; works as the cap matches the signature caps\n'})}),"\n",(0,t.jsx)(a.p,{children:"If you modify the scoped capability to use a different receiver or amount, the transaction returns a keyset failure."}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:'(env-sigs [{"key": "alice", "caps": [(accounts.PAY "alice" "carol" 10.0)]}])\n(accounts.pay "alice" "bob" 10.0)\n'})}),"\n",(0,t.jsx)(a.p,{children:"For example:"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:'cope-pay.repl:14:4: Keyset failure (keys-all): [alice...]\n 14 |     (enforce-guard (at \'account-guard (read accounts-table sender))))\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  at(accounts.PAY.{z5Kc3VKBgIr085VLRK2n1rMdlmIxi-NN-P7lYfA6xqg} "alice" "bob" 10.0):scope-pay.repl:16:4-17:40\n  at(accounts.pay.{z5Kc3VKBgIr085VLRK2n1rMdlmIxi-NN-P7lYfA6xqg} "alice" "bob" 10.0):scope-pay.repl:40:0-40:33\n'})}),"\n",(0,t.jsxs)(a.p,{children:["Scoped capabilities can also be installed by ",(0,t.jsx)(a.a,{href:"https://github.com/kadena-io/KIPs/pull/57",children:(0,t.jsx)(a.em,{children:"verifier plug-ins"})}),".\nCapabilities that are installed by verifier plug-ins are also scoped to the specific capabilities that they install.\nVerifier plugins are external to Pact.\nHowever, they are similar to signature capabilities in that they enable you to specify some type of trusted entity\u2014for example, a signature or a generated proof\u2014that grants the capabilities to perform some type of protected operation.\nA signature capability can use the ",(0,t.jsx)(a.code,{children:"(enforce-guard g)"})," function to check that the keyset guard ",(0,t.jsx)(a.code,{children:"g"})," includes the signer's key.\nA capability granted by a verifier plug-in can use the ",(0,t.jsx)(a.code,{children:"(enforce-verifier 'name)"})," function to check that ",(0,t.jsx)(a.code,{children:'"name"'})," is the name of the verifier plug-in."]}),"\n",(0,t.jsx)(a.h2,{id:"events",children:"Events"}),"\n",(0,t.jsx)(a.p,{children:"In Pact, events are emitted as part of transaction execution and are included in the transaction results.\nWith events, you can monitor transaction results to determine if a specific operation occurred and prove the outcome using a simple payment verification proof."}),"\n",(0,t.jsx)(a.p,{children:"Events are treated as capabilities because they share the following characteristics:"}),"\n",(0,t.jsxs)(a.ul,{children:["\n",(0,t.jsx)(a.li,{children:"Events, like capabilities, allow arbitrary data to be published under a topic or a name.\nWith capabilities, the capability name is the topic, and the arguments are the data."}),"\n",(0,t.jsx)(a.li,{children:"Granting permission to acquire a managed capability is, in itself, an event recorded for transaction.\nEvents complete the managed capability lifecycle, where you might install or approve a capability of some quantity on the way in, but not necessarily see what quantity was used.\nWith events, the output of the acquired capability is present in the transaction results."}),"\n",(0,t.jsx)(a.li,{children:"Capabilities are protected such that they can only be acquired in module code, which is appropriate for events as well."}),"\n"]}),"\n",(0,t.jsxs)(a.p,{children:["You can emit events for any basic capability by including the ",(0,t.jsx)(a.code,{children:"@event"})," metadata tag in the ",(0,t.jsx)(a.code,{children:"defcap"})," declaration.\nFor example:"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-pact",children:"(defcap BURN:decimal (qty:decimal)\n  @event\n  ...\n)\n"})}),"\n",(0,t.jsxs)(a.p,{children:["If you include the ",(0,t.jsx)(a.code,{children:"@event"})," metadata tag in the ",(0,t.jsx)(a.code,{children:"defcap"})," declaration, the event is emitted any time that capability is successfully acquired.\nBasic capabilities that aren't managed can emit events any number of times."]}),"\n",(0,t.jsxs)(a.p,{children:["Managed capabilities emit events automatically without specifying the ",(0,t.jsx)(a.code,{children:"@event"})," metadata tag.\nThe event for a managed capability is emitted once when the capability is first installed or acquired.\nEvents from managed capabilities include the parameters specified when the capability was installed or acquired."]}),"\n",(0,t.jsxs)(a.p,{children:["You can use the ",(0,t.jsx)(a.a,{href:"/pact-5/repl/env-events",children:(0,t.jsx)(a.code,{children:"env-events"})})," built-in function to test for emitted events in ",(0,t.jsx)(a.code,{children:".repl"})," scripts."]})]})}function h(e={}){const{wrapper:a}={...(0,s.R)(),...e.components};return a?(0,t.jsx)(a,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453:(e,a,i)=>{i.d(a,{R:()=>c,x:()=>r});var n=i(96540);const t={},s=n.createContext(t);function c(e){const a=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function r(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),n.createElement(s.Provider,{value:a},e.children)}}}]);
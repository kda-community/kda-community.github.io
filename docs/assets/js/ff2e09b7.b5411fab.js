"use strict";(self.webpackChunkkadena_docs=self.webpackChunkkadena_docs||[]).push([[7780],{66207:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>d,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>r});const o=JSON.parse('{"id":"resources/election-workshop/workshop-vote","title":"Add vote management","description":"Add voting and vote counting functionality to the election application in the Pact module smart contract backend.","source":"@site/docs/resources/election-workshop/8-add-vote-management.md","sourceDirName":"resources/election-workshop","slug":"/resources/election-workshop/workshop-vote","permalink":"/docs/resources/election-workshop/workshop-vote","draft":false,"unlisted":false,"editUrl":"https://github.com/kda-community/kadena-docs-new/blob/master/docs/resources/election-workshop/8-add-vote-management.md","tags":[],"version":"current","sidebarPosition":9,"frontMatter":{"title":"Add vote management","description":"Add voting and vote counting functionality to the election application in the Pact module smart contract backend.","id":"workshop-vote","sidebar_position":9}}');var i=t(74848),c=t(28453);const a={title:"Add vote management",description:"Add voting and vote counting functionality to the election application in the Pact module smart contract backend.",id:"workshop-vote",sidebar_position:9},d="Add vote management",s={},r=[{value:"Before you begin",id:"before-you-begin",level:2},{value:"Organize tests in REPL files",id:"organize-tests-in-repl-files",level:2},{value:"Implement and test a vote function",id:"implement-and-test-a-vote-function",level:2},{value:"Test incrementing votes",id:"test-incrementing-votes",level:3},{value:"Test voting for an invalid candidate",id:"test-voting-for-an-invalid-candidate",level:3},{value:"Test error handling",id:"test-error-handling",level:3},{value:"Prevent double votes",id:"prevent-double-votes",level:2},{value:"Define votes schema and table",id:"define-votes-schema-and-table",level:3},{value:"Test the votes table",id:"test-the-votes-table",level:3},{value:"Prevent voting on behalf of other accounts",id:"prevent-voting-on-behalf-of-other-accounts",level:2},{value:"Verify voting on one&#39;s own behalf",id:"verify-voting-on-ones-own-behalf",level:3},{value:"Update the deployed module",id:"update-the-deployed-module",level:2},{value:"Update the frontend",id:"update-the-frontend",level:2},{value:"Cast a vote",id:"cast-a-vote",level:2},{value:"Next steps",id:"next-steps",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"add-vote-management",children:"Add vote management"})}),"\n",(0,i.jsxs)(n.p,{children:["In the previous tutorial, you built and deployed an ",(0,i.jsx)(n.code,{children:"election"})," module on the local development network.\nYou then connected the frontend built with the ",(0,i.jsx)(n.code,{children:"@kadena/client"})," library to the development network backend.\nAfter connecting the frontend to the development network backend, you were able to view the candidate you added to the ",(0,i.jsx)(n.code,{children:"candidates"})," database table."]}),"\n",(0,i.jsxs)(n.p,{children:["In this tutorial, you'll update the ",(0,i.jsx)(n.code,{children:"election"})," module to allow anyone with a Kadena single-key account to cast a vote on a candidate.\nAfter you update the backend functionality, you'll modify the vote functionality for the frontend to use the development network.\nAfter making these changes, Kadena account holders can vote using the ",(0,i.jsx)(n.code,{children:"election"})," module and have their votes recorded on the blockchain, ensuring the security and transparency of the election process."]}),"\n",(0,i.jsx)(n.h2,{id:"before-you-begin",children:"Before you begin"}),"\n",(0,i.jsx)(n.p,{children:"Before you start this tutorial, verify the following basic requirements:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"You have an internet connection and a web browser installed on your local computer."}),"\n",(0,i.jsxs)(n.li,{children:["You have a code editor, such as ",(0,i.jsx)(n.a,{href:"https://code.visualstudio.com/download",children:"Visual Studio Code"}),", access to an interactive terminal shell, and are generally familiar with using command-line programs."]}),"\n",(0,i.jsxs)(n.li,{children:["You have cloned the ",(0,i.jsx)(n.a,{href:"https://github.com/kadena-community/voting-dapp.git",children:"voting-dapp"})," repository to create your project directory as described in ",(0,i.jsx)(n.a,{href:"/resources/election-workshop/workshop-prepare",children:"Prepare your workspace"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["You have the development network running in a Docker container as described in ",(0,i.jsx)(n.a,{href:"/resources/election-workshop/workshop-start",children:"Start a local blockchain"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["You are ",(0,i.jsx)(n.a,{href:"/resources/election-workshop/workshop-start#connect-to-the-development-network",children:"connected to the development network"})," using your local host IP address and port number 8080."]}),"\n",(0,i.jsxs)(n.li,{children:["You have created and funded an administrative account as described in ",(0,i.jsx)(n.a,{href:"/resources/election-workshop/workshop-admin",children:"Add an administrator account"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["You have created a principal namespace on the development network as described in ",(0,i.jsx)(n.a,{href:"/resources/election-workshop/workshop-namespace",children:"Define a namespace"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["You have defined the keyset that controls your namespace using the administrative account as described in ",(0,i.jsx)(n.a,{href:"/resources/election-workshop/workshop-keysets",children:"Define keysets"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["You have created an election Pact module and deployed it as described in ",(0,i.jsx)(n.a,{href:"/resources/election-workshop/workshop-write",children:"Write a smart contract"})," and updated its functionality as described in ",(0,i.jsx)(n.a,{href:"/resources/election-workshop/workshop-nominate",children:"Nominate candidates"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"organize-tests-in-repl-files",children:"Organize tests in REPL files"}),"\n",(0,i.jsxs)(n.p,{children:["So far, you have added all of your tests for the ",(0,i.jsx)(n.code,{children:"election"})," module to the  ",(0,i.jsx)(n.code,{children:"election-workshop/pact/election.repl"})," file.\nWhile this is convenient if you have a small number of tests, continuing to add tests to a single file will make testing more complex and more difficult to follow.\nTo keep tests more organized, you can split them into multiple ",(0,i.jsx)(n.code,{children:".repl"})," files and reuse the code by loading one file into the other."]}),"\n",(0,i.jsx)(n.p,{children:"To organize tests into separate files:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-workshop/pact"})," folder in the code editor on your computer."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Rename ",(0,i.jsx)(n.code,{children:"election.repl"})," to ",(0,i.jsx)(n.code,{children:"candidates.repl"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Create a new ",(0,i.jsx)(n.code,{children:"setup.repl"})," file in the ",(0,i.jsx)(n.code,{children:"pact"})," folder."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Move the code before ",(0,i.jsx)(n.code,{children:'(begin-tx "Load election module")'})," from the ",(0,i.jsx)(n.code,{children:"candidates.repl"})," into the ",(0,i.jsx)(n.code,{children:"setup.repl"})," file."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Create a new ",(0,i.jsx)(n.code,{children:"voting.repl"})," file in the ",(0,i.jsx)(n.code,{children:"pact"})," folder and add the following as the first line in the file:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(load "setup.repl")\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"candidates.repl"})," file and add the following as the first line in the file:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(load "setup.repl")\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Verify tests in the ",(0,i.jsx)(n.code,{children:"candidates.repl"})," file still pass by running the following command:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"pact candidates.repl --trace\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Verify that ",(0,i.jsx)(n.code,{children:"voting.repl"})," loads successfully by running the following command:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"pact voting.repl --trace\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"implement-and-test-a-vote-function",children:"Implement and test a vote function"}),"\n",(0,i.jsxs)(n.p,{children:["When an account holder clicks ",(0,i.jsx)(n.strong,{children:"Vote Now"})," in the election application, it triggers a call to the ",(0,i.jsx)(n.code,{children:"vote"})," function in the ",(0,i.jsx)(n.code,{children:"frontend/src/repositories/vote/DevnetVoteRepository.ts"})," file, passing the current account name and the name of the candidate corresponding to the table row that was clicked.\nThe ",(0,i.jsx)(n.code,{children:"vote"})," function in the frontend uses the Kadena client to execute the ",(0,i.jsx)(n.code,{children:"vote"})," function defined in the ",(0,i.jsx)(n.code,{children:"election"})," module."]}),"\n",(0,i.jsxs)(n.p,{children:["To implement the ",(0,i.jsx)(n.code,{children:"vote"})," function in the ",(0,i.jsx)(n.code,{children:"election"})," Pact module, you can test your code as you go using the Pact REPL as you did in previous tutorials."]}),"\n",(0,i.jsx)(n.h3,{id:"test-incrementing-votes",children:"Test incrementing votes"}),"\n",(0,i.jsxs)(n.p,{children:["Based on the work you did in the previous tutorial, the election application website displays a table of the candidates you have added.\nEach candidate starts with zero (0) votes.\nEach row in the table has a ",(0,i.jsx)(n.strong,{children:"Vote Now"})," button.\nIf you click ",(0,i.jsx)(n.strong,{children:"Vote Now"}),", the number of votes displayed in corresponding row should be increased by one.\nThe table is rendered based on the result of a call to the ",(0,i.jsx)(n.code,{children:"list-candidates"})," function of the ",(0,i.jsx)(n.code,{children:"election"})," Pact module.\nSo, in the Pact REPL you can test the behavior of the new ",(0,i.jsx)(n.code,{children:"vote"})," function against the return value of ",(0,i.jsx)(n.code,{children:"list-candidates"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"To test incrementing votes for a candidate:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-workshop/pact/election.pact"})," file in your code editor."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Define the ",(0,i.jsx)(n.code,{children:"vote"})," function after the ",(0,i.jsx)(n.code,{children:"add-candidate"})," function with the following lines of code:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(defun vote (candidateKey:string)\n  (with-read candidates candidateKey\n    { "name" := name, "votes" := numberOfVotes }\n    (update candidates candidateKey { "votes": (+ numberOfVotes 1) })\n  )\n)\n'})}),"\n",(0,i.jsx)(n.p,{children:"In this code:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"vote"})," function takes one argument\u2014",(0,i.jsx)(n.code,{children:"candidateKey"}),"\u2014with a type of string."]}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"candidateKey"})," specifies the key for the row in the ",(0,i.jsx)(n.code,{children:"candidates"})," table to read using the ",(0,i.jsx)(n.code,{children:"with-read"}),"  built-in function."]}),"\n",(0,i.jsxs)(n.li,{children:["The database column named ",(0,i.jsx)(n.code,{children:'"votes"'})," is assigned a value from the ",(0,i.jsx)(n.code,{children:"numberOfVotes"})," variable."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"vote"})," function then calls the ",(0,i.jsx)(n.code,{children:"update"})," built-in function with three arguments to specify:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The table to update (",(0,i.jsx)(n.code,{children:"candidates"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:["The key for the row to update (",(0,i.jsx)(n.code,{children:"candidateKey"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:["An object with the column names to update and the new value for the respective columns.\nIn this case, the ",(0,i.jsx)(n.code,{children:"vote"})," function only updates the ",(0,i.jsx)(n.code,{children:"votes"})," column.\nThe new value is the current number of votes that was obtained from ",(0,i.jsx)(n.code,{children:"with-read"})," and stored in the ",(0,i.jsx)(n.code,{children:"numberOfVotes"})," variable incremented by one (",(0,i.jsx)(n.code,{children:"(+ numberOfVotes 1)"}),")."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-workshop/pact/voting.repl"})," file in the code editor."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Add transactions to load the ",(0,i.jsx)(n.code,{children:"election"})," Pact module and to add a candidate to the ",(0,i.jsx)(n.code,{children:"candidates"})," table:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(begin-tx "Load election module")\n  (load "election.pact")\n(commit-tx)\n\n(begin-tx "Add a candidate")\n  (use n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election)\n  (add-candidate { "key": "1", "name": "Candidate A" })\n(commit-tx)\n'})}),"\n",(0,i.jsx)(n.p,{children:"Remember to replace the namespace with your own principal namespace."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Add a transaction to test casting a vote for Candidate A by adding the following lines of code to the ",(0,i.jsx)(n.code,{children:"voting.repl"})," file:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(begin-tx "Voting for a candidate")\n  (use n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election)\n  (expect\n    "Candidate A has 0 votes"\n    0\n    (at "votes" (at 0 (list-candidates)))\n  )\n  (vote "1")\n  (expect\n    "Candidate A has 1 vote"\n    1\n    (at "votes" (at 0 (list-candidates)))\n  )\n(commit-tx)\n'})}),"\n",(0,i.jsx)(n.p,{children:"This code:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Verifies that the candidate is initialized with zero votes."}),"\n",(0,i.jsxs)(n.li,{children:["Calls the ",(0,i.jsx)(n.code,{children:"vote"})," function with the key value (",(0,i.jsx)(n.code,{children:"1"}),") of the candidate as the only argument."]}),"\n",(0,i.jsx)(n.li,{children:"Asserts that the candidate has one vote."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Execute the code in the ",(0,i.jsx)(n.code,{children:"voting.repl"})," file using the Pact command-line interpreter and the ",(0,i.jsx)(n.code,{children:"--trace"})," command-line option."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:"pact voting.repl --trace\n"})}),"\n",(0,i.jsx)(n.p,{children:"You should see the transaction succeeds with output similar to the following:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'...\nvoting.repl:11:0-11:35:Trace: "Begin Tx 4 Voting for a candidate"\nvoting.repl:12:5-12:62:Trace: Loaded imports from n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election\nvoting.repl:13:5-17:6:Trace: "Expect: success Candidate A has 0 votes"\nvoting.repl:18:5-18:15:Trace: "Write succeeded"\nvoting.repl:19:5-23:6:Trace: "Expect: success Candidate A has 1 vote"\nvoting.repl:24:3-24:14:Trace: "Commit Tx 4 Voting for a candidate"\nLoad successful\n'})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"test-voting-for-an-invalid-candidate",children:"Test voting for an invalid candidate"}),"\n",(0,i.jsxs)(n.p,{children:["To make the ",(0,i.jsx)(n.code,{children:"vote"})," function more robust, you should handle the scenario where the ",(0,i.jsx)(n.code,{children:"candidateKey"})," doesn't exist in the database."]}),"\n",(0,i.jsx)(n.p,{children:"To test casting a vote for a candidate that doesn't exist:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-workshop/pact/voting.repl"})," file in the code editor on your computer."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Add a new transaction to test that voting for a candidate the doesn't exist fails."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(begin-tx "Voting for a candidate that doesn\'t exist fails")\n  (use n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election)\n  (expect-failure\n    "Cannot vote for a non-existing candidate"\n    (vote "20")\n  )\n(commit-tx)\n'})}),"\n",(0,i.jsx)(n.p,{children:"Remember to replace the namespace with your own principal namespace."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Execute the code in the ",(0,i.jsx)(n.code,{children:"voting.repl"})," file using the Pact command-line interpreter and the ",(0,i.jsx)(n.code,{children:"--trace"})," command-line option."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:"pact voting.repl --trace\n"})}),"\n",(0,i.jsx)(n.p,{children:"You should see that the transaction succeeds with output similar to the following:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'...\nvoting.repl:26:3-26:63:Trace: "Begin Tx 5 Voting for a candidate that doesn\'t exist fails"\nvoting.repl:27:5-27:62:Trace: Loaded imports from n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election\nvoting.repl:28:5-31:6:Trace: "Expect failure: Success: Cannot vote for a non-existing candidate"\nvoting.repl:32:3-32:14:Trace: "Commit Tx 5 Voting for a candidate that doesn\'t exist fails"\nLoad successful\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The test returns the expected result\u2014failure\u2014because the call to ",(0,i.jsx)(n.code,{children:"with-read"})," fails for the ",(0,i.jsx)(n.code,{children:"candidateKey"})," value of ",(0,i.jsx)(n.code,{children:'"20"'}),".\nThe failure prevents the execution of the ",(0,i.jsx)(n.code,{children:"update"})," function."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"test-error-handling",children:"Test error handling"}),"\n",(0,i.jsxs)(n.p,{children:["In its current implementation, the ",(0,i.jsx)(n.code,{children:"vote"})," function doesn't provide any specific checks or error handling.\nAs you iterate and improve the ",(0,i.jsx)(n.code,{children:"vote"})," function to check for specific error conditions, you should return error messages with specific information about why the call to the function failed."]}),"\n",(0,i.jsxs)(n.p,{children:["In the previous example, the ",(0,i.jsx)(n.code,{children:"expect-failure"})," function didn't include an expected outcome message.\nIf you update the invalid candidate transaction to specify an expected error message and that message isn't returned by the ",(0,i.jsx)(n.code,{children:"vote"})," function, the transaction would fail."]}),"\n",(0,i.jsxs)(n.p,{children:["For example, you could modify the transaction to include ",(0,i.jsx)(n.code,{children:'"Candidate does not exist"'})," as the expected outcome like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(begin-tx "Voting for a non-existing candidate")\n   (use n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election)\n   (expect-failure\n      "Cannot vote for a non-existing candidate" ; Name of the test\n      "Candidate does not exist"                 ; Expected outcome message for the failure\n      (vote "X")                                 ; Function call to execute\n   )\n(commit-tx)\n'})}),"\n",(0,i.jsx)(n.p,{children:"This transaction would fail with output similar to the following:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"...\nvoting.repl:28:5-32:6:Trace: \"FAILURE: Cannot vote for a non-existing candidate: expected error message 'Candidate does not exist', got 'No value found in table n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election_candidates for key: X'\"\nvoting.repl:33:3-33:14:Trace: \"Commit Tx 5 Voting for a candidate that doesn't exist fails\"\nvoting.repl:28:5-32:6:FAILURE: Cannot vote for a non-existing candidate: expected error message 'Candidate does not exist', got 'No value found in table n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election_candidates for key: X'\nLoad failed\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Because the error message doesn't contain the expected output of ",(0,i.jsx)(n.code,{children:"Candidate does not exist"})," that you specified in the previous step, the ",(0,i.jsx)(n.code,{children:"with-read"})," function returns a default error message."]}),"\n",(0,i.jsxs)(n.p,{children:["If you want to provide a more specific error message, you can use the ",(0,i.jsx)(n.code,{children:"with-default-read"})," built-in function.\nThe ",(0,i.jsx)(n.code,{children:"with-default-read"})," function enables you to return a default object with default values or a specific error message if a specific condition is detected."]}),"\n",(0,i.jsxs)(n.p,{children:["To add a specific error message to the ",(0,i.jsx)(n.code,{children:"vote"})," function:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-workshop/pact/election.pact"})," file in your code editor."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Update the ",(0,i.jsx)(n.code,{children:"vote"})," function to use the ",(0,i.jsx)(n.code,{children:"with-default-read"})," function:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(defun vote (candidateKey:string)\n  (with-default-read candidates candidateKey\n    { "name": "", "votes": 0 }\n    { "name" := name, "votes" := numberOfVotes }\n    (enforce (> (length name) 0) "Candidate does not exist")\n    (update candidates candidateKey { "votes": (+ numberOfVotes 1) })\n  )\n)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["With this code, a successful read operation assigns the value of the ",(0,i.jsx)(n.code,{children:'"name"'})," column to a ",(0,i.jsx)(n.code,{children:"name"})," variable and the value of the ",(0,i.jsx)(n.code,{children:'"votes"'})," column to the ",(0,i.jsx)(n.code,{children:"numberOfVotes"})," variable.\nThe function also checks that the candidate ",(0,i.jsx)(n.code,{children:"name"})," associated with the ",(0,i.jsx)(n.code,{children:"candidateKey"})," is not an empty string, and returns a specific error if it is."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Execute the code in the ",(0,i.jsx)(n.code,{children:"voting.repl"})," file using the Pact command-line interpreter and the ",(0,i.jsx)(n.code,{children:"--trace"})," command-line option."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:"pact voting.repl --trace\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Because the error message you specified in the ",(0,i.jsx)(n.code,{children:"vote"})," function is returned, you should see that the transaction succeeds with output similar to the following:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'...\nvoting.repl:26:3-26:63:Trace: "Begin Tx 5 Voting for a candidate that doesn\'t exist fails"\nvoting.repl:27:5-27:62:Trace: Loaded imports from n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election\nvoting.repl:28:5-32:6:Trace: "Expect failure: Success: Cannot vote for a non-existing candidate"\nvoting.repl:33:3-33:14:Trace: "Commit Tx 5 Voting for a candidate that doesn\'t exist fails"\n'})}),"\n",(0,i.jsx)(n.p,{children:"If you add a transaction to call the vote function with an invalid candidate, the transaction fails with the expected error message."}),"\n",(0,i.jsxs)(n.p,{children:["For example, if you add this transaction to the ",(0,i.jsx)(n.code,{children:"voting.repl"})," file:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'(begin-tx "Voting for a candidate that doesn\'t exist fails")\n   (use n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election)\n   (vote "1a")\n(commit-tx)\n'})}),"\n",(0,i.jsx)(n.p,{children:"You would see that the transaction fails with the expected error message:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'voting.repl:35:3-35:63:Trace: "Begin Tx 6 Voting for a candidate that doesn\'t exist fails"\nvoting.repl:36:3-36:60:Trace: Loaded imports from n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election\nelection.pact:42:7: Candidate does not exist\n 42 |        (enforce (> (length name) 0) "Candidate does not exist")\n    |        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  at(n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election.vote.{DdbfNmuc8IcjjPjhqEltltjMr8sxvn_GcuPciJvLq3E} "1a"):voting.repl:37:5-37:16\n\nLoad failed\n'})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"prevent-double-votes",children:"Prevent double votes"}),"\n",(0,i.jsxs)(n.p,{children:["At this point, the ",(0,i.jsx)(n.code,{children:"election"})," module allows voting, but it doesn't yet restrict each Kadena account to only voting once.\nTo keep track of the accounts that have already voted, you can create a new ",(0,i.jsx)(n.code,{children:"votes"})," table that uses the account name for each voter as the key and the candidate key as the only column.\nIn addition to a check against this table, you'll also need to check the keyset used to sign each voting transaction."]}),"\n",(0,i.jsx)(n.h3,{id:"define-votes-schema-and-table",children:"Define votes schema and table"}),"\n",(0,i.jsx)(n.p,{children:"To define the database schema and table:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-workshop/pact/election.pact"})," file in your code editor."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Add the schema for the ",(0,i.jsx)(n.code,{children:"votes"})," database table inside of the ",(0,i.jsx)(n.code,{children:"election"})," module declaration after the definition of the ",(0,i.jsx)(n.code,{children:"candidates"})," schema and table with the following lines of code:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:"  (defschema votes-schema\n    candidateKey:string\n  )\n\n  (deftable votes:{votes-schema})\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Create the table outside of the election module by adding the following lines of code at the end of ",(0,i.jsx)(n.code,{children:"./pact/election.pact"}),", after the ",(0,i.jsx)(n.code,{children:"election"})," module definition and the ",(0,i.jsx)(n.code,{children:"init-candidates"})," code snippet:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(if (read-msg "init-votes")\n  [(create-table votes)]\n  []\n)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["With this code, the ",(0,i.jsx)(n.code,{children:"read-msg"})," function reads the ",(0,i.jsx)(n.code,{children:"init-votes"})," field from the transaction data.\nIf you set this field to ",(0,i.jsx)(n.code,{children:"true"})," in your module deployment transaction, the statement between the first square brackets is executed.\nThis statement creates the ",(0,i.jsx)(n.code,{children:"votes"})," table based on its schema definition inside the module when you load the module into the Pact REPL or upgrade the module on the blockchain."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-workshop/pact/setup.repl"})," file in your code editor."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Add ",(0,i.jsx)(n.code,{children:", 'init-votes: true"})," to the ",(0,i.jsx)(n.code,{children:"env-data"})," so that this data is loaded in the Pact REPL environment when you load the ",(0,i.jsx)(n.code,{children:"election"})," module and the ",(0,i.jsx)(n.code,{children:"votes"})," table is created:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(env-data\n   { "election-admin":\n       { "keys" : [ "d0aa32802596b8e31f7e35d1f4995524f11ed9c7683450b561e01fb3a36c18ae" ]\n       , "pred" : "keys-all"\n       }\n   , "init-candidates": true\n   , \'init-votes: true\n   }\n)\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Execute the code in the ",(0,i.jsx)(n.code,{children:"voting.repl"})," file using the Pact command-line interpreter and the ",(0,i.jsx)(n.code,{children:"--trace"})," command-line option."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:"pact voting.repl --trace\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You should see that the transaction succeeds with ",(0,i.jsx)(n.code,{children:"TableCreated"})," twice in the output similar to the following:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'...\nelection.pact:55:0-58:1:Trace: ["TableCreated"]\nelection.pact:59:0-62:1:Trace: ["TableCreated"]\n...\n'})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"test-the-votes-table",children:"Test the votes table"}),"\n",(0,i.jsx)(n.p,{children:"To test that an account can only vote once:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-workshop/pact/voting.repl"})," file in the code editor."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Add a transaction to assert that it is not possible to cast more than one vote:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(begin-tx "Double vote")\n  (use n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election)\n  (expect-failure\n    "Cannot vote more than once"\n    "Multiple voting not allowed"\n    (vote "1")\n  )\n(commit-tx)\n'})}),"\n",(0,i.jsx)(n.p,{children:"Remember to replace the namespace with your own principal namespace."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Execute the code in the ",(0,i.jsx)(n.code,{children:"voting.repl"})," file using the Pact command-line interpreter and the ",(0,i.jsx)(n.code,{children:"--trace"})," command-line option."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:"pact voting.repl --trace\n"})}),"\n",(0,i.jsx)(n.p,{children:"You should see that the transaction fails with output similar to the following:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'...\nvoting.repl:35:0-35:24:Trace: "Begin Tx 6 Double vote"\nvoting.repl:36:3-36:60:Trace: Loaded imports from n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election\nvoting.repl:37:3-41:4:Trace: "FAILURE: Multiple voting not allowed: expected failure, got result: "Write succeeded""\nvoting.repl:42:0-42:11:Trace: "Commit Tx 6 Double vote"\nvoting.repl:37:3-41:4:FAILURE: Multiple voting not allowed: expected failure, got result: "Write succeeded"\nLoad failed\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Because all transactions in the ",(0,i.jsx)(n.code,{children:"voting.repl"})," file are signed with the ",(0,i.jsx)(n.code,{children:"election-admin"})," signature defined in the ",(0,i.jsx)(n.code,{children:"setup.repl"})," file, your administrative account can cast more than one vote on any ",(0,i.jsx)(n.code,{children:"candidateKey"}),", making the election unfair."]}),"\n",(0,i.jsxs)(n.p,{children:["To fix this issue, you'll need to update the ",(0,i.jsx)(n.code,{children:"vote"})," function in the ",(0,i.jsx)(n.code,{children:"election"})," module."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-workshop/pact/election.pact"})," file in your code editor."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Update the ",(0,i.jsx)(n.code,{children:"vote"})," function to include the account name and prevent the same account from voting more than once:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(defun vote (account:string candidateKey:string)\n  (let ((double-vote (account-voted account)))\n    (enforce (= double-vote false) "Multiple voting not allowed"))\n\n  (with-default-read candidates candidateKey\n    { "name": "", "votes": 0 }\n    { "name" := name, "votes" := numberOfVotes }\n    (enforce (> (length name) 0) "Candidate does not exist")\n    (update candidates candidateKey { "votes": (+ numberOfVotes 1) })\n    (insert votes account { "candidateKey": candidateKey })\n  )\n)\n'})}),"\n",(0,i.jsx)(n.p,{children:"This code:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Adds the account of the voter as the first parameter of the ",(0,i.jsx)(n.code,{children:"vote"})," function."]}),"\n",(0,i.jsxs)(n.li,{children:["Stores the result from a new ",(0,i.jsx)(n.code,{children:"account-voted"})," function in the ",(0,i.jsx)(n.code,{children:"double-vote"})," variable and uses that value to prevent an account from voting more than once."]}),"\n",(0,i.jsxs)(n.li,{children:["Enforces that no row in the ",(0,i.jsx)(n.code,{children:"votes"})," table is keyed with the account name using the ",(0,i.jsx)(n.code,{children:"with-default-read"})," pattern that you used to prevent voting on a non-existent candidate."]}),"\n",(0,i.jsxs)(n.li,{children:["Inserts a new row into the ",(0,i.jsx)(n.code,{children:"votes"})," table with the account name as the key and the candidate key as the value for the ",(0,i.jsx)(n.code,{children:"candidateKey"})," column every time the ",(0,i.jsx)(n.code,{children:"vote"})," function is called."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Add the ",(0,i.jsx)(n.code,{children:"account-voted"})," function to check if an account has already voted:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(defun account-voted:bool (account:string)\n  (with-default-read votes account\n    { "candidateKey": "" }\n    { "candidateKey" := candidateKey }\n    (> (length candidateKey) 0)\n  )\n)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The frontend of the election application can then use the result from the ",(0,i.jsx)(n.code,{children:"account-voted"})," function to determine if ",(0,i.jsx)(n.strong,{children:"Vote Now"})," should be enabled."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-workshop/pact/voting.repl"})," file in the code editor on your computer."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Update all calls to the ",(0,i.jsx)(n.code,{children:"vote"})," function to pass your administrative account name as the first argument."]}),"\n",(0,i.jsxs)(n.p,{children:["For example, update the ",(0,i.jsx)(n.code,{children:"vote"})," function in the ",(0,i.jsx)(n.code,{children:"Double vote"})," transaction:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(begin-tx "Double vote")\n  (use n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election)\n  (expect-failure\n    "Cannot vote more than once"\n    "Multiple voting not allowed"\n    (vote "k:d0aa32802596b8e31f7e35d1f4995524f11ed9c7683450b561e01fb3a36c18ae" "1")\n  )\n(commit-tx)\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Execute the code in the ",(0,i.jsx)(n.code,{children:"voting.repl"})," file using the Pact command-line interpreter and the ",(0,i.jsx)(n.code,{children:"--trace"})," command-line option."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:"pact voting.repl --trace\n"})}),"\n",(0,i.jsx)(n.p,{children:"You should see that the transaction succeeds with output similar to the following:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'...\nvoting.repl:44:0-44:24:Trace: "Begin Tx 7 Double vote"\nvoting.repl:45:5-45:62:Trace: Loaded imports from n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election\nvoting.repl:46:5-50:6:Trace: "Expect failure: Success: Cannot vote more than once"\nvoting.repl:51:0-51:11:Trace: "Commit Tx 7 Double vote"\nLoad successful\n'})}),"\n",(0,i.jsxs)(n.p,{children:["With these changes, the same account can't call the ",(0,i.jsx)(n.code,{children:"vote"})," function more than once."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"prevent-voting-on-behalf-of-other-accounts",children:"Prevent voting on behalf of other accounts"}),"\n",(0,i.jsxs)(n.p,{children:["The current implementation of the ",(0,i.jsx)(n.code,{children:"vote"})," function allows the administrative account to vote on behalf of other accounts."]}),"\n",(0,i.jsx)(n.p,{children:"To demonstrate voting on behalf of another account:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-workshop/pact/setup.repl"})," file in the code editor on your computer."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Add a ",(0,i.jsx)(n.code,{children:"voter-keyset"})," to ",(0,i.jsx)(n.code,{children:"env-data"})," so that this data is loaded in the Pact REPL environment when you load the ",(0,i.jsx)(n.code,{children:"election"})," module:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:', "voter-keyset": { "keys": ["voter"], "pred": "keys-all" }\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Load the ",(0,i.jsx)(n.code,{children:"coin"})," module and the interfaces it implements with the following lines of code in the ",(0,i.jsx)(n.code,{children:"setup.repl"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(begin-tx "Set up coin")\n  (load "root/fungible-v2.pact")\n  (load "root/fungible-xchain-v1.pact")\n  (load "root/coin-v5.pact")\n\n  (create-table coin.coin-table)\n  (create-table coin.allocation-table)\n\n  (coin.create-account "voter" (read-keyset "voter-keyset"))\n  (coin.create-account "election-admin" (read-keyset "election-admin"))\n(commit-tx)\n'})}),"\n",(0,i.jsx)(n.p,{children:"This code:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Creates the ",(0,i.jsx)(n.code,{children:"coin.coin-table"})," and ",(0,i.jsx)(n.code,{children:"coin.allocation-table"})," required to create the ",(0,i.jsx)(n.code,{children:"voter"})," account."]}),"\n",(0,i.jsxs)(n.li,{children:["Creates the ",(0,i.jsx)(n.code,{children:"voter"})," account and your administrative account in the ",(0,i.jsx)(n.code,{children:"coin"})," module database."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["In this example, the ",(0,i.jsx)(n.code,{children:"election-admin"})," is the administrative account name and keyset defined in previous tutorials.\nRemember to replace this information with the administrative account name that you funded on one or more chains.\nFor single-key accounts, the default convention is a ",(0,i.jsx)(n.code,{children:"k:"})," prefix and public key."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-workshop/pact/voting.repl"})," file in the code editor."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Add a transaction at the end of the file to cast a vote on behalf of the ",(0,i.jsx)(n.code,{children:"voter"})," account signed by the ",(0,i.jsx)(n.code,{children:"election-admin"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(begin-tx "Vote on behalf of another account")\n  (use n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election)\n  (expect-failure\n    "Voting on behalf of another account should not be allowed"\n    "Keyset failure (keys-all): [voter...]"\n    (vote "voter" "1")\n  )\n(commit-tx)\n'})}),"\n",(0,i.jsx)(n.p,{children:"Remember to replace the namespace with your own principal namespace."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Execute the code in the ",(0,i.jsx)(n.code,{children:"voting.repl"})," file using the Pact command-line interpreter and the ",(0,i.jsx)(n.code,{children:"--trace"})," command-line option."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:"pact voting.repl --trace\n"})}),"\n",(0,i.jsx)(n.p,{children:"You should see that the transaction fails with output similar to the following:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'...\nvoting.repl:53:0-53:46:Trace: "Begin Tx 9 Vote on behalf of another account"\nvoting.repl:54:5-54:62:Trace: Loaded imports from n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election\nvoting.repl:55:5-59:6:Trace: "FAILURE: Keyset failure (keys-all): [voter]: expected failure, got result: "Write succeeded""\nvoting.repl:60:0-60:11:Trace: "Commit Tx 9 Vote on behalf of another account"\nvoting.repl:55:5-59:6:FAILURE: Keyset failure (keys-all): [voter]: expected failure, got result: "Write succeeded"\nLoad failed\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The test failed because the ",(0,i.jsx)(n.code,{children:"voter"})," account name doesn't exist in the ",(0,i.jsx)(n.code,{children:"votes"})," table keys and the candidate exists, so the number of votes for the candidate is incremented.\nYou need to make sure that the signer of the transaction owns the ",(0,i.jsx)(n.code,{children:"account"})," passed to the ",(0,i.jsx)(n.code,{children:"vote"})," function."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-workshop/pact/election.pact"})," file in the code editor."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Define the ",(0,i.jsx)(n.code,{children:"ACCOUNT-OWNER"})," capability to enforce the guard of the account passed to the ",(0,i.jsx)(n.code,{children:"vote"})," function:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(use coin [ details ])\n\n(defcap ACCOUNT-OWNER (account:string)\n    (enforce-guard (at "guard" (coin.details account)))\n)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This code imports the ",(0,i.jsx)(n.code,{children:"details"})," function from the ",(0,i.jsx)(n.code,{children:"coin"})," module, then uses the ",(0,i.jsx)(n.code,{children:"coin.details"})," function to get the guard for an account by account name.\nIn this case, ",(0,i.jsx)(n.code,{children:"voter-keyset"})," is the guard for the account.\nBy enforcing this guard, you can ensure that the keyset used to sign the ",(0,i.jsx)(n.code,{children:"vote"})," transaction belongs to the account name passed to the function.\nFor simplicity, the frontend code in the workshop assumes that account names always use the ",(0,i.jsx)(n.code,{children:"k:"})," prefix followed by a public key convention.\nFrontend code changes are required to differentiate between account names and public keys if you want to use arbitrary account names that don't follow this convention."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Apply the capability by wrapping the ",(0,i.jsx)(n.code,{children:"update"})," and ",(0,i.jsx)(n.code,{children:"insert"})," statements in the ",(0,i.jsx)(n.code,{children:"vote"})," function inside a ",(0,i.jsx)(n.code,{children:"with-capability"})," statement as follows:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(defun vote (account:string candidateKey:string)\n  (let ((double-vote (account-voted account)))\n    (enforce (= double-vote false) "Multiple voting not allowed"))\n\n  (with-default-read candidates candidateKey\n    { "name": "", "votes": 0 }\n    { "name" := name, "votes" := numberOfVotes }\n    (enforce (> (length name) 0) "Candidate does not exist")\n    (with-capability (ACCOUNT-OWNER account)\n      (update candidates candidateKey { "votes": (+ numberOfVotes 1) })\n      (insert votes account { "candidateKey": candidateKey })\n    )\n  )\n)\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Execute the code in the ",(0,i.jsx)(n.code,{children:"voting.repl"})," file using the Pact command-line interpreter and the ",(0,i.jsx)(n.code,{children:"--trace"})," command-line option."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:"pact voting.repl --trace\n"})}),"\n",(0,i.jsx)(n.p,{children:"You should see that the transaction succeeds with output similar to the following:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'voting.repl:53:0-53:46:Trace: "Begin Tx 9 Vote on behalf of another account"\nvoting.repl:54:5-54:62:Trace: Loaded imports from n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election\nvoting.repl:55:5-59:6:Trace: "Expect failure: Success: Voting on behalf of another account should not be allowed"\nvoting.repl:60:0-60:11:Trace: "Commit Tx 9 Vote on behalf of another account"\nLoad successful\n'})}),"\n",(0,i.jsx)(n.p,{children:"With these changes, the administrative account can't vote on behalf of another account."}),"\n",(0,i.jsx)(n.h3,{id:"verify-voting-on-ones-own-behalf",children:"Verify voting on one's own behalf"}),"\n",(0,i.jsx)(n.p,{children:"To verify that the voter account can vote on its own behalf:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-workshop/pact/voting.repl"})," file in the code editor."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Add a transaction to verify that the ",(0,i.jsx)(n.code,{children:"voter"})," account can vote on its own behalf, leading to an increase of the number of votes on ",(0,i.jsx)(n.code,{children:"Candidate A"})," to 2:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(env-sigs\n  [{ "key"  : "voter"\n   , "caps" : []\n  }]\n)\n\n(begin-tx "Vote as voter")\n  (use n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election)\n  (vote "voter" "1")\n  (expect\n    "Candidate A has 2 votes"\n    2\n    (at "votes" (at 0 (list-candidates)))\n  )\n(commit-tx)\n'})}),"\n",(0,i.jsx)(n.p,{children:"Remember to replace the namespace with your own principal namespace."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Execute the code in the ",(0,i.jsx)(n.code,{children:"voting.repl"})," file using the Pact command-line interpreter and the ",(0,i.jsx)(n.code,{children:"--trace"})," command-line option."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:"pact voting.repl -t\n"})}),"\n",(0,i.jsx)(n.p,{children:"You should see that the transaction succeeds with output similar to the following:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'...\nvoting.repl:68:2-68:28:Trace: "Begin Tx 10 Vote as voter"\nvoting.repl:69:4-69:61:Trace: Loaded imports from n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80.election\nvoting.repl:70:4-70:22:Trace: "Write succeeded"\nvoting.repl:71:4-75:5:Trace: "Expect: success Candidate A has 2 votes"\nvoting.repl:76:2-76:13:Trace: "Commit Tx 10 Vote as voter"\nLoad successful\n'})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Impressive!\nYou now have a simple smart contract with the basic functionality for conducting an election that allows Kadena account holders to vote on the candidate of their choice.\nWith these changes, you're ready to upgrade the ",(0,i.jsx)(n.code,{children:"election"})," module on the development network."]}),"\n",(0,i.jsx)(n.h2,{id:"update-the-deployed-module",children:"Update the deployed module"}),"\n",(0,i.jsxs)(n.p,{children:["Now that you've updated and tested your ",(0,i.jsx)(n.code,{children:"election"})," module using the Pact REPL, you can update the module deployed on the local development network."]}),"\n",(0,i.jsxs)(n.p,{children:["To update the ",(0,i.jsx)(n.code,{children:"election"})," module on the development network:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Verify the development network is currently running on your local computer."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open the ",(0,i.jsx)(n.code,{children:"election-module-devnet.ktpl"})," file, replace the ",(0,i.jsx)(n.code,{children:'"init-candidates": true'})," with ",(0,i.jsx)(n.code,{children:'"init-votes": true'})," and add the ",(0,i.jsx)(n.code,{children:'"upgrade": true'})," property to the transaction data, and save the file."]}),"\n",(0,i.jsx)(n.p,{children:"For example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'data:\n  election-admin:\n    keys: ["{{public-key}}"]\n    pred: "keys-all"\n  "init-votes": true\n  "upgrade": true\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Because you created in the ",(0,i.jsx)(n.code,{children:"candidates"})," table in the previous tutorial, you must remove the ",(0,i.jsx)(n.code,{children:'"init-candidates": true'})," property from the transaction data.\nYou must include ",(0,i.jsx)(n.code,{children:'"init-votes": true'})," in the transaction data to create the ",(0,i.jsx)(n.code,{children:"votes"})," table using the ",(0,i.jsx)(n.code,{children:"(create-table votes)"})," statement when you update the ",(0,i.jsx)(n.code,{children:"election"})," module.\nBecause you are redeploying your module on the same network and chain, you also must include ",(0,i.jsx)(n.code,{children:'"upgrade": true'})," in the transaction data."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Create a transaction that uses the ",(0,i.jsx)(n.code,{children:"election-module-devnet.ktpl"})," template by running the ",(0,i.jsx)(n.code,{children:"kadena tx add"})," command and following the prompts displayed."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Sign the transaction by running the ",(0,i.jsx)(n.code,{children:"kadena tx sign"})," command and following the prompts displayed."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Send the signed transaction to the blockchain by running the ",(0,i.jsx)(n.code,{children:"kadena tx send"})," command and following the prompts displayed."]}),"\n",(0,i.jsx)(n.p,{children:"You can verify the transaction results using the request key for the transaction.\nIf the transaction succeeded, you should see the TableCreated result in the transaction output."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Successful deployment on the development network",src:t(56249).A+"",width:"1750",height:"490"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"update-the-frontend",children:"Update the frontend"}),"\n",(0,i.jsxs)(n.p,{children:["As you learned in ",(0,i.jsx)(n.a,{href:"/resources/election-workshop/workshop-nominate",children:"Nominate candidates"}),", the election application frontend is written in TypeScript and uses repositories to exchange data with the backend.\nBy default, the frontend uses the in-memory implementations of the repositories.\nBy making changes to the implementation of the ",(0,i.jsx)(n.code,{children:"interface IVoteRepository"})," in the ",(0,i.jsx)(n.code,{children:"frontend/src/repositories/candidate/DevnetVoteRepository.ts"})," file, you can configure the frontend to use the ",(0,i.jsx)(n.code,{children:"devnet"})," backend instead of the ",(0,i.jsx)(n.code,{children:"in-memory"})," backend.\nAfter making these changes, you can use the frontend to cast votes on candidates listed in the ",(0,i.jsx)(n.code,{children:"candidates"})," table and managed by the ",(0,i.jsx)(n.code,{children:"election"})," module running on the development network."]}),"\n",(0,i.jsxs)(n.p,{children:["To update the frontend to use the ",(0,i.jsx)(n.code,{children:"election"})," module:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open ",(0,i.jsx)(n.code,{children:"election-workshop/frontend/src/repositories/candidate/DevnetVoteRepository.ts"})," in your code editor."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Update the values for the ",(0,i.jsx)(n.code,{children:"CHAIN_ID"})," and ",(0,i.jsx)(n.code,{children:"NAMESPACE"})," constants with the chain where you deployed the ",(0,i.jsx)(n.code,{children:"election"})," module and your own principal namespace."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"const NETWORK_ID = 'development';\nconst CHAIN_ID = '3';\nconst API_HOST = `http://localhost:8080/chainweb/0.0/${NETWORK_ID}/chain/${CHAIN_ID}/pact`;\nconst NAMESPACE = 'n_d5ff15d933b83c1ef691dce3dabacfdfeaeade80';\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Review the ",(0,i.jsx)(n.code,{children:"hasAccountVoted"})," function:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"const hasAccountVoted = async (account: string): Promise<boolean> => {\n  const transaction = Pact.builder\n    // @ts-ignore\n    .execution(Pact.modules[`${NAMESPACE}.election`]['account-voted'](account))\n    .setMeta({ chainId: CHAIN_ID })\n    .setNetworkId(NETWORK_ID)\n    .createTransaction();\n  const { result } = await client.dirtyRead(transaction);\n\n  if (result.status === 'success') {\n    return result.data.valueOf() as boolean;\n  } else {\n    console.log(result.error);\n    return false;\n  }\n};\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Remove the ",(0,i.jsx)(n.code,{children:"@ts-ignore"})," comment from the function and notice the resulting errors.\nTo fix the errors, you must generate types for your Pact module that can be picked up by ",(0,i.jsx)(n.code,{children:"@kadena/client"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open a terminal, change to the ",(0,i.jsx)(n.code,{children:"election-workshop/frontend"})," directory, then generate types for your ",(0,i.jsx)(n.code,{children:"election"})," module by running the following command:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm run pactjs:generate:contract:election\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This command uses the ",(0,i.jsx)(n.code,{children:"pactjs"})," library to generate the TypeScript definitions for the election contract and should clear the errors reported by the code editor.\nDepending on the code editor, you might need to close the project in the editor and reopen it to reload the code editor window with the change."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Review the ",(0,i.jsx)(n.code,{children:"vote"})," function, remove the ",(0,i.jsx)(n.code,{children:"@ts-ignore"})," comment, and save your changes to the ",(0,i.jsx)(n.code,{children:"DevnetVoteRepository.ts"})," file."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["In the terminal where ",(0,i.jsx)(n.code,{children:"election-workshop/frontend"})," is your current working directory, install the frontend dependencies by running the following command:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm install\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Start the frontend application configured to use the development network running locally by running the following command:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm run start-devnet\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"cast-a-vote",children:"Cast a vote"}),"\n",(0,i.jsxs)(n.p,{children:["Now that you have deployed the ",(0,i.jsx)(n.code,{children:"election"})," module on the development network and updated the frontend to use the ",(0,i.jsx)(n.code,{children:"election"})," module backend, you can use the election website to cast votes."]}),"\n",(0,i.jsx)(n.p,{children:"To cast a vote using the election website:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Verify the development network is currently running on your local computer."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Open and unlock the Chainweaver desktop application and verify that:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["You're connected to ",(0,i.jsx)(n.strong,{children:"development"})," network from the network list."]}),"\n",(0,i.jsxs)(n.li,{children:["Your administrative account name with the ",(0,i.jsx)(n.strong,{children:"k:"})," prefix exists on the chain where you've deployed the ",(0,i.jsx)(n.code,{children:"election"})," module."]}),"\n",(0,i.jsxs)(n.li,{children:["Your administrative account name has funds on the chain where you've deployed the ",(0,i.jsx)(n.code,{children:"election"})," module."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["For simplicity, the frontend uses the ",(0,i.jsx)(n.code,{children:"createSignWithChainweaver"})," method to sign the transaction that calls the ",(0,i.jsx)(n.code,{children:"vote"})," function.\nThe code for this call uses the default URL for the Chainweaver desktop application, 127.0.0.1:9467.\nTo sign the transaction with the key you generated for the administrative account using kadena-cli, you can add your account to Chainweaver or replace the call to the ",(0,i.jsx)(n.code,{children:"createSignWithChainweaver"})," method with ",(0,i.jsx)(n.code,{children:"createSignWithKeypair"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Open ",(0,i.jsx)(n.code,{children:"http://localhost:5173"})," in your browser, then click ",(0,i.jsx)(n.strong,{children:"Set Account"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Paste your administrative account, then click ",(0,i.jsx)(n.strong,{children:"Set"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"Add Candidate"})," to add candidates, if necessary."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Click ",(0,i.jsx)(n.strong,{children:"Vote Now"})," for a candidate row."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Sign the transaction, and wait for the transaction to finish."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Verify that the number of votes for the candidate you voted for increased by one vote."}),"\n",(0,i.jsxs)(n.p,{children:["After you vote, the Vote Now button is disabled because the frontend checks if your account has already voted by making a ",(0,i.jsx)(n.code,{children:"local"})," request to the ",(0,i.jsx)(n.code,{children:"account-voted"})," function of the ",(0,i.jsx)(n.code,{children:"election"})," Pact module."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"View the result after voting",src:t(54013).A+"",width:"2206",height:"790"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"next-steps",children:"Next steps"}),"\n",(0,i.jsx)(n.p,{children:"In this tutorial, you learned how to:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Organize test cases into separate REPL files."}),"\n",(0,i.jsxs)(n.li,{children:["Modify the ",(0,i.jsx)(n.code,{children:"vote"})," function iteratively using test cases and expected results."]}),"\n",(0,i.jsxs)(n.li,{children:["Use the ",(0,i.jsx)(n.code,{children:"with-default-read"})," function."]}),"\n",(0,i.jsxs)(n.li,{children:["Add a ",(0,i.jsx)(n.code,{children:"votes"})," database table to store the vote cast by each account holder."]}),"\n",(0,i.jsx)(n.li,{children:"Connect the voting functionality from the frontend to the development network as a backend."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["With this tutorial, you completed the functional requirements for the ",(0,i.jsx)(n.code,{children:"election"})," Pact module, deployed the module on your local development network, and interacted with the blockchain backend through the frontend of the election application website."]}),"\n",(0,i.jsx)(n.p,{children:"However, you might have noticed that your administrative account had to pay for gas to cast a vote."}),"\n",(0,i.jsxs)(n.p,{children:["To make the election accessible, account holders should be able to cast a vote without having to pay transaction fees.\nThe next tutorial demonstrates how to add a ",(0,i.jsx)(n.strong,{children:"gas station"})," module to the ",(0,i.jsx)(n.code,{children:"election"})," smart contract.\nWith this module, an election organization can act as the owner of an account that provides funds to pay the transaction fees on behalf of election voters.\nBy using a gas station, voters can cast votes without incurring any transaction fees."]}),"\n",(0,i.jsxs)(n.p,{children:["To see the code for the activity you completed in this tutorial and get the starter code for the next tutorial, check out the ",(0,i.jsx)(n.code,{children:"09-gas-station"})," branch from the ",(0,i.jsx)(n.code,{children:"election-workshop"})," repository by running the following command in your terminal shell:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"git checkout 09-gas-station\n"})})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},54013:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/election-after-voting-5885eb6df13db04a926b5f3bac59d8c6.jpg"},56249:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/votes-table-f66062f17c14d73d8f53bfcaadde67e9.jpg"},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>d});var o=t(96540);const i={},c=o.createContext(i);function a(e){const n=o.useContext(c);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),o.createElement(c.Provider,{value:n},e.children)}}}]);
"use strict";(self.webpackChunkkadena_docs=self.webpackChunkkadena_docs||[]).push([[3732],{68274:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"smart-contracts/best-practices","title":"Pact best practices","description":"Recommendations and reminders for patterns to avoid and practices to follow when writing programs using the Pact smart contract programming language.","source":"@site/docs/smart-contracts/best-practices.md","sourceDirName":"smart-contracts","slug":"/smart-contracts/best-practices","permalink":"/docs/smart-contracts/best-practices","draft":false,"unlisted":false,"editUrl":"https://github.com/kda-community/kadena-docs-new/blob/master/docs/smart-contracts/best-practices.md","tags":[],"version":"current","frontMatter":{"title":"Pact best practices","description":"Recommendations and reminders for patterns to avoid and practices to follow when writing programs using the Pact smart contract programming language.","id":"best-practices"},"sidebar":"default","previous":{"title":"Transaction format and flow","permalink":"/docs/smart-contracts/transactions"},"next":{"title":"How-to guides","permalink":"/docs/guides/"}}');var i=t(74848),s=t(28453);const o={title:"Pact best practices",description:"Recommendations and reminders for patterns to avoid and practices to follow when writing programs using the Pact smart contract programming language.",id:"best-practices"},r="Pact best practices",c={},l=[{value:"Common issues and mistakes",id:"common-issues-and-mistakes",level:2},{value:"Best practices",id:"best-practices",level:2},{value:"Basic auditing for Pact",id:"basic-auditing-for-pact",level:2},{value:"Enforcing access controls",id:"enforcing-access-controls",level:2},{value:"Governance",id:"governance",level:3},{value:"Basic capabilities",id:"basic-capabilities",level:3},{value:"Module references",id:"module-references",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"pact-best-practices",children:"Pact best practices"})}),"\n",(0,i.jsx)(n.p,{children:"As a programming language, Pact has some unique features that make it adaptable to writing sophisticated applications, but that are also flexible enough to allow coding mistakes that can make a contract vulnerable to potential misuse.\nThis topic summarizes common mistakes to avoid and best practices you should follow as you develop programs with Pact."}),"\n",(0,i.jsx)(n.h2,{id:"common-issues-and-mistakes",children:"Common issues and mistakes"}),"\n",(0,i.jsx)(n.p,{children:"The following list summarizes the most common difficulties that developers who are new to Pact encounter or are most likely to misinterpret."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Internal methods are often not guarded by capabilities, allowing any unprivileged user to modify contract state."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Capabilities are often granted in cross-module calls by accident, giving the target module more permissions than it should have in the calling module."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"How namespaces, accounts, and guards are used in Pact can be difficult to adjust to for developers familiar with other blockchain ecosystems or programming languages.\nFor example, Solidity developers are used to accounts being public keys and contracts having addresses, and often write smart contracts that only support single key (k:) accounts or deploy contracts insecurely in the free namespace."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Developers often forget to add types to their contracts, causing type errors that result in failed transactions later on."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Projects often split contract functionality into too many separate contracts\u2014even if they share the same governance\u2014complicating security and the overall design."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Contract operations that require user authorization use the ",(0,i.jsx)(n.code,{children:"enforce-guard"})," function to require a transaction signature without using a capability.\nIn Pact, capabilities enable users to scope their signature to specific actions\u2014explicitly signaling their consent\u2014so that they know exactly what operations they are authorizing with their signature.\nHowever, if you allow unscoped signatures by using ",(0,i.jsx)(n.code,{children:"enforce-guard"})," without putting it into the body of a capability code block, it's impossible for users for know what actions they are authorizing with their signature."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Developers often avoid defining managed capabilities because they seem complex or to introduce friction by requiring users to explicitly authorize the operation they are signing for.\nHowever, managed capabilities prevent transactions from replay operations that could allow funds to be drained from accounts or other operations could have unintended consequences.\nBy requiring a signature, capability guard, or user guard to authorize activity, you can safeguard users from transactions that perform unintended operation when executing contract functions."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Developers sometimes deploy contracts in the free or user namespace, fail to register a principal namespace, or accidentally deploy contracts in more than one namespace.\nIt's important to note, that functions are defined in module declarations, and modules are deployed in namespaces.\nA ",(0,i.jsx)(n.code,{children:"payment"})," function defined in the ",(0,i.jsx)(n.code,{children:"pistolas-retail"})," module that's deployed in the ",(0,i.jsx)(n.code,{children:"n_01234567"})," namespace is not the same as the ",(0,i.jsx)(n.code,{children:"payment"})," function defined in the ",(0,i.jsx)(n.code,{children:"pistolas-retail"})," module that's deployed in the ",(0,i.jsx)(n.code,{children:"n_890abcde"})," namespace.\nEven if the code is identical, the path to the function uniquely identifies each function."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"best-practices",children:"Best practices"}),"\n",(0,i.jsx)(n.p,{children:"The following list summarizes patterns, practices, and strategies for writing Pact code and delivering quality projects for the Kadena ecosystem."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Explicitly type all function parameters and results."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Use objects with schemas and use lists with the list item type resolved.\nFor example, use ",(0,i.jsx)(n.code,{children:"(a:object{mySchema})"})," and avoid ",(0,i.jsx)(n.code,{children:"(a:object)"}),".\nSimilarly, use ",(0,i.jsx)(n.code,{children:"(a:[integer])"})," instead of ",(0,i.jsx)(n.code,{children:"(a:list)"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Run the type checker over the code as you iterate on the implementation."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Create unit tests for every function that fully exercise error cases, especially cases of missing authorization to perform actions."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Be careful when using module references.\nIn particular, keep in mind that when you call into other modules, those modules will be granted the same set of capabilities as the code making the call into those modules."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Use the ",(0,i.jsx)(n.code,{children:"enforce"})," built-in functions to check for conditions that should terminate transaction execution immediately.\nThe ",(0,i.jsx)(n.code,{children:"enforce"})," functions ensure that if any invariants are violated, the transaction fails."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Use the ",(0,i.jsx)(n.a,{href:"/api/pact-api/local",children:(0,i.jsx)(n.code,{children:"/local"})})," endpoint when you want to query Pact state in tables or blockchain data."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.a,{href:"/smart-contracts/capabilities#events",children:"events"})," to send information about transaction results to off-chain software."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Only use ",(0,i.jsx)(n.a,{href:"/pact-5/database/select",children:(0,i.jsx)(n.code,{children:"select"})})," and ",(0,i.jsx)(n.a,{href:"/pact-5/database/keys",children:(0,i.jsx)(n.code,{children:"keys"})})," built-in functions in ",(0,i.jsx)(n.code,{children:"/local"})," queries."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Consider what data must be on chain and any data or operations that might be better suited to off-chain handling."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Plan for longevity and avoid defining functions that grow data structures\u2014like lists\u2014without bounds.\nIn general, gas usage per transaction should not go up over time as your code is used more."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Keep functions that share the same governance in the same module.\nIt\u2019s fine to create composable contracts with reusable utility functions.\nHowever, it\u2019s generally a better practice to keep the implementation of core functions in the same module unless the functions are governed by different parties."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Design and document the capabilities your contract requires and the conditions you'll use to enforce that only authorized users have access to privileged operations.\nRemember that capabilities can provide explicit and fine-grained access control to functions, but only if you enforce the conditions to guard them correctly.\nUpfront planning can help to ensure you define and grant capabilities precisely where they are needed to make your contract secure.\nBe sure you know how calling a capability by using the ",(0,i.jsx)(n.code,{children:"with-capability"})," function differs from calling a capability by using the ",(0,i.jsx)(n.code,{children:"require-capability"})," function."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Keep in mind that any code executed in the same transaction as the transaction that deploys a contract is granted full administrative privilege over the module, including the ability to update the module and edit module tables."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Create your own ",(0,i.jsx)(n.a,{href:"/guides/transactions/howto-namespace-tx",children:"principal namespace"})," before deploying contracts on the Kadena test or main production network."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["You should always use ",(0,i.jsx)(n.a,{href:"/smart-contracts/capabilities#managed-capabilities",children:"managed capabilities"})," to guard contract operations that require user authorization and that should only be executed once in a transaction.\nAll capabilities allow users to authorize specific actions.\nManaged capabilities allow contracts to keep track of how a capability that's been granted in a transaction can be used, either by setting a limit on a protected resource or by preventing the capability from being granted more than once in a transaction.\nFor functions involving assets transfers, you should use managed capabilities to prevent replay attacks within a transaction."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"basic-auditing-for-pact",children:"Basic auditing for Pact"}),"\n",(0,i.jsx)(n.p,{children:"If you're writing smart contracts that handle assets and transferring of ownership, you'll want to ensure that all of the functions involved in those activities are secure.\nFor example, you'll want to ensure that functions don't leak sensitive information like account keys or identifying information that should be kept private.\nYou'll also want to protect functions from unauthorized access and prevent functions from being appropriated and used to drain assets."}),"\n",(0,i.jsx)(n.p,{children:"As a first line of defense against unexpected or malicious behavior, you should review contract code with a few basic auditing principles in mind."}),"\n",(0,i.jsx)(n.p,{children:"In particular, you should pay close attention to the following in your code reviews:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Governance capability, keyset, and enforcement."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["All table ",(0,i.jsx)(n.code,{children:"insert"}),", ",(0,i.jsx)(n.code,{children:"update"}),", and ",(0,i.jsx)(n.code,{children:"write"})," operations."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["All capability definitions and use cases.\nBe sure that capabilities are named appropriately and are only brought into scope where they are needed.\nYou should also remove any capabilities you aren't using unless they are required by an ",(0,i.jsx)(n.code,{children:"interface"})," that you're implementing."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Managed capability use cases.\nFor example, you should verify that the ",(0,i.jsx)(n.code,{children:"@managed"})," keyword is used for capabilities that should only be allowed once in a transaction.\nIf a capability can be used more than once, you should verify that you have defined an appropriate resource and management function (",(0,i.jsx)(n.code,{children:"@managed amount TRANSFER-mgr"}),") and the code for the management function (",(0,i.jsx)(n.code,{children:"defun TRANSFER-mgr:decimal"}),")."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["All external module reference (",(0,i.jsx)(n.code,{children:"modref"}),") calls.\nFor example, you should be able to verify whether a capability looks for the correct guard stat's stored in a database table."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"All cases where you define, store, and enforce a guard or verifier application.\nFor example, you should be able to verify that a call to an external module doesn't grant any capability that's shouldn't be in scope for the call."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"All warning and error messages.\nFor example, you should verify that you check for valid input values and provide clear error messages for invalid values."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Any nested ",(0,i.jsx)(n.code,{children:"let"})," expressions and cascading ",(0,i.jsx)(n.code,{children:"if"})," statements.\nIn many cases, complex conditions can be difficult to fully comprehend and can result in the execution of unintended code blocks or code blocks that are never executed.\nWhere possible, you should replace complex conditions with concise and specific functions that are easier to evaluate and test."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["All ",(0,i.jsx)(n.code,{children:"defpact"})," steps."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"enforcing-access-controls",children:"Enforcing access controls"}),"\n",(0,i.jsxs)(n.p,{children:["As discussed in ",(0,i.jsx)(n.a,{href:"/smart-contracts/capabilities",children:"Capabilities"}),", basic and managed capabilities are critical components for controlling how permissions are granted to users of smart contracts.\nIn addition, most modules define a governance capability as the module owner.\nConceptually, capabilities aren't difficult to comprehend or implement.\nHowever, if they aren't used correctly, capabilities can make your contract vulnerable to unexpected behavior or to be exploited."]}),"\n",(0,i.jsx)(n.p,{children:"The following examples demonstrate patterns and outcomes for governance and basic capabilities."}),"\n",(0,i.jsx)(n.h3,{id:"governance",children:"Governance"}),"\n",(0,i.jsxs)(n.p,{children:["As discussed in ",(0,i.jsx)(n.a,{href:"/smart-contracts/modules",children:"Modules and references"}),", every Pact module has a keyset or capability that has full administrative ownership of the module.\nIn most cases, modules define a ",(0,i.jsx)(n.strong,{children:"governance capability"}),".\nThe governance capability for a module is different from other capabilities in two important ways:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"The governance capability for a module provides total control over the code defined in the module.\nWith this capability, the module owner can grant capabilities, access tables, modify module functions, and deploy upgraded module code on the blockchain."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"External code can attempt to take control of a module by acquiring the module's governance capability.\nUsually, capabilities can only be granted inside the module they are defined in."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["In example code for modules, the body of the governance capability is often set to ",(0,i.jsx)(n.code,{children:"true"})," for simplicity.\nFor example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:"(module payments GOV\n   (defcap GOV () true)\n   ...\n)\n"})}),"\n",(0,i.jsx)(n.p,{children:"If the code associated with a capability\u2014like GOV in this example\u2014is simply set to true, no conditions are being enforced to restrict access and the capability is always granted when requested.\nAny Pact code can take total control over the module."}),"\n",(0,i.jsx)(n.p,{children:"If you don't enforce any restrictions on the module administrative privileges, anyone can take control of the contract and modify its tables and functions.\nThis vulnerability might seem insignificant while you're testing in a development environment.\nHowever, it's important to plan for and implement access controls that prevent unauthorized use of functions that perform any type of sensitive or privileged operation."}),"\n",(0,i.jsxs)(n.p,{children:["The following examples demonstrate common patterns to avoid and follow to help you make contract operations more secure.\nYou can find more complex and complete examples in the ",(0,i.jsx)(n.code,{children:"coin"})," contract and in the ",(0,i.jsx)(n.code,{children:"marmalade"})," and ",(0,i.jsx)(n.code,{children:"spirekey"})," repositories."]}),"\n",(0,i.jsx)(n.p,{children:"As previously noted, the following pattern is often used in sample code for simplicity:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact-bad",children:'(namespace "free")     ; Public namespace used for testing only\n\n(module YODA0 GOV\n  (defcap GOV () true) ; Anyone can take over the governance of the module with this capability body\n  \n  (defun hello-world:string (input:string)\n    (format "Hello {}" [input]))\n)\n'})}),"\n",(0,i.jsx)(n.p,{children:"However, this pattern makes your contract vulnerable to hijacking with no protections in place to prevent unauthorized access.\nYou should only use this pattern in your local development environment and in the early stages of learning to write Pact code."}),"\n",(0,i.jsx)(n.p,{children:"Another common mistake is to read a keyset or message that doesn't enforce a signing key to grant a capability as illustrated in the following example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact-bad",children:'(namespace "n_d5ff15")\n\n(module YODA1 GOV\n  (defcap GOV () \n    (enforce-keyset (read-keyset "hello-world"))) ; You can put any value into hello-world\n  \n  (defun hello-world:string (input:string)\n    (format "Hello {}" [input]))\n)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["In this example, the ",(0,i.jsx)(n.code,{children:"read-keyset"}),' function reads whatever value is defined under the "hello-world" key in the environment data.\nThe ',(0,i.jsx)(n.code,{children:"read-keyset"}),' function doesn\'t verify that the value under the "hello-world" key represents a valid keyset object, valid values, or a keyset you control.\nIf someone else specifies a valid keyset in the environment data, that keyset would pass the governance check and take control of the module.']}),"\n",(0,i.jsxs)(n.p,{children:["The following example is similar except that it identifies a specific keyset name to enforce\u2014not just read\u2014and specifies that the keyset exists within the ",(0,i.jsx)(n.code,{children:"n_d5ff15"})," namespace:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(namespace "n_d5ff15")\n\n(module YODA2 GOV\n  (defcap GOV () \n    (enforce-keyset "n_d5ff15.hello-world")) ; You must create the keyset on-chain in the same transaction\n                                             ; used to deploy the module\n  (defun hello-world:string (input:string)\n    (format "Hello {}" [input]))\n)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This example uses the correct syntax, but the ",(0,i.jsx)(n.code,{children:"n_d5ff15.hello-world"})," keyset could be claimed by someone else if you don't create the keyset in the message payload for the transaction used to deploy the module."]}),"\n",(0,i.jsx)(n.p,{children:"The following example illustrates a more secure pattern that defines a keyset, then uses that keyset to control the administrative privileges for a module:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(namespace "n_d5ff15")\n\n(define-keyset "n_d5ff15.hello-world" (read-keyset \'ks))\n\n(module YODA3 GOV\n  (defcap GOV () \n    (enforce-guard (keyset_ref_guard "n_d5ff15.hello-world")) ; Correct usage for deploying a module \n  )\n  (defun hello-world:string (input:string)\n    (format "Hello {}" [input]))\n)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["In this example, you define a ",(0,i.jsx)(n.code,{children:"hello-world"})," keyset in the ",(0,i.jsx)(n.code,{children:"n_d5ff15"})," principal namespace and must include the ",(0,i.jsx)(n.code,{children:"ks"})," keyset definition in the environment data for testing in the Pact REPL or in the message payload for deployment."]}),"\n",(0,i.jsx)(n.h3,{id:"basic-capabilities",children:"Basic capabilities"}),"\n",(0,i.jsx)(n.p,{children:"The following example illustrates defining a second capability to control access to a specific function:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(namespace "n_d5ff15")\n\n(define-keyset "n_d5ff15.hello-world" (read-keyset \'ks))\n\n(module YODA4 GOV\n  (defcap GOV () \n     (enforce-guard (keyset_ref_guard "n_d5ff15.hello-world"))\n  ) \n  (defcap USER (account:string) \n    (enforce-guard (at \'guard (coin.details account)))) ; This condition requires an account to exist, but will  \n                                                        ; validate that the account guard matches the signer\n\n  (defun hello-world:string (input:string account:string)\n    (with-capability (USER account)\n    (format "Hello {}" [input])))\n)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["This example requires the ",(0,i.jsx)(n.code,{children:"coin"})," contract to be loaded and the specified account to exist on-chain.\nThe ",(0,i.jsx)(n.code,{children:"hello-world"})," function has also been modified to require an ",(0,i.jsx)(n.code,{children:"account"})," string as an argument.\nFor example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(n_d5ff15.YODA4.hello-world "Robot" "k:000ca7383b2267a0ffe768b97b96104d0fb82e576c53e35a6a44e0bb675c53ce")\n'})}),"\n",(0,i.jsxs)(n.p,{children:["With this pattern, the condition for the USER capability checks that the guard matches the specified account.\nIf the account exists and the condition evaluated is true, the account can run the ",(0,i.jsx)(n.code,{children:"hello-world"})," function.\nThe USER capability now enforces that only the specified account can run the ",(0,i.jsx)(n.code,{children:"hello-world"})," function."]}),"\n",(0,i.jsx)(n.p,{children:"The following example illustrates using a guard as input to acquire the capability to access a specific function:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(namespace "n_d5ff15")\n\n(define-keyset "n_d5ff15.hello-world" (read-keyset \'ks))\n\n(module YODA5 GOV\n  (defcap GOV () \n    (enforce-guard (keyset_ref_guard "n_d5ff15.hello-world"))\n  )\n  \n  (defcap USER (account:string guard:guard) \n    (enforce-guard guard)) ; This condition requires the guard to be provided as input to sign for the transaction\n\n  (defun hello-world:string (input:string account:string guard:guard)\n    (with-capability (USER account guard)\n    (format "Hello {}" [input])))\n)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["In this example, the ",(0,i.jsx)(n.code,{children:"hello-world"})," function has been modified to require an ",(0,i.jsx)(n.code,{children:"account"})," string and a ",(0,i.jsx)(n.code,{children:"guard"})," as arguments.\nIf the guard is a keyset, you can use the ",(0,i.jsx)(n.code,{children:"read-keyset"})," function and keyset name to input the keys and predicate for the account.\nFor example, if the guard is the keyset you defined using ",(0,i.jsx)(n.code,{children:"ks"})," as the keyset name, you could call the function with arguments similar to the following:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(n_d5ff15.YODA5.hello-world "Robot" "k:4fe7981d36997c2a327d0d3ce961d3ae0b2d38185ac5e5cd98ad90140bc284d0" (read-keyset \'ks)) \n"Hello Robot"\n'})}),"\n",(0,i.jsx)(n.p,{children:"The following example illustrates another common enforcement mistake;"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(namespace "n_d5ff15")\n(define-keyset "n_d5ff15.hello-world" (read-keyset \'ks))\n\n(module YODA6 GOV\n  (defcap GOV () \n    (enforce-guard (keyset_ref_guard "n_d5ff15.hello-world"))\n  )\n\n  (defcap USER (account:string) \n    (enforce (!= account "") "Specify an account")) ; Anyone can sign for this capability\n\n  (defun hello-world:string (input:string account:string)\n    (with-capability (USER account)\n    (format "Hello {}" [input])))\n)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["With this pattern, any string used for the ",(0,i.jsx)(n.code,{children:"account"})," argument passes the enforcement rule for the USER capability, enabling any user to acquire the capability and use the unprotected function.\nFor example, any value can be used with this function:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(n_d5ff15.YODA6.hello-world "Robot" "jae") \n"Hello Robot"\n'})}),"\n",(0,i.jsx)(n.p,{children:"The following example illustrates using a hard-coded account string instead of reading a keyset or guard from a table or the message payload:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(namespace "n_d5ff15")\n(define-keyset "n_d5ff15.ks" (read-keyset \'ks))\n\n(module YODA7 GOV\n  (defcap GOV () \n    (enforce-guard (keyset_ref_guard "n_d5ff15.ks"))\n  )\n  \n  (defcap USER (account:string) \n    (enforce (= account "k:4fe7981d36997c2a327d0d3ce961d3ae0b2d38185ac5e5cd98ad90140bc284d0") "Invalid account"))\n  \n  (defun hello-world:string (input:string account:string)\n    (with-capability (USER account)\n    (format "Hello {}" [input])))\n)\n'})}),"\n",(0,i.jsxs)(n.p,{children:["If the enforced ",(0,i.jsx)(n.code,{children:"account"})," string is used, the capability is acquired:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(n_d5ff15.YODA7.hello-world "Robot" "k:4fe7981d36997c2a327d0d3ce961d3ae0b2d38185ac5e5cd98ad90140bc284d0")\n"Hello Robot"\n'})}),"\n",(0,i.jsx)(n.p,{children:"If any other account or arbitrary string is used, the operation fails:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-pact",children:'(n_d5ff15.YODA7.hello-world "Robot" "k:9a23bf6a61f753d3ffa45c02b33c65b9dc80b8fb63857debcfe21fdb170fcd99")\nError: <interactive>:9:4: Invalid account\n'})}),"\n",(0,i.jsx)(n.h2,{id:"module-references",children:"Module references"}),"\n",(0,i.jsxs)(n.p,{children:["As discussed in ",(0,i.jsx)(n.a,{href:"/smart-contracts/modules",children:"Modules and interfaces"}),", writing external module reference calls can be an important approach for certain use cases.\nHowever, it's also important to prevent capabilities used to protect resources from being brought into scope when calling external modules, functions, or interfaces."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Do use module references when your project requires abstraction, for example, to call into an common interface that requires multiple implementations like tokens in a decentralized exchange."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Don't use module reference calls when your project has a capability that could be acquired outside of its intended scope."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Don't use module references when there's only one implementor of your interface. This just causes indirection for little reason"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["In general, you should scope capabilities that protect resources to ",(0,i.jsx)(n.code,{children:"coin.transfer"})," operations rather than use ",(0,i.jsx)(n.code,{children:"fungible::transfer"})," external references."]}),"\n",(0,i.jsxs)(n.p,{children:["As a security enhancement, Pact 5.3 introduces module reference calls that are ready-only by default.\nWith Pact 5.3, any module reference function call that reenters the originating module is treated as a read-only call to prevent database modification and code reentry attacks.\nFor more information about read-only module references, see ",(0,i.jsx)(n.a,{href:"/smart-contracts/modules#securing-module-reference-calls",children:"Securing module reference calls"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var a=t(96540);const i={},s=a.createContext(i);function o(e){const n=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);
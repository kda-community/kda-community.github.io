"use strict";(self.webpackChunkkadena_docs=self.webpackChunkkadena_docs||[]).push([[1332],{15414:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>r,contentTitle:()=>i,default:()=>l,frontMatter:()=>c,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"guides/nodes/manage-databases","title":"Manage node databases","description":"Because a blockchain continuously adds new transactions in new blocks that change the state of the database, it\'s important to monitor and manage the databases that store chain data and transactional history.","source":"@site/docs/guides/nodes/manage-databases.md","sourceDirName":"guides/nodes","slug":"/guides/nodes/manage-databases","permalink":"/docs/guides/nodes/manage-databases","draft":false,"unlisted":false,"editUrl":"https://github.com/kda-community/kadena-docs-new/blob/master/docs/guides/nodes/manage-databases.md","tags":[],"version":"current","frontMatter":{"title":"Manage node databases","id":"manage-databases"},"sidebar":"default","previous":{"title":"Monitor node status","permalink":"/docs/guides/nodes/monitor"},"next":{"title":"Get started with Chainweb EVM","permalink":"/docs/guides/nodes/evm-devnet"}}');var o=n(74848),s=n(28453);const c={title:"Manage node databases",id:"manage-databases"},i="Manage node databases",r={},d=[{value:"Back up databases",id:"back-up-databases",level:2},{value:"Compact node databases",id:"compact-node-databases",level:2}];function h(e){const a={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(a.header,{children:(0,o.jsx)(a.h1,{id:"manage-node-databases",children:"Manage node databases"})}),"\n",(0,o.jsx)(a.p,{children:"Because a blockchain continuously adds new transactions in new blocks that change the state of the database, it's important to monitor and manage the databases that store chain data and transactional history.\nFor example, as a node operator, you should plan for routine maintenance such as backing up or purging old data."}),"\n",(0,o.jsx)(a.p,{children:"The specific details of your maintenance plan\u2014such as how often you back up or compact node databases\u2014will depend on your specific use-case for the node.\nFor example, if you are running a node as an indexer and want access to full node history, you'll need to consider adding storage or compacting databases more often to reduce disk space requirements."}),"\n",(0,o.jsx)(a.h2,{id:"back-up-databases",children:"Back up databases"}),"\n",(0,o.jsx)(a.p,{children:"Chainweb nodes have two separate databases.\nOne database\u2014the RocksDB database\u2014stores information about blocks and chains.\nA second database\u2014the Pact Sqlite database\u2014stores information about smart contracts and state."}),"\n",(0,o.jsxs)(a.p,{children:["You can configure a Chainweb node to enable database backup operations by starting the node with the ",(0,o.jsx)(a.code,{children:"--enable-backup-api"})," and ",(0,o.jsx)(a.code,{children:"--backup-directory"})," command-line options.\nFor example:"]}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-bash",children:"./chainweb-node --enable-backup-api --backup-directory=/usr/share/cw-db-backups\n"})}),"\n",(0,o.jsx)(a.p,{children:"Alternatively, you can configure a node to enable database backup operations by specifying the following configuration settings in a node configuration file:"}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-yaml",children:"backup:\n  api:\n    enabled: true\n  directory: /usr/share/cw-db-backups\n"})}),"\n",(0,o.jsx)(a.p,{children:"If you enable database backups in a configuration file, you can then restart the node with the modified configuration file.\nFor example:"}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-bash",children:"./chainweb-node --config-file modified-config\n"})}),"\n",(0,o.jsxs)(a.p,{children:["After you enable the backup API for a node, you can use the ",(0,o.jsx)(a.code,{children:"/make-backup"})," endpoint to a start backup job and the ",(0,o.jsx)(a.code,{children:"/check-status"})," endpoint to check the status of a previously started backup job."]}),"\n",(0,o.jsxs)(a.p,{children:["You should note that when you call the ",(0,o.jsx)(a.code,{children:"/make-backup"})," endpoint, the backup job always backs up the RocksDB database.\nBacking up the Pact Sqlite database is optional.\nBacking up both databases takes significantly more time than only backing up the RocksDB database.\nIn addition, Pact database backups always require as much space as the active Pact database."]}),"\n",(0,o.jsxs)(a.p,{children:["For more information about starting backup jobs using the ",(0,o.jsx)(a.code,{children:"/make-backup"})," endpoint, see ",(0,o.jsx)(a.a,{href:"/api/service-api/make-db-backup",children:"Start a database backup job"}),".\nFor more information about checking the status of a database backup, see ",(0,o.jsx)(a.a,{href:"/api/service-api/check-db-backup",children:"Check the status of a database backup"}),"."]}),"\n",(0,o.jsx)(a.h2,{id:"compact-node-databases",children:"Compact node databases"}),"\n",(0,o.jsx)(a.p,{children:"Because a healthy blockchain continuously adds new transactions in new blocks that change the state of the database, managing the storage requirements on individual nodes can be challenging."}),"\n",(0,o.jsxs)(a.p,{children:["To address this storage issue, Chainweb provides the ",(0,o.jsx)(a.code,{children:"compact"})," command-line program.\nThe ",(0,o.jsx)(a.code,{children:"compact"})," program enables you to delete historical unused state from the ",(0,o.jsx)(a.code,{children:"chainweb-node"})," RocksDB database and the Pact SQLite database.\nRemoving old state that isn't required to validate transactions or reach consensus enables your node to use far less disk space overall while maintaining the semantic integrity of node operations."]}),"\n",(0,o.jsxs)(a.p,{children:["Note that, if possible, you should run the ",(0,o.jsx)(a.code,{children:"compact"})," program on a computer or instance with higher input/output operations per second (IOPs).\nFor nodes that run as virtual machines or instances on a cloud platform, you can typically configure this setting to optimize performance."]}),"\n",(0,o.jsx)(a.p,{children:"After you compact the state and restart the node to use the compacted database, you can delete the old database to further reduce your storage overhead or save the old database in another location as a backup."}),"\n",(0,o.jsx)(a.p,{children:"To reduce storage for Chainweb node databases:"}),"\n",(0,o.jsxs)(a.ol,{children:["\n",(0,o.jsxs)(a.li,{children:["\n",(0,o.jsxs)(a.p,{children:["Open a terminal shell on a computer with access to the ",(0,o.jsx)(a.code,{children:"chainweb-node"})," you manage."]}),"\n",(0,o.jsxs)(a.p,{children:["For example, if you run the node in a Docker container, open a terminal in the container.\nIf you installed ",(0,o.jsx)(a.code,{children:"chainweb-node"})," from a release binary or built it from source, open a terminal or secure shell on the computer where the binary is installed."]}),"\n"]}),"\n",(0,o.jsxs)(a.li,{children:["\n",(0,o.jsxs)(a.p,{children:["Verify that you have access to the ",(0,o.jsx)(a.code,{children:"compact"})," command-line program by running the following command:"]}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-bash",children:"compact --help\n"})}),"\n",(0,o.jsxs)(a.p,{children:["If you have access to the ",(0,o.jsx)(a.code,{children:"compact"})," program, you should see usage information similar to the following:"]}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-bash",children:"Usage: compact [--chainweb-version ARG] --from ARG --to ARG [--parallel]\n               --log-dir ARG\n\n  Pact DB Compaction Tool - create a compacted copy of the source database\n  directory Pact DB into the target directory.\n\nAvailable options:\n  --from ARG               Directory containing SQLite Pact state and RocksDB\n                           block data to compact, expected to be in\n                           $DIR/0/{sqlite,rocksDb}.\n  --to ARG                 Directory where to place the compacted Pact state and\n                           block data. It will place them in\n                           $DIR/0/{sqlite,rocksDb}, respectively.\n  --parallel               Turn on multi-threaded compaction. The threads are\n                           per-chain.\n  --log-dir ARG            Directory where compaction logs will be placed.\n  -h,--help                Show this help text\n"})}),"\n"]}),"\n",(0,o.jsxs)(a.li,{children:["\n",(0,o.jsxs)(a.p,{children:["Compact your ",(0,o.jsx)(a.code,{children:"rocksdb"})," and ",(0,o.jsx)(a.code,{children:"sqlite"})," databases by running the ",(0,o.jsx)(a.code,{children:"compact"})," command with the following arguments:"]}),"\n",(0,o.jsxs)(a.ul,{children:["\n",(0,o.jsxs)(a.li,{children:[(0,o.jsx)(a.code,{children:"--from"})," to specify the path to the database directory you want to compact. You should specify the database root directory that contains the ",(0,o.jsx)(a.code,{children:"0/sqlite"})," and ",(0,o.jsx)(a.code,{children:"0/rocksdb"})," subdirectories. For example, the ",(0,o.jsx)(a.code,{children:"data/state/chainweb/db"})," directory is the root directory for the ",(0,o.jsx)(a.code,{children:"data/state/chainweb/db/0/sqlite"})," directory and the ",(0,o.jsx)(a.code,{children:"data/state/chainweb/db/0/rocksdb"})," directory."]}),"\n",(0,o.jsxs)(a.li,{children:[(0,o.jsx)(a.code,{children:"--to"})," to specify the path to the compacted database. The compact program writes the compacted databases to the ",(0,o.jsx)(a.code,{children:"$DIR/0/sqlite"})," and ",(0,o.jsx)(a.code,{children:"$DIR/0/rocksdb"})," subdirectories within the directory you specify."]}),"\n",(0,o.jsxs)(a.li,{children:[(0,o.jsx)(a.code,{children:"--log-dir"})," to specify the directory where you want the ",(0,o.jsx)(a.code,{children:"compact"})," program to put the log files it creates, one for each chain. If the directory doesn\u2019t exist, the ",(0,o.jsx)(a.code,{children:"compact"})," program creates it. These logs can be useful for debugging if something goes wrong."]}),"\n",(0,o.jsxs)(a.li,{children:[(0,o.jsx)(a.code,{children:"--chainweb-version"})," to specify the network identifier for the node. This argument is optional if you're compacting a database for the ",(0,o.jsx)(a.code,{children:"mainnet01"})," network. If you're compacting a database for another network\u2014for example, the Kadena test network\u2014you must specify the network identifier. Valid values are \"",(0,o.jsx)(a.code,{children:"development"}),'", "',(0,o.jsx)(a.code,{children:"testnet04"}),'", and "',(0,o.jsx)(a.code,{children:"mainnet01"}),'".']}),"\n"]}),"\n",(0,o.jsx)(a.p,{children:"For example, if you are using the default location for the database directory and a node connected to the Kadena test network, run a command similar to the following:"}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-bash",children:"compact --from ~/.local/share/chainweb-node/testnet04 --to ~/.local/share/chainweb-node/compact-db --log-dir /tmp/compaction-log-files --chainweb-version testnet04\n"})}),"\n",(0,o.jsxs)(a.p,{children:["Note that the location of the Chainweb root database directory\u2014",(0,o.jsx)(a.code,{children:"~/.local/share/chainweb-node/testnet04"})," in this example\u2014depends on the configuration of the node.\nIf you haven't specified a location in the configuration file, the default location is ",(0,o.jsx)(a.code,{children:"~/.local/share/chainweb-node/{chainweb-network-id}"}),", for example ",(0,o.jsx)(a.code,{children:"~/.local/share/chainweb-node/testnet04"})," for a node in the Kadena test network."]}),"\n",(0,o.jsxs)(a.p,{children:["If your node isn't synchronized with the current block height of the network or doesn't have enough history to ensure proper validation, you might see the ",(0,o.jsx)(a.code,{children:"compact"})," operation fail with any error similar to the following:"]}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-bash",children:"2024-08-09T20:03:38.215Z [Error] [] locateLatestSafeTarget: Not enough history to safely compact. Aborting.\n"})}),"\n",(0,o.jsx)(a.p,{children:"If you have enough history for compaction to succeed, you should see a message in the terminal similar to the following:"}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-text",children:"2024-08-13T18:11:30.991Z [Debug] [] Latest Common BlockHeight: 4115162\n2024-08-13T18:11:30.991Z [Debug] [] Earliest Common BlockHeight: 332604\n2024-08-13T18:11:31.438Z [Debug] [] Compaction target blockheight is: 4114162\n2024-08-13T18:11:31.438Z [Debug] [] targetBlockHeight: 4114162\n"})}),"\n",(0,o.jsxs)(a.p,{children:["All other messages are recorded in the log files in the directory you specified for the ",(0,o.jsx)(a.code,{children:"--log-dir"})," command-line argument."]}),"\n"]}),"\n",(0,o.jsxs)(a.li,{children:["\n",(0,o.jsx)(a.p,{children:"Stop your node."}),"\n"]}),"\n",(0,o.jsxs)(a.li,{children:["\n",(0,o.jsx)(a.p,{children:"Restart your node with the new compacted database directory."}),"\n",(0,o.jsx)(a.p,{children:"You can specify the new compacted database directory as a command-line option or edit the node configuration file you use to set the new compacted database directory."}),"\n",(0,o.jsx)(a.p,{children:"For example, you can restart the node with a command similar to the following:"}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-bash",children:"chainweb-node --database-directory=~/.local/share/chainweb-node/compact-db\n"})}),"\n",(0,o.jsxs)(a.p,{children:["If you're editing the configuration file, update the YAML or JSON file to set the ",(0,o.jsx)(a.code,{children:"databaseDirectory"})," field to the location of the compacted database.\nFor example:"]}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-yaml",children:"chainweb:\n  allowReadsInLocal: false\n  backup:\n    api:\n      configuration: {}\n      enabled: false\n    directory: null\n  databaseDirectory: ~/.local/share/chainweb-node/compact-db\n"})}),"\n",(0,o.jsx)(a.p,{children:"After you restart the node, it should run normally with the reduced database size as though nothing has changed.\nYou can delete the old database files or keep them locally or in another location as a backup."}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(a.p,{children:["If you encounter errors or warnings, open a new issue for ",(0,o.jsx)(a.a,{href:"https://github.com/kadena-io/chainweb-node#issues",children:"chainweb-node"})," or contact Kadena developers in the ",(0,o.jsx)(a.a,{href:"https://discord.com/channels/502858632178958377/1051827506279370802",children:"infrastructure"})," channel on the Kadena Discord server."]})]})}function l(e={}){const{wrapper:a}={...(0,s.R)(),...e.components};return a?(0,o.jsx)(a,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},28453:(e,a,n)=>{n.d(a,{R:()=>c,x:()=>i});var t=n(96540);const o={},s=t.createContext(o);function c(e){const a=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function i(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:c(e.components),t.createElement(s.Provider,{value:a},e.children)}}}]);
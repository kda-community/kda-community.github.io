"use strict";(self.webpackChunkkadena_docs=self.webpackChunkkadena_docs||[]).push([[5077],{24426:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>r,contentTitle:()=>c,default:()=>l,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"guides/nodes/evm-foundry-dev","title":"Developing for Chainweb EVM with Foundry","description":"Develop smart contract applications using the Foundry toolchain to run on multiple Chainweb EVM-compatible chains.","source":"@site/docs/guides/nodes/evm-foundry-dev.md","sourceDirName":"guides/nodes","slug":"/guides/nodes/evm-foundry-dev","permalink":"/docs/guides/nodes/evm-foundry-dev","draft":false,"unlisted":false,"editUrl":"https://github.com/kda-community/kadena-docs-new/blob/master/docs/guides/nodes/evm-foundry-dev.md","tags":[{"inline":true,"label":"evm","permalink":"/docs/tags/evm"},{"inline":true,"label":"foundry","permalink":"/docs/tags/foundry"},{"inline":true,"label":"Solidity","permalink":"/docs/tags/solidity"},{"inline":true,"label":"chainweb","permalink":"/docs/tags/chainweb"},{"inline":true,"label":"network","permalink":"/docs/tags/network"},{"inline":true,"label":"node operator","permalink":"/docs/tags/node-operator"}],"version":"current","sidebarPosition":2,"frontMatter":{"title":"Developing for Chainweb EVM with Foundry","description":"Develop smart contract applications using the Foundry toolchain to run on multiple Chainweb EVM-compatible chains.","id":"evm-foundry-dev","sidebar_position":2,"tags":["evm","foundry","Solidity","chainweb","network","node operator"]}}');var s=i(74848),o=i(28453);const a={title:"Developing for Chainweb EVM with Foundry",description:"Develop smart contract applications using the Foundry toolchain to run on multiple Chainweb EVM-compatible chains.",id:"evm-foundry-dev",sidebar_position:2,tags:["evm","foundry","Solidity","chainweb","network","node operator"]},c="Chainweb EVM Foundry integration",r={},d=[{value:"Before you begin",id:"before-you-begin",level:2},{value:"Quick start",id:"quick-start",level:2},{value:"Install foundry-chainweb",id:"install-foundry-chainweb",level:2},{value:"Configure environment settings",id:"configure-environment-settings",level:2},{value:"Add a custom setup function",id:"add-a-custom-setup-function",level:2},{value:"Add multi-chain tests",id:"add-multi-chain-tests",level:2},{value:"Input parameters",id:"input-parameters",level:3},{value:"Adding multi-chain tests",id:"adding-multi-chain-tests",level:3},{value:"Executing multi-chain tests",id:"executing-multi-chain-tests",level:3},{value:"Write multi-chain scripts",id:"write-multi-chain-scripts",level:2},{value:"Writing a multi-chain deployment script",id:"writing-a-multi-chain-deployment-script",level:3},{value:"Reading configuration settings",id:"reading-configuration-settings",level:3},{value:"Sample configuration and deployment",id:"sample-configuration-and-deployment",level:2},{value:"Verify multi-chain contracts",id:"verify-multi-chain-contracts",level:2},{value:"How nonces are maintained in multi-fork scenarios",id:"how-nonces-are-maintained-in-multi-fork-scenarios",level:2},{value:"forge test with msg.sender",id:"forge-test-with-msgsender",level:3},{value:"forge script with msg.sender",id:"forge-script-with-msgsender",level:3},{value:"Deterministic deployment",id:"deterministic-deployment",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"chainweb-evm-foundry-integration",children:"Chainweb EVM Foundry integration"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.a,{href:"https://github.com/kadena-io/foundry-chainweb",children:"foundry-chainweb"})," package provides utilities to help you use the Foundry smart contract development toolchain to develop, test, and deploy projects on the Kadena Chainweb EVM blockchain.\nThese utilities extend the Foundry toolchain to support the Kadena multi-chain network, where transactions can be processed by multiple, parallel, EVM-compatible chains."]}),"\n",(0,s.jsxs)(n.p,{children:["For information about installing the Foundry smart contract development toolchain and getting started with Solidity smart contract development, see the ",(0,s.jsx)(n.a,{href:"https://getfoundry.sh/introduction/overview",children:"Foundry"})," documentation."]}),"\n",(0,s.jsx)(n.h2,{id:"before-you-begin",children:"Before you begin"}),"\n",(0,s.jsx)(n.p,{children:"Verify that your development environment meets the following basic requirements:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["You have the Foundry toolchain\u2014with the ",(0,s.jsx)(n.code,{children:"forge"}),", ",(0,s.jsx)(n.code,{children:"cast"}),", ",(0,s.jsx)(n.code,{children:"anvil"}),", and ",(0,s.jsx)(n.code,{children:"chisel"})," binaries\u2014installed locally or running in a Docker container."]}),"\n",(0,s.jsx)(n.li,{children:"You have Git installed for managing your project."}),"\n",(0,s.jsxs)(n.li,{children:["You have cloned the ",(0,s.jsx)(n.a,{href:"https://github.com/kadena-io/kadena-evm-sandbox",children:"kadena-evm-sandbox"})," so that you have access to public and private keys for test accounts with default allocations."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["If you want to deploy projects on the Kadena Chainweb EVM test network, you must have an EVM-compatible wallet and the private key for an account holding testnet KDA funds.\nFor more information about deploying projects on the Chainweb EVM test network, see ",(0,s.jsx)(n.a,{href:"/guides/nodes/howto-evm",children:"Kadena Chainweb EVM deployment"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"quick-start",children:"Quick start"}),"\n",(0,s.jsxs)(n.p,{children:["If you have the Foundry toolchain installed, you can clone the ",(0,s.jsx)(n.a,{href:"https://github.com/kadena-io/foundry-chainweb",children:"foundry-chainweb"})," repository, navigate to the ",(0,s.jsx)(n.code,{children:"/examples/Counter"})," folder, and begin experimenting with building, testing, and running scripts without first creating and configuring your own project."]}),"\n",(0,s.jsxs)(n.p,{children:["To explore the sample ",(0,s.jsx)(n.code,{children:"Counter"})," project:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Clone the ",(0,s.jsx)(n.code,{children:"foundry-chainweb"})," repository:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"https://github.com/kadena-io/foundry-chainweb.git && cd foundry-chainweb\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Change to the ",(0,s.jsx)(n.code,{children:"examples/Counter"})," directory:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cd examples/Counter\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Build the sample ",(0,s.jsx)(n.code,{children:"Counter"})," project:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"forge build\n"})}),"\n",(0,s.jsx)(n.p,{children:"You should see that the sample project compiles successfully:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"[\u280a] Compiling...\n[\u2812] Compiling 1 files with Solc 0.8.30\n[\u2811] Solc 0.8.30 finished in 568.10ms\nCompiler run successful!\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Test the sample ",(0,s.jsx)(n.code,{children:"Counter"})," project:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"forge test\n"})}),"\n",(0,s.jsx)(n.p,{children:"You should see that the tests for the sample project are successful:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"[\u280a] Compiling...\nNo files changed, compilation skipped\n\nRan 2 tests for test/Counter.t.sol:CounterTest\n[PASS] test_IncrementMultiChain() (gas: 433714)\n[PASS] test_SetNumberMultiChain() (gas: 430552)\nSuite result: ok. 2 passed; 0 failed; 0 skipped; finished in 1.72s (4.07ms CPU time)\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Review the sample project configuration files and contracts for an overview of changes before configuring your own projects:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"foundry-chainweb/examples/Counter/chainweb.config.json"}),"\n",(0,s.jsx)(n.li,{children:"foundry-chainweb//examples/Counter/foundry.toml"}),"\n",(0,s.jsx)(n.li,{children:"foundry-chainweb/examples/Counter/script/Counter.s.sol"}),"\n",(0,s.jsx)(n.li,{children:"foundry-chainweb/examples/Counter/script/CounterCreate2.s.sol"}),"\n",(0,s.jsx)(n.li,{children:"foundry-chainweb/examples/Counter/src/Counter.sol"}),"\n",(0,s.jsx)(n.li,{children:"foundry-chainweb/examples/Counter/test/Counter.t.sol"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"install-foundry-chainweb",children:"Install foundry-chainweb"}),"\n",(0,s.jsx)(n.p,{children:"To configure your development environment to use Foundry with Chainweb EVM:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Create a new project directory with template files by running a command similar to the following:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"forge init myKadenaCounter && cd myKadenaCounter\n"})}),"\n",(0,s.jsx)(n.p,{children:"If you already have a Foundry project, navigate to the root directory for that project."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Install the ",(0,s.jsx)(n.code,{children:"foundry-chainweb"})," package by running the following command:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"forge install kadena-io/foundry-chainweb\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Create a ",(0,s.jsx)(n.code,{children:"remappings.txt"})," file in the root of your project."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Add the following to the ",(0,s.jsx)(n.code,{children:"remappings.txt"})," file to override the default dependency mapping:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"kadena-io/foundry-chainweb/=lib/foundry-chainweb/src/\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Open the ",(0,s.jsx)(n.code,{children:"foundry.toml"})," configuration file for your project and enable the Foreign Function Interface (FFI) support by setting the ",(0,s.jsx)(n.code,{children:"ffi"})," option to ",(0,s.jsx)(n.code,{children:"true"})," in your profile."]}),"\n",(0,s.jsx)(n.p,{children:"For example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:"[profile.default]\nffi = true\n"})}),"\n",(0,s.jsx)(n.p,{children:"The FFI feature allows Solidity tests and scripts to execute external commands or interact with the file system."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Enable ",(0,s.jsx)(n.code,{children:"read"})," access to the ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file by adding the ",(0,s.jsx)(n.code,{children:"fs_permissions"})," option to the ",(0,s.jsx)(n.code,{children:"foundry.toml"})," file:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:'fs_permissions = [{ access = "read", path = "./chainweb.config.json" }]\n'})}),"\n",(0,s.jsxs)(n.p,{children:["By default, projects have no file system permissions, and can't read or write to any file system files or directories.\nThe ",(0,s.jsx)(n.code,{children:"fs_permissions"})," option enables you to configure specific file system permissions for specific files or directories.\nIn this case, you're only allowing the project to read the ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file.\nYou'll use the ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file to configure the settings to use for different network environments."]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"configure-environment-settings",children:"Configure environment settings"}),"\n",(0,s.jsxs)(n.p,{children:["A sample ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," configuration file is installed by default in the ",(0,s.jsx)(n.code,{children:"lib/foundry-chainweb"})," directory when you add ",(0,s.jsx)(n.code,{children:"foundry-chainweb"})," to your project.\nYou can copy the sample  ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file to the root directory for your project or create a new ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file in the root directory."]}),"\n",(0,s.jsxs)(n.p,{children:["You can use the ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file to configure different Chainweb EVM network settings to deploy and run contracts on multiple Chainweb EVM chains.\nFor example, you can modify the configuration file to define the number of EVM-compatible chains and the chain identifiers to use for different target networks, including ",(0,s.jsx)(n.code,{children:"anvil"}),", a local Chainweb EVM node, the Chainweb EVM testnet, and Kadena mainnet."]}),"\n",(0,s.jsxs)(n.p,{children:["The following sample ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file configures three deployment targets, the ",(0,s.jsx)(n.code,{children:"anvil"})," target, the ",(0,s.jsx)(n.code,{children:"evm-local"})," target, and the ",(0,s.jsx)(n.code,{children:"evm-testnet"})," target, each with multiple EVM-compatible chains and with different Ethereum base chain identifiers:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "anvil": {\n    "numberOfChains": 3,\n    "chainwebChainIdOffset": 20,\n    "chainIdOffset": 62600\n  },\n  "evm-local": {\n        "numberOfChains": 2,\n        "chainwebChainIdOffset": 20,\n        "chainIdOffset": 1789,\n        "externalHostUrl": "http://localhost:1848/chainweb/0.0/evm-development"\n  },\n  "evm-testnet": {\n    "numberOfChains": 5,\n    "chainwebChainIdOffset": 20,\n    "chainIdOffset": 5920,\n    "externalHostUrl": "https://evm-testnet.chainweb.com/chainweb/0.0/evm-testnet"\n  }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["As you see in this example, you can set the following configuration parameters in the ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file:"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"numberOfChains"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"number"})}),(0,s.jsx)(n.td,{children:"Number of Chainweb EVM chains to initialize and fork in the target environment."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"chainwebChainIdOffset"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"number"})}),(0,s.jsx)(n.td,{children:"Index to start mapping Chainweb EVM chain identifiers to prevent collisions between Chainweb Pact and EVM chains. The Chainweb chain identifiers 0 through 19 are reserved for Pact chains."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"chainIdOffset"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"number"})}),(0,s.jsxs)(n.td,{children:["Base Ethereum chain identifier to use as the starting point for Chainweb EVM chain identifiers. For example, if you set the base ",(0,s.jsx)(n.code,{children:"chainIdOffset"})," to 1000, ",(0,s.jsx)(n.code,{children:"numberOfChains"})," to three, and the ",(0,s.jsx)(n.code,{children:"chainwebChainIdOffset"})," index to zero, the resulting chain identifiers would be 1000, 1001, and 1002."]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"externalHostUrl"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"string"})}),(0,s.jsx)(n.td,{children:"Base URL for external Chainweb network access."})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["You should note that the ",(0,s.jsx)(n.code,{children:"chainid"})," used in Chainweb EVM tests and scripts for Foundry projects is the blockchain network identifier and is computed using the ",(0,s.jsx)(n.code,{children:"chainIdOffset"})," defined in the project ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file.\nThis chain identifier is used as the base and incremented for each chain where a test or script runs."]}),"\n",(0,s.jsxs)(n.p,{children:["The Chainweb chain identifier\u2014for example, chains 20, 21, 22, 23, and 24 in the ",(0,s.jsx)(n.code,{children:"evm-testnet"})," configuration\u2014is computed using the ",(0,s.jsx)(n.code,{children:"chainwebChainIdOffset"})," defined in the project ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file as a base and incremented for each chain where a test or script runs."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Important"}),": The  ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," configuration file is only used when running scripts with ",(0,s.jsx)(n.code,{children:"ChainwebScript"}),".\nWhen running tests with ",(0,s.jsx)(n.code,{children:"ChainwebTest"}),", the configuration parameters are passed directly to the constructor and the configuration file is ignored."]}),"\n",(0,s.jsx)(n.p,{children:"After you configure the settings for different deployment targets, you are ready to update the tests and scripts for your project to run on multiple chains."}),"\n",(0,s.jsx)(n.h2,{id:"add-a-custom-setup-function",children:"Add a custom setup function"}),"\n",(0,s.jsxs)(n.p,{children:["To add custom setup logic to tests or scripts, you should use the optional ",(0,s.jsx)(n.code,{children:"userSetUp"})," method instead of the default Foundry ",(0,s.jsx)(n.code,{children:"setUp"})," method."]}),"\n",(0,s.jsx)(n.p,{children:"For example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'contract CounterTest is ChainwebTest(2, 0) {\n    function userSetUp() public override {\n        // Custom set up logic can be added here if needed\n        console.log("Setting up your test here");\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"add-multi-chain-tests",children:"Add multi-chain tests"}),"\n",(0,s.jsxs)(n.p,{children:["To write tests that run on Chainweb EVM and support the multi-chain network, you should import the ",(0,s.jsx)(n.code,{children:"ChainwebTest"})," contract that's defined in the ",(0,s.jsx)(n.code,{children:"lib/foundry-chainweb/src/Chainweb.sol"})," file instead of using the default Foundry ",(0,s.jsx)(n.code,{children:"Test"})," base contract."]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"ChainwebTest"})," code extends the Foundry ",(0,s.jsx)(n.code,{children:"Test"})," contract by adding a ",(0,s.jsx)(n.code,{children:"chainweb"})," property that provides two additional methods\u2014the ",(0,s.jsx)(n.code,{children:"getChainIds"})," and ",(0,s.jsx)(n.code,{children:"switchChain"})," methods\u2014to support the multi-chain network."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"chainweb.getChainIds"})," returns a list of available Chainweb chain identifiers."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"chainweb.switchChain"})," switches from the current active chain to a specified chain identifier in the Chainweb network."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["For more information about these methods and other functions defined in the ",(0,s.jsx)(n.code,{children:"Chainweb.sol"})," contract, see ",(0,s.jsx)(n.a,{href:"/reference/evm-integration/foundry-chainweb-ref",children:"Foundry Chainweb EVM - Chainweb.sol"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"input-parameters",children:"Input parameters"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"ChainwebTest"})," constructor takes the following parameters to set up multi-chain testing:"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"numberOfChains"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"uint24"})}),(0,s.jsx)(n.td,{children:"Number of chains to initialize and fork."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"chainwebChainIdOffset"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"uint24"})}),(0,s.jsx)(n.td,{children:"Index to start mapping Chainweb EVM chain identifiers to prevent collisions between Chainweb Pact and EVM chains."})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"adding-multi-chain-tests",children:"Adding multi-chain tests"}),"\n",(0,s.jsxs)(n.p,{children:["The following example demonstrates using ",(0,s.jsx)(n.code,{children:"ChainwebTest"})," with the ",(0,s.jsx)(n.code,{children:"switchChain"})," method to test the ",(0,s.jsx)(n.code,{children:"setNumber"})," and ",(0,s.jsx)(n.code,{children:"increment"})," functions from the ",(0,s.jsx)(n.code,{children:"Counter"})," contract on two chains:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-Solidity",children:'// SPDX-License-Identifier: UNLICENSED\npragma solidity ^0.8.13;\n\nimport {console} from "forge-std/Test.sol";\nimport {Counter} from "../src/Counter.sol";\nimport {ChainwebTest} from "kadena-io/foundry-chainweb/Chainweb.sol";\n\n// numberOfChains is 2 and chainwebChainIdOffset index is 0\ncontract CounterTest is ChainwebTest(2, 0) {\n    function test_SetNumberMultiChain() public {\n        uint256[] memory chainIds = chainweb.getChainIds();\n        console.log("Chains in the chainweb:", chainIds.length);\n        for (uint256 i = 0; i < chainIds.length; i++) {\n            console.log("i:", i);\n            chainweb.switchChain(chainIds[i]);\n            Counter counter = new Counter();\n            console.log("Running script on chain:", block.chainid);\n            console.log("Counter deployed at:", address(counter));\n            counter.setNumber(1);\n            assertEq(counter.number(), 1);\n        }\n    }\n\n    function test_IncrementMultiChain() public {\n        uint256[] memory chainIds = chainweb.getChainIds();\n        console.log("Chains in the chainweb:", chainIds.length);\n        for (uint256 i = 0; i < chainIds.length; i++) {\n            console.log("i:", i);\n            chainweb.switchChain(chainIds[i]);\n            Counter counter = new Counter();\n            console.log("Running script on chain:", block.chainid);\n            console.log("Counter deployed at:", address(counter));\n            counter.setNumber(1);\n            counter.increment();\n            assertEq(counter.number(), 2);\n        }\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"executing-multi-chain-tests",children:"Executing multi-chain tests"}),"\n",(0,s.jsxs)(n.p,{children:["You can execute the tests defined for your contract by running the ",(0,s.jsx)(n.code,{children:"forge test"})," command.\nFor example, you can run the following command to display test results with additional details about test execution:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"forge test -vv\n"})}),"\n",(0,s.jsx)(n.p,{children:"In this example, tests run on two chains and the offset index is zero.\nWith the level two logging option, the command displays information about the tests executed similar to the following:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"[\u280a] Compiling...\n[\u2812] Compiling 23 files with Solc 0.8.30\n[\u2811] Solc 0.8.30 finished in 519.96ms\nCompiler run successful!\n\nRan 2 tests for test/Counter.t.sol:CounterTest\n[PASS] test_IncrementMultiChain() (gas: 357127)\nLogs:\n  Setting up Chainweb for tests...\n  TEST: Setting main RPC node for 2 chains\n  Deploying chainId precompile for chainId: 0  at address: 0x9b02c3e2dF42533e0FD166798B5A616f59DBd2cc\n  Switching to chain: 0\n  Switched to chain: 0\n  Actually stored: 0\n  Deploying chainId precompile for chainId: 1  at address: 0x9b02c3e2dF42533e0FD166798B5A616f59DBd2cc\n  Switching to chain: 1\n  Switched to chain: 0\n  Actually stored: 1\n  Switching to chain: 0\n  Switched to chain: 0\n  Chains in the chainweb: 2\n  i: 0\n  Switching to chain: 0\n  Switched to chain: 0\n  Running script on chain: 31337\n  Counter deployed at: 0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f\n  i: 1\n  Switching to chain: 1\n  Switched to chain: 1\n  Running script on chain: 31338\n  Counter deployed at: 0x2e234DAe75C793f67A35089C9d99245E1C58470b\n\n[PASS] test_SetNumberMultiChain() (gas: 355387)\nLogs:\n  Setting up Chainweb for tests...\n  TEST: Setting main RPC node for 2 chains\n  Deploying chainId precompile for chainId: 0  at address: 0x9b02c3e2dF42533e0FD166798B5A616f59DBd2cc\n  Switching to chain: 0\n  Switched to chain: 0\n  Actually stored: 0\n  Deploying chainId precompile for chainId: 1  at address: 0x9b02c3e2dF42533e0FD166798B5A616f59DBd2cc\n  Switching to chain: 1\n  Switched to chain: 0\n  Actually stored: 1\n  Switching to chain: 0\n  Switched to chain: 0\n  Chains in the chainweb: 2\n  i: 0\n  Switching to chain: 0\n  Switched to chain: 0\n  Running script on chain: 31337\n  Counter deployed at: 0x5615dEB798BB3E4dFa0139dFa1b3D433Cc23b72f\n  i: 1\n  Switching to chain: 1\n  Switched to chain: 1\n  Running script on chain: 31338\n  Counter deployed at: 0x2e234DAe75C793f67A35089C9d99245E1C58470b\n\nSuite result: ok. 2 passed; 0 failed; 0 skipped; finished in 758.11ms (3.57ms CPU time)\n\nRan 1 test suite in 768.88ms (758.11ms CPU time): 2 tests passed, 0 failed, 0 skipped (2 total tests)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"write-multi-chain-scripts",children:"Write multi-chain scripts"}),"\n",(0,s.jsxs)(n.p,{children:["To write scripts that run on Chainweb EVM and support the multi-chain network, you should import the ",(0,s.jsx)(n.code,{children:"ChainwebScript"})," contract that's defined in the ",(0,s.jsx)(n.code,{children:"lib/foundry-chainweb/src/Chainweb.sol"})," file instead of using the default Foundry ",(0,s.jsx)(n.code,{children:"Script"})," contract.\nLike ",(0,s.jsx)(n.code,{children:"ChainwebTest"}),", the ",(0,s.jsx)(n.code,{children:"ChainwebScript"})," code extends the default Foundry ",(0,s.jsx)(n.code,{children:"Script"})," contract by adding a ",(0,s.jsx)(n.code,{children:"chainweb"})," property that provides two additional methods\u2014the ",(0,s.jsx)(n.code,{children:"getChainIds"})," and ",(0,s.jsx)(n.code,{children:"switchChain"})," methods\u2014to support the multi-chain network."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"chainweb.getChainIds"})," returns a list of available Chainweb chain identifiers."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"chainweb.switchChain"})," switches from the current active chain to a specified chain identifier in the Chainweb network."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["For more information about these methods and other functions defined in the ",(0,s.jsx)(n.code,{children:"Chainweb.sol"})," contract, see ",(0,s.jsx)(n.a,{href:"/reference/evm-integration/foundry-chainweb-ref",children:"Foundry Chainweb EVM - Chainweb.sol"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"writing-a-multi-chain-deployment-script",children:"Writing a multi-chain deployment script"}),"\n",(0,s.jsxs)(n.p,{children:["The following example demonstrates using ",(0,s.jsx)(n.code,{children:"ChainwebScript"})," with the ",(0,s.jsx)(n.code,{children:"getChainIds"})," and ",(0,s.jsx)(n.code,{children:"switchChain"})," methods to deploy the ",(0,s.jsx)(n.code,{children:"Counter"})," contract on multiple chains:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-Solidity",children:'// SPDX-License-Identifier: UNLICENSED\npragma solidity ^0.8.13;\n\nimport {Script, console} from "forge-std/Script.sol";\nimport {Counter} from "../src/Counter.sol";\nimport {ChainwebScript} from "kadena-io/foundry-chainweb/Chainweb.sol";\n\ncontract CounterScript is ChainwebScript {\n    function run() public {\n        uint256[] memory chainIds = chainweb.getChainIds();\n\n        // loop over chains and deploy the contract\n        for (uint256 i = 0; i < chainIds.length; i++) {\n            chainweb.switchChain(chainIds[i]);\n            uint256 activeChainId = chainweb.getActiveChainId();\n            console.log("Active Chainweb chain ID:", activeChainId);\n            require(activeChainId == chainIds[i], "Active Chainweb chain ID does not match expected chain ID");\n\n            vm.startBroadcast();\n            Counter counter1 = new Counter();\n            counter1.setNumber(1);\n            vm.stopBroadcast();\n        }\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"reading-configuration-settings",children:"Reading configuration settings"}),"\n",(0,s.jsxs)(n.p,{children:["The script automatically reads configuration settings from the ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file and uses the ",(0,s.jsx)(n.code,{children:"CHAINWEB"})," environment variable, if specified, to determine which configuration settings to apply.\nIf you don't specify the ",(0,s.jsx)(n.code,{children:"CHAINWEB"})," environment variable, the script uses the ",(0,s.jsx)(n.code,{children:"anvil"})," environment by default."]}),"\n",(0,s.jsxs)(n.p,{children:["For example, you can deploy the ",(0,s.jsx)(n.code,{children:"Counter"})," contract with the default configuration that uses the ",(0,s.jsx)(n.code,{children:"anvil"})," node environment and the private key for a test account by running the ",(0,s.jsx)(n.code,{children:"Counter.s.sol"})," script like this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"forge script --multi script/Counter.s.sol:CounterScript \\\n  --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 \\\n  --broadcast\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"[\u280a] Compiling...\n[\u2812] Compiling 1 files with Solc 0.8.30\n[\u2811] Solc 0.8.30 finished in 498.98ms\nCompiler run successful!\nWarning: Multi chain deployment is still under development. Use with caution.\nScript ran successfully.\nGas used: 554347\n\n== Logs ==\n  Setting up Chainweb for scripts...\n  SCRIPT: Setting main RPC node for 3 chains\n  Forking http://127.0.0.1:15686\n  Forking http://127.0.0.1:4667\n  Forking http://127.0.0.1:32834\n  Switching to chain: 20\n  Switched to chain: 20\n  Switching to chain: 20\n  Switched to chain: 20\n  Active Chainweb chain ID: 20\n  Switching to chain: 21\n  Switched to chain: 21\n  Active Chainweb chain ID: 21\n  Switching to chain: 22\n  Switched to chain: 22\n  Active Chainweb chain ID: 22\n\n## Setting up 3 EVMs.\n\n==========================\n\nChain 62602\n\nEstimated gas price: 2.000000001 gwei\n\nEstimated total gas used for script: 264211\n\nEstimated amount required: 0.000528422000264211 ETH\n\n==========================\n\n==========================\n\nChain 62600\n\nEstimated gas price: 2.000000001 gwei\n\nEstimated total gas used for script: 264211\n\nEstimated amount required: 0.000528422000264211 ETH\n\n==========================\n\n==========================\n\nChain 62601\n\nEstimated gas price: 2.000000001 gwei\n\nEstimated total gas used for script: 264211\n\nEstimated amount required: 0.000528422000264211 ETH\n\n==========================\n\n##### 62600\n\u2705  [Success] Hash: 0x69a7fe2ef2f94b3f712a3fe57029284079e9ecf9dd4a1b2902911675ba0710df\nContract Address: 0x5FbDB2315678afecb367f032d93F642f64180aa3\nBlock: 1\nPaid: 0.000156813000156813 ETH (156813 gas * 1.000000001 gwei)\n\n\n##### 62600\n\u2705  [Success] Hash: 0x3b6e4deed1bdae3daf55a9bf1fe618049ff6141479a37f0b43de0d9209b78ae1\nBlock: 2\nPaid: 0.000038291100884096 ETH (43696 gas * 0.876306776 gwei)\n\n\n##### 62601\n\u2705  [Success] Hash: 0xe42061b95d948bc6fe04ae2eed17f5adcb9814b78806d07e07baef9fff6f9284\nContract Address: 0x5FbDB2315678afecb367f032d93F642f64180aa3\nBlock: 1\nPaid: 0.000156813000156813 ETH (156813 gas * 1.000000001 gwei)\n\n\n##### 62601\n\u2705  [Success] Hash: 0xdad0643eb985923056c17fd1ca3ffca119557acf918692d4ffb0ef2d9fdbe6ec\nBlock: 2\nPaid: 0.000038291100884096 ETH (43696 gas * 0.876306776 gwei)\n\n\n##### 62602\n\u2705  [Success] Hash: 0xffadef8eaa3ba206e1878bb481691f121bd362b42509a4b6c30229b2c553c9cc\nContract Address: 0x5FbDB2315678afecb367f032d93F642f64180aa3\nBlock: 1\nPaid: 0.000156813000156813 ETH (156813 gas * 1.000000001 gwei)\n\n\n##### 62602\n\u2705  [Success] Hash: 0x688439a4a551a573a1ea706bc1bed424f879e5143f5672de2ea29a12863b1cfb\nBlock: 2\nPaid: 0.000038291100884096 ETH (43696 gas * 0.876306776 gwei)\n\n\u2705 Sequence #1 on 62600 | Total Paid: 0.000195104101040909 ETH (200509 gas * avg 0.938153388 gwei)\n\n\u2705 Sequence #2 on 62601 | Total Paid: 0.000195104101040909 ETH (200509 gas * avg 0.938153388 gwei)\n\n\u2705 Sequence #3 on 62602 | Total Paid: 0.000195104101040909 ETH (200509 gas * avg 0.938153388 gwei)\n                                                                                \n\n==========================\n\nONCHAIN EXECUTION COMPLETE & SUCCESSFUL.\n\nTransactions saved to: /Users/pistolas/myKadenaCounter/broadcast/multi/Counter.s.sol-latest/run.json\n\nSensitive details saved to: /Users/pistolas/myKadenaCounter/cache/multi/Counter.s.sol-latest/run.json\n"})}),"\n",(0,s.jsxs)(n.p,{children:["You can run the deployment script using the ",(0,s.jsx)(n.code,{children:"evm-local"})," configuration from the ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file as the target environment by running a command similar to the following:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"CHAINWEB=evm-local forge script --multi script/Counter.s.sol:CounterScript \\\n  --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 \\\n  --broadcast --legacy\n"})}),"\n",(0,s.jsx)(n.h2,{id:"sample-configuration-and-deployment",children:"Sample configuration and deployment"}),"\n",(0,s.jsxs)(n.p,{children:["The following sample ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file demonstrates the configuration settings for the default ",(0,s.jsx)(n.code,{children:"anvil"})," local environment, a custom ",(0,s.jsx)(n.code,{children:"evm-local"})," local development environment, and the Chainweb EVM ",(0,s.jsx)(n.code,{children:"evm-testnet"})," network."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "anvil": {\n        "numberOfChains": 3,\n        "chainwebChainIdOffset": 20,\n        "chainIdOffset": 62600\n    },\n    "evm-local": {\n        "numberOfChains": 2,\n        "chainwebChainIdOffset": 20,\n        "chainIdOffset": 1789,\n        "externalHostUrl": "http://localhost:1848/chainweb/0.0/evm-development"\n    },\n    "evm-testnet": {\n        "numberOfChains": 5,\n        "chainwebChainIdOffset": 20,\n        "chainIdOffset": 5920,\n        "externalHostUrl": "https://evm-testnet.chainweb.com/chainweb/0.0/evm-testnet"\n    }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["To deploy the Counter contract using the ",(0,s.jsx)(n.code,{children:"evm-local"})," configuration settings and the private key for one of the predefined development wallet accounts:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"CHAINWEB=evm-local forge script --multi script/Counter.s.sol:CounterScript \\\n  --private-key 0x67a8e3847c417e5c8989af0c161aea6a601bcd8f4f5fd7dbad89d7e74bf28dbc \\                  \n  --broadcast --legacy\n"})}),"\n",(0,s.jsx)(n.p,{children:"This deployment script deploys the contract on two Chainweb EVM chains with output similar to the following:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"[\u280a] Compiling...\nNo files changed, compilation skipped\nWarning: Multi chain deployment is still under development. Use with caution.\nScript ran successfully.\nGas used: 382845\n\n== Logs ==\n  Setting up Chainweb for scripts...\n  SCRIPT: Setting main RPC node for 2 chains\n  Using custom RPC URL: http://localhost:1848/chainweb/0.0/evm-development/chain/20/evm/rpc\n  Using custom RPC URL: http://localhost:1848/chainweb/0.0/evm-development/chain/21/evm/rpc\n  Switching to chain: 20\n  Switched to chain: 20\n  Switching to chain: 20\n  Switched to chain: 20\n  Active Chainweb chain ID: 20\n  Switching to chain: 21\n  Switched to chain: 21\n  Active Chainweb chain ID: 21\n\n## Setting up 2 EVMs.\n\n==========================\n\nChain 1790\n\nEstimated gas price: 1.000000007 gwei\n\nEstimated total gas used for script: 264211\n\nEstimated amount required: 0.000264211001849477 ETH\n\n==========================\n\n==========================\n\nChain 1789\n\nEstimated gas price: 1.000000007 gwei\n\nEstimated total gas used for script: 264211\n\nEstimated amount required: 0.000264211001849477 ETH\n\n==========================\n\n##### 1789\n\u2705  [Success] Hash: 0x81b13a99253bc4b0554675c9421d1e40ea4765a1f603e02fd3284cd7ebcf2292\nBlock: 3521\nPaid: 0.000043696000305872 ETH (43696 gas * 1.000000007 gwei)\n\n\n##### 1789\n\u2705  [Success] Hash: 0x9176eee2c9d556b9a575fe6de32c0636e982a4dc9b4d2e4e4c155714f3d6d60b\nContract Address: 0xfab4C60CF33e03d4F35c7d3E0aBF33e0e4E6E6d6\nBlock: 3521\nPaid: 0.000156813001097691 ETH (156813 gas * 1.000000007 gwei)\n\n\n##### 1790\n\u2705  [Success] Hash: 0x668a2be6866b89559f01e5b764b1fe1832b08ddba50d5c47cb282218a2c1ea58\nBlock: 3522\nPaid: 0.000043696000305872 ETH (43696 gas * 1.000000007 gwei)\n\n\n##### 1790\n\u2705  [Success] Hash: 0x2e6022c1189995acead47a1870c79562a86bc31bdb76563c3de4556687601f82\nContract Address: 0xfab4C60CF33e03d4F35c7d3E0aBF33e0e4E6E6d6\nBlock: 3522\nPaid: 0.000156813001097691 ETH (156813 gas * 1.000000007 gwei)\n\n\u2705 Sequence #1 on 1789 | Total Paid: 0.000200509001403563 ETH (200509 gas * avg 1.000000007 gwei)\n\n\u2705 Sequence #2 on 1790 | Total Paid: 0.000200509001403563 ETH (200509 gas * avg 1.000000007 gwei)\n                                                                                \n\n==========================\n\nONCHAIN EXECUTION COMPLETE & SUCCESSFUL.\n\nTransactions saved to: /Users/pistolas/myKadenaCounter/broadcast/multi/Counter.s.sol-latest/run.json\n\nSensitive details saved to: /Users/pistolas/myKadenaCounter/cache/multi/Counter.s.sol-latest/run.json\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In the sample output for deploying the contract on multiple chains, you'll notice that the Foundry chain identifiers are computed using the default value from the ",(0,s.jsx)(n.code,{children:"chainIdOffset"})," property in ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file as a base value and incremented for each Chainweb EVM chain.\nAs a result of the computation, Chainweb EVM chain 20 (index 0) maps to the base chain identifier 62600 for the ",(0,s.jsx)(n.code,{children:"anvil"})," network, ",(0,s.jsx)(n.code,{children:"1789"})," for the ",(0,s.jsx)(n.code,{children:"evm-local"})," network, or 5920 for the ",(0,s.jsx)(n.code,{children:"evm-testnet"})," network.\nIn this example with only two EVM chains, CChainweb EVM chain 20 (index 0) is mapped to the ",(0,s.jsx)(n.code,{children:"chainIdOffset"})," 1789 (base)and Chainweb EVM chain 21 (index 1) is incremented to the chain identifier 1790."]}),"\n",(0,s.jsxs)(n.p,{children:["You should note that Chainweb chain identifiers 0 through 19 are reserved for chains that support Pact, so Kadena public networks use the ",(0,s.jsx)(n.code,{children:"chainwebChainIdOffset"})," to set the starting point for Chainweb EVM chain identifiers.\nFor example, the Chainweb EVM testnet consists of five chains with the chain identifiers 20, 21, 22, 23, and 24.\nThis starting point value is configured in the ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file for each project and for each deployment target.\nIn the sample ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file, the ",(0,s.jsx)(n.code,{children:"anvil"})," deployment target is also configured to use 20 as the starting point for Chainweb EVM chain identifiers.\nHowever, if you spin up internal ",(0,s.jsx)(n.code,{children:"anvil"})," instances for testing, you'll see Chainweb chain identifiers starting with 0."]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"chainIdOffset"})," in the ",(0,s.jsx)(n.code,{children:"chainweb.config.json"})," file is the starting point for the ",(0,s.jsx)(n.strong,{children:"Ethereum network chain identifier"}),", similar to 1 for the Ethereum mainnet.\nFor Chainweb EVM testnet chains, the starting value for the Ethereum network chain identifier is 5920.\nThe network chain identifier for the Chainweb EVM testnet chain 20 is 5920.\nChainweb EVM testnet chain 21 has network chain identifier 5921, and so on."]}),"\n",(0,s.jsx)(n.h2,{id:"verify-multi-chain-contracts",children:"Verify multi-chain contracts"}),"\n",(0,s.jsxs)(n.p,{children:["You can verify contracts that run on Chainweb EVM by running the standard ",(0,s.jsx)(n.code,{children:"forge verify-contract"})," command.\nThe following example demonstrates verifying a contract like ",(0,s.jsx)(n.code,{children:"Counter.sol"})," that has no constructor arguments:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"forge verify-contract \\\n  --chain 5920 \\\n  --num-of-optimizations 200 \\\n  --watch \\\n  --verifier blockscout \\\n  --verifier-url https://chain-20.evm-testnet-blockscout.chainweb.com/api/ \\\n  --verifier-api-version v2 \\\n  --compiler-version v0.8.28 \\\n  0x3ee2edc5b2967093bf9b3058cf9803bee7595baf \\\n  src/Counter.sol:Counter\n"})}),"\n",(0,s.jsxs)(n.p,{children:["If your contract has constructor arguments, you can pass them using the ",(0,s.jsx)(n.code,{children:"--constructor-args"})," option.\nFor example:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'--constructor-args $(cast abi-encode "constructor(string,string,uint256,uint256)" "ForgeUSD" "FUSD" 18 1000000000000000000000)\n'})}),"\n",(0,s.jsxs)(n.p,{children:["You can run the following command to see all of the ",(0,s.jsx)(n.code,{children:"verify-contract"})," command-line options:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"forge verify-contract --help\n"})}),"\n",(0,s.jsxs)(n.p,{children:["For contracts that run on multiple Chainweb EVM chains, you must run the ",(0,s.jsx)(n.code,{children:"verify-contract"})," command on each chain.\nHowever, the ",(0,s.jsx)(n.code,{children:"verify-contract"})," command doesn't support verification if a contract with the same bytecode has been previously verified.\nIf you attempt to verify a contract with the same bytecode as a contract that has been previously verified, verification will fail with a message similar to the following:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"[address] is already verified. Skipping verification.\n"})}),"\n",(0,s.jsxs)(n.p,{children:["To test contract verification on multiple chains, you must change the bytecode, redeploy, then run the ",(0,s.jsx)(n.code,{children:"verify-contract"})," command on the redeployed contract."]}),"\n",(0,s.jsx)(n.p,{children:"You can change the bytecode by adding a constant at the top of the contract like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-solidity",children:"uint256 public constant DUMMY = 1;\n"})}),"\n",(0,s.jsx)(n.p,{children:"Increase the value used for the constant in each contract you deploy to verify contracts that are deployed on multiple chains.\nContract verification is not possible against anvil instances, because there is no block explorer for anvil."}),"\n",(0,s.jsx)(n.h2,{id:"how-nonces-are-maintained-in-multi-fork-scenarios",children:"How nonces are maintained in multi-fork scenarios"}),"\n",(0,s.jsxs)(n.p,{children:["The account you use when you execute tests with ",(0,s.jsx)(n.code,{children:"forge test"})," or run scripts with ",(0,s.jsx)(n.code,{children:"forge script"})," commands affects how the transaction nonce is maintained in different scenarios."]}),"\n",(0,s.jsx)(n.h3,{id:"forge-test-with-msgsender",children:"forge test with msg.sender"}),"\n",(0,s.jsxs)(n.p,{children:["Because the default ",(0,s.jsx)(n.code,{children:"msg.sender"})," account is a persisted account that's available across all forks, you can run ",(0,s.jsx)(n.code,{children:"forge test"})," using the default ",(0,s.jsx)(n.code,{children:"msg.sender"})," account to ensure transactions have a nonce that's maintained globally across all forks."]}),"\n",(0,s.jsxs)(n.p,{children:["If you want to test a contract using isolated nonces that are maintained separately for each fork, you can use the ",(0,s.jsx)(n.code,{children:"vm.startPrank"})," or ",(0,s.jsx)(n.code,{children:"vm.startBroadcast"})," function to set a specific account instead of using the default ",(0,s.jsx)(n.code,{children:"msg.sender"})," account.\nThe nonce for that account is then maintained per fork."]}),"\n",(0,s.jsx)(n.h3,{id:"forge-script-with-msgsender",children:"forge script with msg.sender"}),"\n",(0,s.jsxs)(n.p,{children:["Because the default ",(0,s.jsx)(n.code,{children:"msg.sender"})," account is a persisted account that's available across all forks, you can run ",(0,s.jsx)(n.code,{children:"forge script"})," using the default ",(0,s.jsx)(n.code,{children:"msg.sender"})," account to ensure transactions have a nonce that's maintained globally across all forks."]}),"\n",(0,s.jsxs)(n.p,{children:["If you specify the ",(0,s.jsx)(n.code,{children:"msg.sender"})," account by setting the ",(0,s.jsx)(n.code,{children:"--sender"})," or ",(0,s.jsx)(n.code,{children:"--private-key"})," command-line option, the nonce is maintained per fork."]}),"\n",(0,s.jsxs)(n.p,{children:["You can also use the ",(0,s.jsx)(n.code,{children:"vm.startBroadcast"})," function to explicitly set the sender for the next call.\nThe nonce for that sender is maintained per fork."]}),"\n",(0,s.jsx)(n.h2,{id:"deterministic-deployment",children:"Deterministic deployment"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"/examples/Counter"})," folder in the ",(0,s.jsx)(n.a,{href:"https://github.com/kadena-io/foundry-chainweb",children:"foundry-chainweb"})," repository includes a sample script that demonstrates how to deploy a contract that has the same address on every chain."]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"CounterCreate2.s.sol"})," script demonstrates deterministic deployment across all Chainweb EVM chains using the CREATE2 opcode.\nThe CREATE2 opcode ensures that the same contract is deployed using a predetermined address that is exactly the same on every chain, making cross-chain interactions predictable and easier to manage."]}),"\n",(0,s.jsx)(n.p,{children:"To simulate the deployment using the sample script:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Open a terminal shell on your computer."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Change to the ",(0,s.jsx)(n.code,{children:"examples/Counter"})," directory:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"cd examples/Counter\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Run a command similar to the following:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"forge script script/CounterCreate2.s.sol:CounterCreate2Script \\\n  --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In this example, the script uses the ",(0,s.jsx)(n.code,{children:"anvil"})," deployment target and simulates deployment on three chains."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"[\u280a] Compiling...\n[\u2811] Compiling 2 files with Solc 0.8.30\n[\u2818] Solc 0.8.30 finished in 604.25ms\nCompiler run successful!\nWarning: Multi chain deployment is still under development. Use with caution.\nScript ran successfully.\nGas used: 590474\n\n== Logs ==\n  Setting up Chainweb for scripts...\n  SCRIPT: Setting main RPC node for 3 chains\n  Forking http://127.0.0.1:7980\n  Forking http://127.0.0.1:3379\n  Forking http://127.0.0.1:13248\n  Switching to chain: 20\n  Switched to chain: 20\n  Counter will be deployed to address: 0xe6E97678A7A22143854b5fd5AD3352897Ae29d45\n  Using salt: 0x186cb6b14ba03f51eb142c757b395ea189ebb4c3a3357c14b361942227b305b2\n  ----------------------------------------\n  Switching to chain: 20\n  Switched to chain: 20\n  Deploying to chain: 20\n  Deployed Counter at: 0xe6E97678A7A22143854b5fd5AD3352897Ae29d45\n  Switching to chain: 21\n  Switched to chain: 21\n  Deploying to chain: 21\n  Deployed Counter at: 0xe6E97678A7A22143854b5fd5AD3352897Ae29d45\n  Switching to chain: 22\n  Switched to chain: 22\n  Deploying to chain: 22\n  Deployed Counter at: 0xe6E97678A7A22143854b5fd5AD3352897Ae29d45\n  ----------------------------------------\n  Deployment Summary:\n  All Counter contracts deployed to the SAME address: 0xe6E97678A7A22143854b5fd5AD3352897Ae29d45\n\n## Setting up 3 EVMs.\n\n==========================\n\nChain 62600\n\nEstimated gas price: 2.000000001 gwei\n\nEstimated total gas used for script: 217681\n\nEstimated amount required: 0.000435362000217681 ETH\n\n==========================\n\n==========================\n\nChain 62601\n\nEstimated gas price: 2.000000001 gwei\n\nEstimated total gas used for script: 217681\n\nEstimated amount required: 0.000435362000217681 ETH\n\n==========================\n\n==========================\n\nChain 62602\n\nEstimated gas price: 2.000000001 gwei\n\nEstimated total gas used for script: 217681\n\nEstimated amount required: 0.000435362000217681 ETH\n\n==========================\n\nSIMULATION COMPLETE. To broadcast these transactions, add --broadcast and wallet configuration(s) to the previous command. See forge script --help for more.\n\nTransactions saved to: /Users/pistolas/myKadenaCounter/broadcast/multi/dry-run/CounterCreate2.s.sol-latest/run.json\n\nSensitive details saved to: /Users/pistolas/myKadenaCounter/cache/multi/dry-run/CounterCreate2.s.sol-latest/run.json\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["To deploy the Counter contract using the sample deployment script, add the ",(0,s.jsx)(n.code,{children:"--broadcast"})," command-line option."]}),"\n",(0,s.jsx)(n.p,{children:"For example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"forge script script/CounterCreate2.s.sol:CounterCreate2Script \\\n  --private-key 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 \\\n  --broadcast\n"})}),"\n",(0,s.jsx)(n.p,{children:"The sample script demonstrates the following deployment steps:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Predicts the deployment address using the account salt and contract bytecode."}),"\n",(0,s.jsxs)(n.li,{children:["Deploys the ",(0,s.jsx)(n.code,{children:"Counter"})," contract to all configured Chainweb EVM chains."]}),"\n",(0,s.jsx)(n.li,{children:"Verifies that each deployment matches the predicted address."}),"\n",(0,s.jsx)(n.li,{children:"Displays a summary that shows all contracts were deployed to the same address."}),"\n"]}),"\n",(0,s.jsx)(n.h1,{id:"known-issues",children:"Known issues"}),"\n",(0,s.jsxs)(n.p,{children:["If you run the ",(0,s.jsx)(n.code,{children:"forge test"})," command with the ",(0,s.jsx)(n.code,{children:"--gas-report"})," command-line option in the root directory of the ",(0,s.jsx)(n.code,{children:"foundry-chainweb"})," repo, the ",(0,s.jsx)(n.code,{children:"test_Nonce"})," test case fails.\nThis failure occurs because Foundry does not isolate the forks with separate nonces when the ",(0,s.jsx)(n.code,{children:"--gas-report"})," option is used.\nThe nonces are global instead of per fork when you use the ",(0,s.jsx)(n.code,{children:"--gas-report"})," command-line option."]}),"\n",(0,s.jsxs)(n.p,{children:["In addition, the ",(0,s.jsx)(n.code,{children:"test_setupChainsForScript"})," test case might fail when running the ",(0,s.jsx)(n.code,{children:"forge test"})," command with the ",(0,s.jsx)(n.code,{children:"--gas-report"})," command-line option.\nThis failure occurs because the contract state on the forks is not isolated.\nFor example, when the chainId precompile is deployed, its state variable is set to 0 for the first chain.\nThe state variable is then set to 1 for the second chain.\nHowever, the state in the contract on the first chain fork is ",(0,s.jsx)(n.strong,{children:"overwritten"})," to 1 instead of writing that state to a separate fork.\nThe behavior can be observed by logging activity, but the root cause of the behavior isn't known at this time.\nYou can attempt to work around this behavior by using the ",(0,s.jsx)(n.code,{children:"vm.revokePersistent"})," cheat code in the ",(0,s.jsx)(n.code,{children:"deployChainWebChainIdContract"})," function to isolate contract addresses are when using the ",(0,s.jsx)(n.code,{children:"--gas-report"})," command-line option.\nHowever, the work around doesn't guarantee that the ",(0,s.jsx)(n.code,{children:"test_setupChainsForScript"})," test case will succeed in all cases."]})]})}function l(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>c});var t=i(96540);const s={},o=t.createContext(s);function a(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);